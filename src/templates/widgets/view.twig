{% extends "_layouts/cp" %}
{% import "_includes/forms" as forms %}

{% set title = widgetConfig.name %}
{% set fullPageForm = false %}
{% set selectedSubnavItem = 'widgets' %}
{% set isDefault = defaultWidgetHandle == widgetConfig.handle %}

{% set crumbs = [
    { label: searchHelper.fullName, url: url('search-manager') },
    { label: 'Widgets'|t('search-manager'), url: url('search-manager/widgets') },
    { label: widgetConfig.name }
] %}

{% block content %}
	<div class="pane">
		<h2>{{ 'Configuration'|t('search-manager') }}</h2>
		<p class="light">{{ 'This widget is defined in your config file and cannot be edited here.'|t('search-manager') }}</p>
		<pre style="background: #f3f7fc; padding: 14px; border-radius: 4px; overflow-x: auto; font-size: 12px;"><code>{{ widgetConfig.settings|json_encode(constant('JSON_PRETTY_PRINT') b-or constant('JSON_UNESCAPED_SLASHES')) }}</code></pre>
	</div>

	{% include 'lindemannrock-base/_components/plugin-credit' %}
{% endblock %}

{% block details %}
	{# Default toggle #}
	<div class="meta">
		{% if isDefaultFromConfig %}
			{# Default set via config file - show disabled switch #}
			{{ forms.lightswitchField({
				label: 'Default'|t('search-manager'),
				instructions: 'Set via config/search-manager.php. Edit the file to change.'|t('search-manager'),
				id: 'isDefault',
				on: isDefault,
				disabled: true
			}) }}
		{% elseif isDefault %}
			{# This is the default - show disabled switch with explanation #}
			{{ forms.lightswitchField({
				label: 'Default'|t('search-manager'),
				instructions: 'To change, set another widget as default first.'|t('search-manager'),
				id: 'isDefault',
				on: true,
				disabled: true
			}) }}
		{% else %}
			{# Not the default - allow setting as default via AJAX #}
			{{ forms.lightswitchField({
				label: 'Default'|t('search-manager'),
				instructions: 'Use as default when no widget handle is specified'|t('search-manager'),
				id: 'isDefault',
				on: false
			}) }}
		{% endif %}
	</div>

	{# Template Usage #}
	<fieldset>
		<legend class="h6">{{ 'Template Usage'|t('search-manager') }}</legend>
		<div class="meta">
			<div class="field">
				<dd class="value">
					<div style="background: #f3f7fc; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 11px; line-height: 1.4; overflow-x: auto;">
						<code style="display: block; white-space: pre; user-select: all;">{% verbatim %}{% include 'search-manager/_widget/search' with {
    config: '{% endverbatim %}{{ widgetConfig.handle }}{% verbatim %}',
} %}{% endverbatim %}</code>
					</div>
				</dd>
			</div>
		</div>
	</fieldset>

	{# Widget Preview #}
	{% include "search-manager/widgets/_partials/preview" with {
		widgetConfig: widgetConfig
	} %}

	{# Widget Info #}
	<fieldset>
		<dl class="meta read-only">
			<div class="data">
				<dt class="heading">{{ 'Status'|t('search-manager') }}</dt>
				<dd class="value">
					<span class="status {{ widgetConfig.enabled ? 'live' : 'disabled' }}"></span>
					<span>{{ widgetConfig.enabled ? 'Enabled'|t('search-manager') : 'Disabled'|t('search-manager') }}</span>
				</dd>
			</div>
			<div class="data">
				<dt class="heading">{{ 'Handle'|t('search-manager') }}</dt>
				<dd class="value"><code>{{ widgetConfig.handle }}</code></dd>
			</div>
			<div class="data">
				<dt class="heading">{{ 'Source'|t('search-manager') }}</dt>
				<dd class="value">{{ 'Config File'|t('search-manager') }}</dd>
			</div>
			{% if isDefault %}
				<div class="data">
					<dt class="heading">{{ 'Default'|t('search-manager') }}</dt>
					<dd class="value">{{ 'Yes'|t('search-manager') }}</dd>
				</div>
			{% endif %}
		</dl>
	</fieldset>
{% endblock %}

{% js %}
// Light/Dark preview toggle
(function() {
	const lightPreview = document.querySelector('.widget-preview-light');
	const darkPreview = document.querySelector('.widget-preview-dark');
	const toggleButtons = document.querySelectorAll('.widget-preview-toggle button');

	if (!lightPreview || !darkPreview || !toggleButtons.length) return;

	toggleButtons.forEach(function(btn) {
		btn.addEventListener('click', function() {
			const mode = this.getAttribute('data-preview-mode');

			// Update button states
			toggleButtons.forEach(function(b) {
				const isActive = b.getAttribute('data-preview-mode') === mode;
				b.setAttribute('aria-pressed', isActive ? 'true' : 'false');
				b.classList.toggle('secondary', isActive);
			});

			// Show/hide previews
			lightPreview.style.display = mode === 'light' ? 'block' : 'none';
			darkPreview.style.display = mode === 'dark' ? 'block' : 'none';
		});
	});
})();

// Default toggle via AJAX (for config widgets that are not already default)
{% if not isDefaultFromConfig and not isDefault %}
(function() {
	const $lightswitch = $('#isDefault').closest('.lightswitch');
	if (!$lightswitch.length) return;

	$lightswitch.on('change', function() {
		const isOn = $(this).hasClass('on');
		if (isOn) {
			Craft.sendActionRequest('POST', 'search-manager/widgets/set-default', {
				data: { configId: '{{ widgetConfig.handle }}' }
			}).then(function(response) {
				if (response.data.success) {
					Craft.cp.displayNotice(response.data.message || '{{ "Default widget updated"|t('search-manager') }}');
					setTimeout(() => window.location.reload(), 500);
				} else {
					Craft.cp.displayError(response.data.error);
					$lightswitch.data('lightswitch').turnOff();
				}
			}).catch(function(error) {
				Craft.cp.displayError('{{ "Failed to update default widget"|t('search-manager') }}');
				$lightswitch.data('lightswitch').turnOff();
			});
		}
	});
})();
{% endif %}
{% endjs %}
