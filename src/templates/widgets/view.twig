{% extends "_layouts/cp" %}
{% import "_includes/forms" as forms %}

{% set title = widgetConfig.name %}
{% set fullPageForm = false %}
{% set selectedSubnavItem = 'widgets' %}
{% set isDefault = defaultWidgetHandle == widgetConfig.handle %}

{% set crumbs = [
    { label: searchHelper.fullName, url: url('search-manager') },
    { label: 'Widgets'|t('search-manager'), url: url('search-manager/widgets') },
    { label: widgetConfig.name }
] %}

{% block content %}
	<div class="pane">
		<h2>{{ 'Configuration'|t('search-manager') }}</h2>
		<p class="light">{{ 'This widget is defined in your config file and cannot be edited here.'|t('search-manager') }}</p>
		<pre style="background: #f3f7fc; padding: 14px; border-radius: 4px; overflow-x: auto; font-size: 12px;"><code>{{ widgetConfig.settings|json_encode(constant('JSON_PRETTY_PRINT') b-or constant('JSON_UNESCAPED_SLASHES')) }}</code></pre>
	</div>

	<div class="pane">
		<h2>{{ 'Usage in Templates'|t('search-manager') }}</h2>
		<p class="light">{{ 'Include this widget in your Twig templates using:'|t('search-manager') }}</p>
		<div style="background: #f3f7fc; padding: 14px; border-radius: 4px; font-family: monospace; font-size: 12px; line-height: 1.5;">
			<code style="display: block; white-space: pre-wrap; word-break: break-all;">{% verbatim %}{% include 'search-manager/_widget/search' with {
    config: '{% endverbatim %}{{ widgetConfig.handle }}{% verbatim %}',
} %}{% endverbatim %}</code>
		</div>
	</div>

	{% include 'lindemannrock-base/_components/plugin-credit' %}
{% endblock %}

{% block details %}
	{# Default toggle #}
	<div class="meta">
		{% if isDefaultFromConfig %}
			{# Default set via config file - show disabled switch #}
			{{ forms.lightswitchField({
				label: 'Default'|t('search-manager'),
				instructions: 'Set via config/search-manager.php. Edit the file to change.'|t('search-manager'),
				id: 'isDefault',
				on: isDefault,
				disabled: true
			}) }}
		{% elseif isDefault %}
			{# This is the default - show disabled switch with explanation #}
			{{ forms.lightswitchField({
				label: 'Default'|t('search-manager'),
				instructions: 'To change, set another widget as default first.'|t('search-manager'),
				id: 'isDefault',
				on: true,
				disabled: true
			}) }}
		{% else %}
			{# Not the default - allow setting as default via AJAX #}
			{{ forms.lightswitchField({
				label: 'Default'|t('search-manager'),
				instructions: 'Use as default when no widget handle is specified'|t('search-manager'),
				id: 'isDefault',
				on: false
			}) }}
		{% endif %}
	</div>

	{# Widget Info #}
	<div class="meta" style="padding: 12px;">
		<style>
			.widget-info-item {
				display: grid;
				grid-template-columns: auto 1fr;
				gap: 8px;
				align-items: center;
				padding: 6px 0;
			}
			.widget-info-item:not(:last-child) {
				border-bottom: 1px solid rgba(51, 64, 77, 0.1);
			}
			.widget-info-item .label {
				color: #596673;
				font-weight: normal;
				white-space: nowrap;
			}
			.widget-info-item .value {
				text-align: right;
				word-break: break-word;
			}
		</style>
		<div class="widget-info-item">
			<div class="label">{{ 'Status'|t('search-manager') }}</div>
			<div class="value">
				<span class="status {{ widgetConfig.enabled ? 'live' : 'disabled' }}"></span>
				{{ widgetConfig.enabled ? 'Enabled'|t('search-manager') : 'Disabled'|t('search-manager') }}
			</div>
		</div>

		<div class="widget-info-item">
			<div class="label">{{ 'Handle'|t('search-manager') }}</div>
			<div class="value"><code>{{ widgetConfig.handle }}</code></div>
		</div>

		<div class="widget-info-item">
			<div class="label">{{ 'Source'|t('search-manager') }}</div>
			<div class="value">{{ 'Config File'|t('search-manager') }}</div>
		</div>

		{% if isDefault %}
			<div class="widget-info-item">
				<div class="label">{{ 'Default'|t('search-manager') }}</div>
				<div class="value">{{ 'Yes'|t('search-manager') }}</div>
			</div>
		{% endif %}
	</div>

	{# Widget Preview #}
	{% include "search-manager/widgets/_partials/preview" with {
		widgetConfig: widgetConfig
	} %}
{% endblock %}

{% js %}
// Light/Dark preview toggle
(function() {
	const lightPreview = document.querySelector('.widget-preview-light');
	const darkPreview = document.querySelector('.widget-preview-dark');
	const toggleButtons = document.querySelectorAll('.widget-preview-toggle button');

	if (!lightPreview || !darkPreview || !toggleButtons.length) return;

	toggleButtons.forEach(function(btn) {
		btn.addEventListener('click', function() {
			const mode = this.getAttribute('data-preview-mode');

			// Update button states
			toggleButtons.forEach(function(b) {
				const isActive = b.getAttribute('data-preview-mode') === mode;
				b.setAttribute('aria-pressed', isActive ? 'true' : 'false');
				b.classList.toggle('secondary', isActive);
			});

			// Show/hide previews
			lightPreview.style.display = mode === 'light' ? 'block' : 'none';
			darkPreview.style.display = mode === 'dark' ? 'block' : 'none';
		});
	});
})();

// Default toggle via AJAX (for config widgets that are not already default)
{% if not isDefaultFromConfig and not isDefault %}
(function() {
	const $lightswitch = $('#isDefault').closest('.lightswitch');
	if (!$lightswitch.length) return;

	$lightswitch.on('change', function() {
		const isOn = $(this).hasClass('on');
		if (isOn) {
			Craft.sendActionRequest('POST', 'search-manager/widgets/set-default', {
				data: { configId: '{{ widgetConfig.handle }}' }
			}).then(function(response) {
				if (response.data.success) {
					Craft.cp.displayNotice(response.data.message || '{{ "Default widget updated"|t('search-manager') }}');
					setTimeout(() => window.location.reload(), 500);
				} else {
					Craft.cp.displayError(response.data.error);
					$lightswitch.data('lightswitch').turnOff();
				}
			}).catch(function(error) {
				Craft.cp.displayError('{{ "Failed to update default widget"|t('search-manager') }}');
				$lightswitch.data('lightswitch').turnOff();
			});
		}
	});
})();
{% endif %}
{% endjs %}
