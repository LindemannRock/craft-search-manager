{% extends 'lindemannrock-base/_layouts/cp-table' %}

{% set plugin = craft.app.plugins.getPlugin('search-manager') %}
{% set settings = plugin.getSettings() %}

{# Get query parameters #}
{% set search = craft.app.request.getParam('search', '') %}
{% set statusFilter = craft.app.request.getParam('status', 'all') %}
{% set sourceFilter = craft.app.request.getParam('source', 'all') %}
{% set sort = craft.app.request.getParam('sort', 'source') %}
{% set dir = craft.app.request.getParam('dir', 'asc') %}
{% set page = craft.app.request.getParam('page', 1)|number_format(0, '', '') %}
{% set limit = settings.itemsPerPage %}
{% set offset = (page - 1) * limit %}

{# Permission checks #}
{% set canCreate = currentUser.can('searchManager:createWidgetConfigs') %}
{% set canEdit = currentUser.can('searchManager:editWidgetConfigs') %}
{% set canDelete = currentUser.can('searchManager:deleteWidgetConfigs') %}

{# Check if there are any config-based widgets #}
{% set hasConfigItems = widgetConfigs|filter(c => c.isFromConfig())|length > 0 %}

{# Filter widget configs based on filters #}
{% set filteredConfigs = widgetConfigs %}

{# Status filter #}
{% if statusFilter == 'enabled' %}
	{% set filteredConfigs = filteredConfigs|filter(c => c.enabled) %}
{% elseif statusFilter == 'disabled' %}
	{% set filteredConfigs = filteredConfigs|filter(c => not c.enabled) %}
{% endif %}

{# Source filter #}
{% if sourceFilter == 'config' %}
	{% set filteredConfigs = filteredConfigs|filter(c => c.source == 'config') %}
{% elseif sourceFilter == 'database' %}
	{% set filteredConfigs = filteredConfigs|filter(c => c.source != 'config') %}
{% endif %}

{# Search filter #}
{% if search %}
	{% set filteredConfigs = filteredConfigs|filter(c => search|lower in c.name|lower or search|lower in c.handle|lower) %}
{% endif %}

{# Sort #}
{% if sort == 'name' %}
	{% set filteredConfigs = dir == 'asc' ? filteredConfigs|sort((a, b) => a.name|lower <=> b.name|lower) : filteredConfigs|sort((a, b) => b.name|lower <=> a.name|lower) %}
{% elseif sort == 'handle' %}
	{% set filteredConfigs = dir == 'asc' ? filteredConfigs|sort((a, b) => a.handle|lower <=> b.handle|lower) : filteredConfigs|sort((a, b) => b.handle|lower <=> a.handle|lower) %}
{% elseif sort == 'source' %}
	{% set filteredConfigs = dir == 'asc' ? filteredConfigs|sort((a, b) => (a.source ?? '') <=> (b.source ?? '')) : filteredConfigs|sort((a, b) => (b.source ?? '') <=> (a.source ?? '')) %}
{% elseif sort == 'enabled' %}
	{% set filteredConfigs = dir == 'asc' ? filteredConfigs|sort((a, b) => a.enabled <=> b.enabled) : filteredConfigs|sort((a, b) => b.enabled <=> a.enabled) %}
{% elseif sort == 'isDefault' %}
	{% set filteredConfigs = dir == 'asc' ? filteredConfigs|sort((a, b) => (defaultWidgetHandle == a.handle) <=> (defaultWidgetHandle == b.handle)) : filteredConfigs|sort((a, b) => (defaultWidgetHandle == b.handle) <=> (defaultWidgetHandle == a.handle)) %}
{% endif %}

{# Pagination #}
{% set totalCount = filteredConfigs|length %}
{% set paginatedItems = filteredConfigs|slice(offset, limit) %}

{% set tableConfig = {
	plugin: {
		handle: 'search-manager',
		name: searchHelper.fullName,
	},
	page: {
		title: 'Widgets'|t('search-manager'),
		subnav: 'widgets',
		crumbs: [
			{ label: searchHelper.fullName, url: url('search-manager') },
			{ label: 'Widgets'|t('search-manager'), url: url('search-manager/widgets') }
		],
	},
	filters: [
		{
			type: 'status',
			param: 'status',
			current: statusFilter,
			label: 'All'|t('search-manager'),
			groups: [
				{
					param: 'status',
					current: statusFilter,
					options: [
						{value: 'all', label: 'All'|t('search-manager'), status: 'all'},
						{value: 'enabled', label: 'Enabled'|t('search-manager'), status: 'green'},
						{value: 'disabled', label: 'Disabled'|t('search-manager'), status: 'disabled'},
					],
				},
				{
					header: 'Config Source'|t('search-manager'),
					param: 'source',
					current: sourceFilter,
					colorSet: 'configSource',
					options: [
						{value: 'all', label: 'All Sources'|t('search-manager'), status: 'all'},
						{value: 'config', label: 'Config File'|t('search-manager'), colorKey: 'config'},
						{value: 'database', label: 'Database'|t('search-manager'), colorKey: 'database'},
					],
				},
			],
		},
	],
	search: {
		placeholder: 'Search widget configs...'|t('search-manager'),
		value: search,
	},
	sort: {
		field: sort,
		direction: dir,
	},
	table: {
		columns: [
			{key: 'name', label: 'Name'|t('search-manager'), sortable: true},
			{key: 'handle', label: 'Handle'|t('search-manager'), sortable: true, hideable: true},
			{key: 'source', label: 'Source'|t('search-manager'), sortable: true, hideable: true},
			{key: 'enabled', label: 'Status'|t('search-manager'), sortable: true, hideable: true},
			{key: 'isDefault', label: 'Default'|t('search-manager'), sortable: true, hideable: true},
		],
		items: paginatedItems,
		emptyMessage: 'No widget configurations found.'|t('search-manager'),
		hasConfigItems: hasConfigItems,
	},
	pagination: {
		page: page,
		limit: limit,
		totalCount: totalCount,
		itemLabel: {singular: 'config'|t('search-manager'), plural: 'configs'|t('search-manager')},
	},
	checkboxes: canEdit or canDelete,
	newButton: {
		url: url('search-manager/widgets/new'),
		label: 'New Widget Config'|t('search-manager'),
		permission: 'searchManager:createWidgetConfigs',
	},
} %}

{% block beforeTable %}

	{# Warning if default widget is missing or disabled #}
	{% if defaultWidgetHandle %}
		{% set defaultWidget = widgetConfigs|filter(w => w.handle == defaultWidgetHandle)|first %}
		{% if not defaultWidget %}
			{# Default widget doesn't exist #}
			{% set warningMessage %}
			<strong>{{ 'Warning'|t('search-manager') }}:</strong>
			{{ 'The default widget handle "{handle}" does not exist.'|t('search-manager', {handle: defaultWidgetHandle}) }}
			{% if isDefaultFromConfig %}
				{{ 'Update your config/search-manager.php to point to a valid widget handle.'|t('search-manager') }}
			{% else %}
				{{ 'Please set a different widget as default.'|t('search-manager') }}
			{% endif %}
			{% endset %}
			<div class="lr-info-box-table-wrapper">
				{% include 'lindemannrock-base/_components/info-box' with {
					message: warningMessage,
					type: 'warning',
					margin: 'none',
					stretch: true,
				} %}
			</div>
		{% elseif not defaultWidget.enabled %}
			{# Default widget exists but is disabled #}
			{% set warningMessage %}
			<strong>{{ 'Warning'|t('search-manager') }}:</strong>
			{{ 'The default widget "{name}" is disabled. Search widget may not work.'|t('search-manager', {name: defaultWidget.name}) }}
			{% if not isDefaultFromConfig %}
				{{ 'Please enable it or set a different widget as default.'|t('search-manager') }}
			{% else %}
				{{ 'Update your config/search-manager.php to fix this.'|t('search-manager') }}
			{% endif %}
			{% endset %}
			<div class="lr-info-box-table-wrapper">
				{% include 'lindemannrock-base/_components/info-box' with {
					message: warningMessage,
					type: 'warning',
					margin: 'none',
					stretch: true,
				} %}
			</div>
		{% endif %}
	{% elseif widgetConfigs|length > 0 %}
		{# No default handle set but widgets exist #}
		{% set warningMessage %}
		<strong>{{ 'Warning'|t('search-manager') }}:</strong>
		{{ 'No default widget is configured. Please set one of the widgets as default.'|t('search-manager') }}
		{% endset %}
		<div class="lr-info-box-table-wrapper">
			{% include 'lindemannrock-base/_components/info-box' with {
				message: warningMessage,
				type: 'warning',
				margin: 'none',
				stretch: true,
			} %}
		</div>
	{% endif %}
{% endblock %}

{% block tableRow %}
	{% set isConfig = item.isFromConfig() %}
	{% set isDefault = defaultWidgetHandle == item.handle %}

	{# Name #}
	<td data-column="name">
		{% if item.canEdit() %}
			<a class="label-link" href="{{ url('search-manager/widgets/edit/' ~ item.id) }}">
				<span>{{ item.name }}</span>
			</a>
		{% else %}
			<a class="label-link" href="{{ url('search-manager/widgets/view/' ~ item.handle) }}">
				<span>{{ item.name }}</span>
			</a>
			<span class="lr-config-info-icon" data-config="{{ item.rawConfigDisplay|e('html_attr') }}" data-config-source="config/search-manager.php"></span>
		{% endif %}
	</td>

	{# Handle #}
	<td data-column="handle">
		<code>{{ item.handle }}</code>
	</td>

	{# Source #}
	<td data-column="source">
		{% include 'lindemannrock-base/_components/badge' with {
			label: item.source == 'config' ? 'Config'|t('search-manager') : 'Database'|t('search-manager'),
			value: item.source,
			colorSet: 'configSource',
		} only %}
	</td>

	{# Status #}
	<td data-column="enabled">
		{% include 'lindemannrock-base/_components/badge' with {
			label: item.enabled ? 'Enabled'|t('search-manager') : 'Disabled'|t('search-manager'),
			value: item.enabled ? 'enabled' : 'disabled',
			colorSet: 'status',
		} only %}
	</td>

	{# Default #}
	<td data-column="isDefault">
		{% if isDefault %}
			{% include 'lindemannrock-base/_components/badge' with {
				label: 'Yes'|t('search-manager'),
				value: 'yes',
				colorSet: 'yesNo',
			} only %}
		{% else %}
			<span class="light">-</span>
		{% endif %}
	</td>
{% endblock %}

{% block rowActions %}
	{% set isConfig = item.isFromConfig() %}
	{% set isDefault = defaultWidgetHandle == item.handle %}

	{% set actionItems = [] %}

	{% if item.canEdit() %}
		{# Database widgets - can edit #}
		{% if canEdit %}
			{% set actionItems = actionItems|merge([{
				label: 'Edit'|t('app'),
				url: url('search-manager/widgets/edit/' ~ item.id),
			}]) %}
			{% if not isDefault and not isDefaultFromConfig %}
				{% set actionItems = actionItems|merge([{
					label: 'Set as Default'|t('search-manager'),
					jsAction: 'set-default',
				}]) %}
			{% endif %}
		{% endif %}
		{% if canDelete and not isDefault %}
			{% set actionItems = actionItems|merge([{
				label: 'Delete'|t('app'),
				class: 'error',
				jsAction: 'delete',
			}]) %}
		{% endif %}
	{% else %}
		{# Config file widgets - View only #}
		{% set actionItems = actionItems|merge([{
			label: 'View'|t('app'),
			url: url('search-manager/widgets/view/' ~ item.handle),
		}]) %}
		{% if canEdit and not isDefault and not isDefaultFromConfig %}
			{% set actionItems = actionItems|merge([{
				label: 'Set as Default'|t('search-manager'),
				jsAction: 'set-default',
			}]) %}
		{% endif %}
	{% endif %}

	{% if actionItems|length > 0 %}
		{% include 'lindemannrock-base/_components/row-actions' with {
			item: item,
			actions: {
				type: 'menu',
				icon: 'settings',
				title: 'Actions'|t('app'),
				items: actionItems,
			},
		} only %}
	{% endif %}
{% endblock %}

{% block bulkActions %}
	{% if canEdit %}
		<button type="button" class="btn menubtn secondary" id="lr-bulk-status-btn">
			{{ 'Set status'|t('app') }}
		</button>
		<div class="menu">
			<ul>
				<li><a id="lr-bulk-enable-action">{{ 'Enable'|t('search-manager') }}</a></li>
				<li><a id="lr-bulk-disable-action">{{ 'Disable'|t('search-manager') }}</a></li>
			</ul>
		</div>
	{% endif %}

	{% if canDelete %}
		<button type="button" class="btn secondary" id="lr-bulk-delete-btn">
			{{ 'Delete'|t('search-manager') }} (<span id="lr-selected-count">0</span>)
		</button>
	{% endif %}
{% endblock %}

{% block scripts %}
<script>
(function() {
	// Initialize bulk status menu
	const bulkStatusBtn = document.getElementById('lr-bulk-status-btn');
	if (bulkStatusBtn && typeof Craft !== 'undefined' && Craft.MenuBtn) {
		new Craft.MenuBtn(bulkStatusBtn);
	}

	// Bulk enable
	document.getElementById('lr-bulk-enable-action')?.addEventListener('click', function(e) {
		e.preventDefault();
		const ids = window.lrTableSelection.getSelectedIds();
		if (ids.length === 0) return;

		Craft.sendActionRequest('POST', 'search-manager/widgets/bulk-enable', {
			data: { configIds: ids }
		}).then(function(response) {
			if (response.data.success) {
				Craft.cp.displayNotice(Craft.t('search-manager', 'Enabled {count} configs', {count: response.data.count}));
				setTimeout(() => window.location.reload(), 1000);
			}
		}).catch(function(error) {
			Craft.cp.displayError(Craft.t('search-manager', 'Failed to enable configs'));
		});
	});

	// Bulk disable
	document.getElementById('lr-bulk-disable-action')?.addEventListener('click', function(e) {
		e.preventDefault();
		const ids = window.lrTableSelection.getSelectedIds();
		if (ids.length === 0) return;

		Craft.sendActionRequest('POST', 'search-manager/widgets/bulk-disable', {
			data: { configIds: ids }
		}).then(function(response) {
			if (response.data.count > 0) {
				Craft.cp.displayNotice(Craft.t('search-manager', 'Disabled {count} configs', {count: response.data.count}));
			}
			if (response.data.errors && response.data.errors.length > 0) {
				response.data.errors.forEach(err => Craft.cp.displayError(err));
			} else if (response.data.error) {
				Craft.cp.displayError(response.data.error);
			}
			if (response.data.count > 0 && (!response.data.errors || response.data.errors.length === 0)) {
				setTimeout(() => window.location.reload(), 1000);
			}
		}).catch(function(error) {
			Craft.cp.displayError(Craft.t('search-manager', 'Failed to disable configs'));
		});
	});

	// Bulk delete
	document.getElementById('lr-bulk-delete-btn')?.addEventListener('click', function() {
		const ids = window.lrTableSelection.getSelectedIds();
		if (ids.length === 0) return;

		if (!confirm(Craft.t('search-manager', 'Delete {count} config(s)? This cannot be undone.', {count: ids.length}))) return;

		Craft.sendActionRequest('POST', 'search-manager/widgets/bulk-delete', {
			data: { configIds: ids }
		}).then(function(response) {
			if (response.data.count > 0) {
				Craft.cp.displayNotice(Craft.t('search-manager', 'Deleted {count} config(s)', {count: response.data.count}));
			}
			if (response.data.errors && response.data.errors.length > 0) {
				response.data.errors.forEach(err => Craft.cp.displayError(err));
			} else if (response.data.error) {
				Craft.cp.displayError(response.data.error);
			}
			if (response.data.count > 0 && (!response.data.errors || response.data.errors.length === 0)) {
				setTimeout(() => window.location.reload(), 1000);
			}
		}).catch(function(error) {
			Craft.cp.displayError(Craft.t('search-manager', 'Failed to delete configs'));
		});
	});

	// Individual delete action
	document.querySelectorAll('[data-action="delete"]').forEach(function(btn) {
		btn.addEventListener('click', function(e) {
			e.preventDefault();
			const row = this.closest('tr');
			const id = row?.dataset.id;
			const name = row?.dataset.name || '';

			if (!id) return;

			if (!confirm(Craft.t('search-manager', 'Delete widget config "{name}"? This cannot be undone.', {name: name}))) return;

			Craft.sendActionRequest('POST', 'search-manager/widgets/delete', {
				data: { configId: id }
			}).then(function(response) {
				if (response.data.success) {
					Craft.cp.displayNotice(Craft.t('search-manager', 'Widget config deleted'));
					setTimeout(() => window.location.reload(), 1000);
				} else {
					Craft.cp.displayError(response.data.error || Craft.t('search-manager', 'Failed to delete config'));
				}
			}).catch(function(error) {
				Craft.cp.displayError(Craft.t('search-manager', 'Failed to delete config'));
			});
		});
	});

	// Set as default action
	document.querySelectorAll('[data-action="set-default"]').forEach(function(btn) {
		btn.addEventListener('click', function(e) {
			e.preventDefault();
			const row = this.closest('tr');
			const id = row?.dataset.id;

			if (!id) return;

			Craft.sendActionRequest('POST', 'search-manager/widgets/set-default', {
				data: { configId: id }
			}).then(function(response) {
				if (response.data.success) {
					Craft.cp.displayNotice(Craft.t('search-manager', 'Default config updated'));
					setTimeout(() => window.location.reload(), 1000);
				}
			}).catch(function(error) {
				Craft.cp.displayError(Craft.t('search-manager', 'Failed to update default config'));
			});
		});
	});

	// Update selected count
	document.addEventListener('lr:selectionChanged', function(e) {
		const countSpan = document.getElementById('lr-selected-count');
		if (countSpan) {
			countSpan.textContent = e.detail.count;
		}
	});
})();
</script>
{% endblock %}
