{#
/**
 * Search Manager - Search Widget
 *
 * Include this in your templates to add a CMD+K style search modal.
 *
 * Usage:
 * {% include 'search-manager/_widget/search' %}
 *
 * With a named config:
 * {% include 'search-manager/_widget/search' with {
 *     config: 'homepage',
 * } %}
 *
 * With inline overrides:
 * {% include 'search-manager/_widget/search' with {
 *     config: 'homepage',
 *     indices: ['blog', 'products'],
 *     placeholder: 'Search articles...',
 *     theme: 'dark',
 * } %}
 *
 * Available options:
 * - config: (string) Widget config handle (loads settings from database)
 * - indices: (array) Search index handles (optional, empty = search all)
 * - index: (string) Single index handle (legacy, use indices instead)
 * - placeholder: (string) Input placeholder text (default: 'Search...')
 * - theme: (string) 'light' or 'dark' (default: 'light')
 * - maxResults: (int) Maximum results to show (default: from config)
 * - debounce: (int) Debounce delay in ms (default: from config)
 * - minChars: (int) Minimum characters before searching (default: from config)
 * - showRecent: (bool) Show recent searches (default: from config)
 * - groupResults: (bool) Group results by type/section (default: from config)
 * - hotkey: (string) Keyboard shortcut key (default: from config)
 * - showTrigger: (bool) Show the trigger button (default: from config)
 * - triggerText: (string) Trigger button text (default: from config)
 * - triggerSelector: (string) CSS selector for external trigger element (e.g., '#my-search-btn')
 * - siteId: (int) Specific site ID to search (optional)
 * - class: (string) Additional CSS class for the widget
 * - dir: (string) Text direction 'ltr' or 'rtl' (auto-detected from site)
 * - enableHighlighting: (bool) Enable term highlighting (default: from config)
 * - highlightTag: (string) HTML tag for highlights (default: from config)
 * - highlightClass: (string) CSS class for highlights (default: from config)
 * - backdropOpacity: (int) Backdrop opacity 0-100 (default: from config)
 * - enableBackdropBlur: (bool) Enable backdrop blur effect (default: from config)
 * - preventBodyScroll: (bool) Prevent body scroll when open (default: from config)
 * - styles: (object) Override individual style values (see WidgetConfig for keys)
 *
 * @link https://lindemannrock.com
 * @copyright Copyright (c) 2025 LindemannRock
 */
#}

{# Get plugin instance and widget config #}
{% set plugin = craft.app.plugins.getPlugin('search-manager') %}
{% set widgetConfig = plugin.widgetConfigs.getConfigForWidget(config ?? null) %}

{# Search settings - support both indices (array) and legacy index (string) #}
{% if indices is defined and indices is iterable %}
    {% set indexHandles = indices %}
{% elseif index is defined and index %}
    {% set indexHandles = [index] %}
{% else %}
    {% set indexHandles = widgetConfig.getIndexHandles() %}
{% endif %}

{% set placeholder = placeholder ?? 'Search...'|t('search-manager') %}
{% set theme = theme ?? 'light' %}
{% set siteId = siteId ?? '' %}
{% set class = class ?? '' %}
{% set dir = dir ?? (craft.app.locale.getOrientation() == 'rtl' ? 'rtl' : 'ltr') %}

{# Behavior settings - use inline param override or fall back to widget config #}
{% set maxResults = maxResults ?? widgetConfig.getMaxResults() %}
{% set debounce = debounce ?? widgetConfig.getDebounce() %}
{% set minChars = minChars ?? widgetConfig.getMinChars() %}
{% set showRecent = showRecent ?? widgetConfig.isShowRecentEnabled() %}
{% set groupResults = groupResults ?? widgetConfig.isGroupResultsEnabled() %}
{% set hotkey = hotkey ?? widgetConfig.getHotkey() %}

{# Trigger settings #}
{% set showTrigger = showTrigger ?? widgetConfig.isShowTriggerEnabled() %}
{% set triggerText = triggerText ?? widgetConfig.getTriggerText()|t('search-manager') %}
{% set triggerSelector = triggerSelector ?? '' %}

{# Highlighting settings #}
{% set enableHighlighting = enableHighlighting ?? widgetConfig.isHighlightingEnabled() %}
{% set highlightTag = highlightTag ?? widgetConfig.getHighlightTag() %}
{% set highlightClass = highlightClass ?? widgetConfig.getHighlightClass() %}

{# Backdrop settings #}
{% set backdropOpacity = backdropOpacity ?? widgetConfig.getBackdropOpacity() %}
{% set enableBackdropBlur = enableBackdropBlur ?? widgetConfig.isBackdropBlurEnabled() %}
{% set preventBodyScroll = preventBodyScroll ?? widgetConfig.isPreventBodyScrollEnabled() %}

{# Get styles - merge config styles with highlighting colors and any inline overrides #}
{% set configStyles = widgetConfig.getStyles() %}
{% set highlightStyles = {
    highlightBgLight: widgetConfig.getHighlightBgLight(),
    highlightColorLight: widgetConfig.getHighlightColorLight(),
    highlightBgDark: widgetConfig.getHighlightBgDark(),
    highlightColorDark: widgetConfig.getHighlightColorDark(),
} %}
{% set mergedStyles = configStyles|merge(highlightStyles) %}
{% if styles is defined and styles is iterable %}
    {% set mergedStyles = mergedStyles|merge(styles) %}
{% endif %}

{# Register the widget JS (minified in production, unminified in devMode) #}
{% set widgetJs = craft.app.config.general.devMode ? 'SearchWidget.js' : 'SearchWidget.min.js' %}
{% do view.registerJsFile(craft.app.assetManager.getPublishedUrl('@searchmanager/web/assets/searchwidget', true) ~ '/dist/' ~ widgetJs, {
    position: 3
}) %}

{# Build the endpoint URL #}
{% set endpoint = actionUrl('search-manager/search/query') %}
{% set analyticsEndpoint = actionUrl('search-manager/search/track-click') %}

{# Render the widget #}
<search-widget
    {% if indexHandles|length %}indices="{{ indexHandles|join(',') }}"{% endif %}
    placeholder="{{ placeholder }}"
    endpoint="{{ endpoint }}"
    analytics-endpoint="{{ analyticsEndpoint }}"
    theme="{{ theme }}"
    max-results="{{ maxResults }}"
    debounce="{{ debounce }}"
    min-chars="{{ minChars }}"
    show-recent="{{ showRecent ? 'true' : 'false' }}"
    group-results="{{ groupResults ? 'true' : 'false' }}"
    hotkey="{{ hotkey }}"
    {% if siteId %}site-id="{{ siteId }}"{% endif %}
    {% if class %}class="{{ class }}"{% endif %}
    dir="{{ dir }}"
    enable-highlighting="{{ enableHighlighting ? 'true' : 'false' }}"
    highlight-tag="{{ highlightTag }}"
    {% if highlightClass %}highlight-class="{{ highlightClass }}"{% endif %}
    backdrop-opacity="{{ backdropOpacity }}"
    enable-backdrop-blur="{{ enableBackdropBlur ? 'true' : 'false' }}"
    prevent-body-scroll="{{ preventBodyScroll ? 'true' : 'false' }}"
    show-trigger="{{ showTrigger ? 'true' : 'false' }}"
    {% if triggerSelector %}trigger-selector="{{ triggerSelector }}"{% endif %}
    styles="{{ mergedStyles|json_encode|e('html_attr') }}"
></search-widget>
