<div class="lr-unified-cards">
    {% include 'lindemannrock-base/_components/cards/unified-card' with {
        value: (totalCount ?? 0)|number,
        description: 'Total Searches'|t('search-manager'),
        align: 'center',
        id: 'total-404s',
    } only %}

    {% include 'lindemannrock-base/_components/cards/unified-card' with {
        value: (handledCount ?? 0)|number,
        description: 'With Hits'|t('search-manager'),
        align: 'center',
        id: 'handled-404s',
    } only %}

    {% include 'lindemannrock-base/_components/cards/unified-card' with {
        value: (unhandledCount ?? 0)|number,
        description: 'Zero Hits'|t('search-manager'),
        align: 'center',
        id: 'unhandled-404s',
    } only %}

    {% include 'lindemannrock-base/_components/cards/unified-card' with {
        value: (totalCount > 0 ? ((handledCount / totalCount * 100)|round) : 0) ~ '%',
        description: 'Success Rate'|t('search-manager'),
        align: 'center',
        id: 'success-rate',
    } only %}
</div>

<h2 class="lr-section-heading">{{ "Search Trend"|t('search-manager') }}</h2>

<div class="lr-analytics-charts">
    <div class="lr-chart-container full-width">
        <canvas id="404-trend-chart"></canvas>
    </div>
</div>

<h2 class="lr-section-heading">{{ "Search Breakdown"|t('search-manager') }}</h2>

<div class="lr-analytics-charts two-columns">
    <div class="lr-chart-container">
        <h3>{{ "Intent Distribution"|t('search-manager') }}</h3>
        <canvas id="intent-chart"></canvas>
    </div>

    <div class="lr-chart-container">
        <h3>{{ "Source Distribution"|t('search-manager') }}</h3>
        <canvas id="source-chart"></canvas>
    </div>
</div>

<h2 class="lr-section-heading">{{ "Query Analysis"|t('search-manager') }}</h2>

<div class="lr-analytics-charts two-columns">
    <div class="lr-chart-container">
        <h3>{{ "Query Length Distribution"|t('search-manager') }}</h3>
        <canvas id="query-length-chart"></canvas>
        <div class="chart-legend" id="query-length-legend"></div>
    </div>

    <div class="lr-chart-container">
        <h3>{{ "Word Cloud"|t('search-manager') }}</h3>
        <div id="word-cloud-container" class="lr-word-cloud">
            {# Word cloud will be rendered here by D3/JS #}
        </div>
    </div>
</div>

<h2 class="lr-section-heading">{{ "Search Activity"|t('search-manager') }}</h2>

<div class="lr-analytics-charts">
    <div class="lr-chart-container full-width">
        <h3>{{ "Peak Search Hours"|t('search-manager') }}</h3>
        <p class="light lr-note">{{ "When users search most (24-hour format)"|t('search-manager') }}</p>
        <div class="lr-chart-height-200">
            <canvas id="peak-hours-chart" class="lr-chart-canvas"></canvas>
        </div>
        <div id="peak-hour-label" class="lr-peak-label"></div>
    </div>
</div>

<h2 class="lr-section-heading">{{ "Trending Queries"|t('search-manager') }}</h2>

<div class="lr-analytics-charts">
    <div class="lr-chart-container full-width">
        <p class="light lr-note">{{ "Compared to previous period (e.g., last 7 days vs. prior 7 days)"|t('search-manager') }}</p>
        <div class="lr-table-scroll">
            <table class="data fullwidth">
                <thead>
                    <tr>
                        <th>{{ 'Query'|t('search-manager') }}</th>
                        <th class="lr-text-end">{{ 'Searches'|t('search-manager') }}</th>
                        <th class="lr-text-end">{{ 'Previous'|t('search-manager') }}</th>
                        <th class="lr-text-end">{{ 'Trend'|t('search-manager') }}</th>
                    </tr>
                </thead>
                <tbody id="trending-queries-body">
                    <tr><td colspan="4" class="thin light">{{ "Loading..."|t('search-manager') }}</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<h2 class="lr-section-heading">{{ "Most Common Queries (Top 15)"|t('search-manager') }}</h2>

<div class="lr-analytics-charts">
    <div class="lr-chart-container full-width">
        <div class="lr-table-scroll">
            <table class="data fullwidth">
                <thead>
                    <tr>
                        <th>{{ 'Query'|t('search-manager') }}</th>
                        <th>{{ 'Site'|t('search-manager') }}</th>
                        <th>{{ 'Searches'|t('search-manager') }}</th>
                        <th>{{ 'Avg Hits'|t('search-manager') }}</th>
                        <th>{{ 'Date'|t('search-manager') }}</th>
                        <th>{{ 'Time'|t('search-manager') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in mostCommon %}
                        <tr>
                            <td>
                                <span><code>{{ stat.query }}</code></span>
                            </td>
                            <td>
                                {% if stat.siteId %}
                                    {% set site = craft.app.sites.getSiteById(stat.siteId) %}
                                    {{ site ? site.name : '—' }}
                                {% else %}
                                    —
                                {% endif %}
                            </td>
                            <td><strong>{{ stat.count|number }}</strong></td>
                            <td>
                                {{ (stat.totalResults / stat.count)|round(1)|number }}
                            </td>
                            <td>{{ stat.lastSearched|date('short') }}</td>
                            <td>{{ stat.lastSearched|time('short') }}</td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="6" class="thin light lr-text-center">{{ "No searches recorded yet"|t('search-manager') }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
