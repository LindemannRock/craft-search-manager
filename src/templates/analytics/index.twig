{% extends 'lindemannrock-base/_layouts/cp-analytics' %}

{% set title = "Analytics"|t('search-manager') %}
{% set selectedSubnavItem = 'analytics' %}

{% set plugin = craft.app.plugins.getPlugin('search-manager') %}
{% set pluginHandle = pluginHandle ?? plugin.id %}

{% set crumbs = [
    {
        label: searchHelper.fullName|t('search-manager'),
        url: url('search-manager'),
    },
    {
        label: 'Analytics'|t('search-manager'),
        url: url('search-manager/analytics'),
    },
] %}

{# Check if query rules and promotions exist #}
{% set queryRulesExist = craft.app.db.createCommand("SELECT COUNT(*) FROM {{%searchmanager_query_rules}}").queryScalar() > 0 %}
{% set promotionsExist = craft.app.db.createCommand("SELECT COUNT(*) FROM {{%searchmanager_promotions}}").queryScalar() > 0 %}

{# Define Tabs #}
{% set tabsConfig = {
    overview: { label: "Overview"|t('search-manager') },
    searches: { label: "Recent Searches"|t('search-manager') },
} %}

{# Only add Query Rules tab if rules exist #}
{% if queryRulesExist %}
    {% set tabsConfig = tabsConfig|merge({
        'query-rules': { label: "Query Rules"|t('search-manager') }
    }) %}
{% endif %}

{# Only add Promotions tab if promotions exist #}
{% if promotionsExist %}
    {% set tabsConfig = tabsConfig|merge({
        'promotions': { label: "Promotions"|t('search-manager') }
    }) %}
{% endif %}

{% set tabsConfig = tabsConfig|merge({
    'content-gaps': { label: "Content Gaps"|t('search-manager') },
    performance: { label: "Performance"|t('search-manager') },
    'traffic-devices': { label: "Traffic & Devices"|t('search-manager') }
}) %}

{# Only add Geographic tab if geo detection is enabled #}
{% if settings.enableGeoDetection %}
    {% set tabsConfig = tabsConfig|merge({
        geographic: { label: "Geographic"|t('search-manager') }
    }) %}
{% endif %}

{% set analyticsConfig = {
    plugin: {
        handle: pluginHandle,
        name: searchHelper.fullName,
    },
    page: {
        title: title,
        subnav: selectedSubnavItem,
        crumbs: crumbs,
    },
    tabs: tabsConfig,
    filters: {
        dateRange: {
            default: lrDefaultDateRange(pluginHandle),
            current: dateRange,
        },
        sites: {
            enabled: sites|length > 1,
            current: siteId,
            sites: sites,
        },
    },
    charts: {
        prefix: 'search',
        dataEndpoint: 'search-manager/analytics/get-data',
    },
    export: {
        permission: 'searchManager:exportAnalytics',
        action: 'search-manager/analytics/export',
    },
} %}

{% block tabs %}
    {# Tab Content - IDs must match tab URLs #}
    <div id="overview" class="lr-tab-content">
        {% include 'search-manager/analytics/_partials/overview' %}
    </div>

    <div id="searches" class="lr-tab-content hidden">
         {% include 'search-manager/analytics/_partials/searches' %}
    </div>

    {% if queryRulesExist %}
    <div id="query-rules" class="lr-tab-content hidden">
         {% include 'search-manager/analytics/_partials/query-rules' %}
    </div>
    {% endif %}

    {% if promotionsExist %}
    <div id="promotions" class="lr-tab-content hidden">
         {% include 'search-manager/analytics/_partials/promotions' %}
    </div>
    {% endif %}

    <div id="content-gaps" class="lr-tab-content hidden">
         {% include 'search-manager/analytics/_partials/content-gaps' %}
    </div>

    <div id="performance" class="lr-tab-content hidden">
         {% include 'search-manager/analytics/_partials/performance' %}
    </div>

    <div id="traffic-devices" class="lr-tab-content hidden">
         {% include 'search-manager/analytics/_partials/traffic-devices' %}
    </div>

    {% if settings.enableGeoDetection %}
    <div id="geographic" class="lr-tab-content hidden">
         {% include 'search-manager/analytics/_partials/geographic' %}
    </div>
    {% endif %}
{% endblock %}

{% do view.registerAssetBundle('lindemannrock\\searchmanager\\web\\assets\\analytics\\AnalyticsAsset') %}

{% block scripts %}
{% set actionTypeBadges = {
    'synonym': include('lindemannrock-base/_components/badge', {
        label: 'Synonyms'|t('search-manager'),
        colorSet: 'actionType',
        value: 'synonym',
    })|trim,
    'boost_section': include('lindemannrock-base/_components/badge', {
        label: 'Boost Section'|t('search-manager'),
        colorSet: 'actionType',
        value: 'boost_section',
    })|trim,
    'boost_category': include('lindemannrock-base/_components/badge', {
        label: 'Boost Category'|t('search-manager'),
        colorSet: 'actionType',
        value: 'boost_category',
    })|trim,
    'boost_element': include('lindemannrock-base/_components/badge', {
        label: 'Boost Element'|t('search-manager'),
        colorSet: 'actionType',
        value: 'boost_element',
    })|trim,
    'filter': include('lindemannrock-base/_components/badge', {
        label: 'Filter'|t('search-manager'),
        colorSet: 'actionType',
        value: 'filter',
    })|trim,
    'redirect': include('lindemannrock-base/_components/badge', {
        label: 'Redirect'|t('search-manager'),
        colorSet: 'actionType',
        value: 'redirect',
    })|trim,
} %}

{% set analyticsStrings = {
    noTrend: "No trend data available for the selected filters."|t('search-manager'),
    noBot: "No bot data available for the selected filters."|t('search-manager'),
    noDevice: "No device data available for the selected filters."|t('search-manager'),
    noBrowser: "No browser data available for the selected filters."|t('search-manager'),
    noOs: "No OS data available for the selected filters."|t('search-manager'),
    noUsage: "No usage data available for the selected filters."|t('search-manager'),
    noQueryLength: "No query length data available for the selected filters."|t('search-manager'),
    noWordCloud: "No data available for word cloud."|t('search-manager'),
    noContentGaps: "No content gaps found!"|t('search-manager'),
    noPeakHour: "No peak hour data available for the selected filters."|t('search-manager'),
    searchesLabel: "Searches"|t('search-manager'),
    peakHourLabel: "Peak hour:"|t('search-manager'),
    noTrending: "No trending data available"|t('search-manager'),
    newLabel: "New"|t('search-manager'),
    notEnoughData: "Not enough data (min 3 searches per query)"|t('search-manager'),
    noIntent: "No intent data available for the selected filters."|t('search-manager'),
    noSource: "No source data available for the selected filters."|t('search-manager'),
    noPerformance: "No performance data available for the selected filters."|t('search-manager'),
    noDataFilters: "No data available for the selected filters."|t('search-manager'),
    noDataAvailable: "No data available"|t('search-manager'),
    noQueryRules: "No query rules have been triggered yet"|t('search-manager'),
    noRuleQueries: "No queries have triggered rules yet"|t('search-manager'),
    noPromotionsShown: "No promotions have been shown yet"|t('search-manager'),
    noPromotionQueries: "No queries have triggered promotions yet"|t('search-manager'),
} %}

{% set analyticsConfig = {
    dateRange: dateRange,
    siteId: siteId ?? '',
    csrfName: craft.app.config.general.csrfTokenName,
    csrfToken: craft.app.request.csrfToken,
    endpoints: {
        data: 'search-manager/analytics/get-data',
    },
    strings: analyticsStrings,
    actionTypeBadges: actionTypeBadges,
} %}

{% js %}
window.lrSearchAnalyticsInit({{ analyticsConfig|json_encode|raw }});
{% endjs %}
{% endblock %}

