{% extends "_layouts/cp" %}
{% set title = "Analytics"|t('search-manager') %}
{% set selectedSubnavItem = 'analytics' %}

{% set plugin = craft.app.plugins.getPlugin('search-manager') %}
{% set crumbs = [
    {
        label: searchHelper.fullName|t('search-manager'),
        url: url('search-manager'),
    },
    {
        label: 'Analytics'|t('search-manager'),
        url: url('search-manager/analytics'),
    },
] %}

{# Define Tabs #}
{% set tabs = {
    overview: { label: "Overview"|t('search-manager'), url: '#overview' },
    queries: { label: "Query Analysis"|t('search-manager'), url: '#queries' },
    contentGaps: { label: "Content Gaps"|t('search-manager'), url: '#content-gaps' },
    audience: { label: "Audience"|t('search-manager'), url: '#audience' }
} %}

{% set selectedTab = 'overview' %}

{% block actionButton %}
	<div id="action-button" class="btngroup">
		<button type="button" class="btn menubtn" data-icon="download">{{ "Export"|t('search-manager') }}</button>
		<div class="menu" data-align="right">
			<ul>
				<li>
					<a href="#" class="export-link" data-format="csv" data-action="search-manager/analytics/export-csv">{{ "Export as CSV"|t('search-manager') }}</a>
				</li>
			</ul>
		</div>
	</div>
{% endblock %}

{% block toolbar %}
	<div class="flex">
		<div>
			<div class="btngroup">
				<button type="button" class="btn menubtn">
					<span id="dateRangeLabel">{{ dateRange == 'today' ? 'Today' : (dateRange == 'last7days' ? 'Last 7 days' : (dateRange == 'last30days' ? 'Last 30 days' : (dateRange == 'last90days' ? 'Last 90 days' : 'All time'))) }}</span>
				</button>
				<div class="menu">
					<ul>
						<li><a href="#" data-range="today" class="main-date-range-option {{ dateRange == 'today' ? 'sel' : '' }}">{{ "Today"|t('search-manager') }}</a></li>
						<li><a href="#" data-range="last7days" class="main-date-range-option {{ dateRange == 'last7days' ? 'sel' : '' }}">{{ "Last 7 days"|t('search-manager') }}</a></li>
						<li><a href="#" data-range="last30days" class="main-date-range-option {{ dateRange == 'last30days' ? 'sel' : '' }}">{{ "Last 30 days"|t('search-manager') }}</a></li>
						<li><a href="#" data-range="last90days" class="main-date-range-option {{ dateRange == 'last90days' ? 'sel' : '' }}">{{ "Last 90 days"|t('search-manager') }}</a></li>
						<li><a href="#" data-range="all" class="main-date-range-option {{ dateRange == 'all' ? 'sel' : '' }}">{{ "All time"|t('search-manager') }}</a></li>
					</ul>
				</div>
			</div>
		</div>
	</div>
{% endblock %}

{% block content %}
    <div id="analytics-dashboard">
        {# Tab Content Containers #}
        <div id="tab-overview" class="tab-content">
            {% include 'search-manager/analytics/_tabs/overview' %}
        </div>
        
        <div id="tab-queries" class="tab-content hidden">
             {% include 'search-manager/analytics/_tabs/queries' %}
        </div>

        <div id="tab-content-gaps" class="tab-content hidden">
             {% include 'search-manager/analytics/_tabs/content-gaps' %}
        </div>

        <div id="tab-audience" class="tab-content hidden">
             {% include 'search-manager/analytics/_tabs/audience' %}
        </div>
    </div>

    {% include 'search-manager/_components/plugin-credit.twig' %}
{% endblock %}

{% css %}
    #analytics-dashboard {
        padding: 24px;
    }
    
    .tab-content.hidden {
        display: none;
    }

    .analytics-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
    }

    .stat-box {
        background: #f3f7fc;
        padding: 24px;
        border-radius: 4px;
        text-align: center;
        border: 1px solid var(--border-hairline);
    }

    .stat-value {
        font-size: 32px;
        font-weight: 600;
        color: #0d78f2;
        margin-bottom: 8px;
    }

    .stat-label {
        font-size: 14px;
        color: #596673;
    }

    .analytics-charts {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 30px;
        margin-bottom: 30px;
    }

    .analytics-charts.two-columns {
        grid-template-columns: repeat(2, 1fr);
    }

    @media (max-width: 1024px) {
        .analytics-charts.two-columns {
            grid-template-columns: 1fr;
        }
    }

    .chart-container.full-width {
        grid-column: 1 / -1;
    }

    .chart-container h3 {
        margin: 0 0 20px;
        font-size: 16px;
    }

    .chart-container {
        background: #fff;
        border: 1px solid #e3e5e8;
        border-radius: 4px;
        padding: 24px;
        min-width: 0;
        overflow: hidden;
    }

    .chart-container canvas {
        max-height: 300px;
        max-width: 100%;
    }

    .table-scroll-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin: 0 -24px;
        padding: 0 24px;
    }

    .table-scroll-container table {
        min-width: 100%;
        width: 100%;
    }

    /* Word Cloud Styles */
    .word-cloud-item {
        display: inline-block;
        padding: 5px;
        color: #0d78f2;
        transition: all 0.2s ease;
        cursor: pointer;
    }
    .word-cloud-item:hover {
        color: #d35400;
        transform: scale(1.1);
    }
{% endcss %}

{% js %}
    // Global Chart Instances
    window.smCharts = {};
    window.currentTab = 'overview';

    // Load Chart.js
    if (typeof Chart === 'undefined') {
        var script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js';
        script.onload = function() { initCharts(); };
        document.head.appendChild(script);
    } else {
        initCharts();
    }

    // Initialize Charts based on initial data
    function initCharts(data) {
        // Destroy existing
        Object.values(window.smCharts).forEach(c => c.destroy());
        window.smCharts = {};

        const chartColors = ['#0d78f2', '#27ae60', '#e74c3c', '#f39c12', '#9b59b6'];
        
        // Data sources (either passed or from server-rendered variables)
        const chartData = data ? data.chartData : {{ chartData|json_encode|raw }};
        const botStats = data ? data.botStats : {{ botStats|json_encode|raw }};
        const deviceBreakdown = data ? data.deviceBreakdown : {{ deviceBreakdown|json_encode|raw }};
        const browserBreakdown = data ? data.browserBreakdown : {{ browserBreakdown|json_encode|raw }};
        const osBreakdown = data ? data.osBreakdown : {{ osBreakdown|json_encode|raw }};

        // 1. Overview Tab Charts
        if (document.getElementById('404-trend-chart') && chartData) {
            window.smCharts.trend = new Chart(document.getElementById('404-trend-chart'), {
                type: 'line',
                data: {
                    labels: chartData.map(d => d.date),
                    datasets: [
                        { label: 'With Results', data: chartData.map(d => d.withResults), borderColor: '#10B981', tension: 0.1 },
                        { label: 'Zero Results', data: chartData.map(d => d.zeroResults), borderColor: '#EF4444', tension: 0.1 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        // 2. Audience Tab Charts (Only init if tab is active or data is ready)
        if (botStats && botStats.chart) {
             window.smCharts.bot = new Chart(document.getElementById('bot-chart'), {
                type: 'doughnut',
                data: {
                    labels: botStats.chart.labels,
                    datasets: [{ data: botStats.chart.values, backgroundColor: ['#27ae60', '#e74c3c'] }]
                }
            });
        }

        if (deviceBreakdown && deviceBreakdown.labels) {
            window.smCharts.device = new Chart(document.getElementById('device-chart'), {
                type: 'doughnut',
                data: {
                    labels: deviceBreakdown.labels,
                    datasets: [{ data: deviceBreakdown.values, backgroundColor: chartColors }]
                }
            });
        }

        if (browserBreakdown && browserBreakdown.labels) {
             window.smCharts.browser = new Chart(document.getElementById('browser-chart'), {
                type: 'bar',
                data: {
                    labels: browserBreakdown.labels,
                    datasets: [{ label: 'Searches', data: browserBreakdown.values, backgroundColor: '#0d78f2' }]
                }
            });
        }
        
        if (osBreakdown && osBreakdown.labels) {
             window.smCharts.os = new Chart(document.getElementById('os-chart'), {
                type: 'doughnut',
                data: {
                    labels: osBreakdown.labels,
                    datasets: [{ data: osBreakdown.values, backgroundColor: chartColors }]
                }
            });
        }
    }

    // Tab Switching Logic
    $(document).on('click', '.tab', function(e) {
        e.preventDefault();
        const $tab = $(this);
        const targetId = $tab.attr('href').substring(1); // remove #
        
        // Update UI
        $('.tab').removeClass('sel');
        $tab.addClass('sel');
        $('.tab-content').addClass('hidden');
        $('#tab-' + targetId).removeClass('hidden');

        window.currentTab = targetId;
        
        // Lazy Load Data for specific tabs
        if (targetId === 'queries' || targetId === 'content-gaps') {
             loadTabData(targetId);
        }
    });
    
    // Handle initial hash
    if(window.location.hash) {
        const hash = window.location.hash.substring(1);
        $(`.tab[href="#${hash}"]`).trigger('click');
    }

    // AJAX Data Loading for Tabs
    function loadTabData(tabName) {
        const mapping = {
            'queries': 'query-analysis',
            'content-gaps': 'content-gaps'
        };
        
        // Don't reload if already populated (simple check)
        if (tabName === 'queries' && $('#word-cloud-container').children().length > 0) return;
        if (tabName === 'content-gaps' && $('#content-gaps-body tr').length > 1) return;

        const dateRange = new URLSearchParams(window.location.search).get('dateRange') || 'last7days';
        
        $('#analytics-dashboard').css('opacity', '0.5');

        $.ajax({
            url: Craft.getActionUrl('search-manager/analytics/get-data'),
            type: 'POST',
            data: {
                dateRange: dateRange,
                type: mapping[tabName],
                {{ craft.app.config.general.csrfTokenName }}: '{{ craft.app.request.csrfToken }}'
            },
            success: function(res) {
                if(res.success) {
                    if (tabName === 'queries') renderQueryAnalysis(res.data.queryAnalysis);
                    if (tabName === 'content-gaps') renderContentGaps(res.data.contentGaps);
                }
                $('#analytics-dashboard').css('opacity', '1');
            }
        });
    }

    function renderQueryAnalysis(data) {
        // Render Length Chart
        if (data.lengthDistribution) {
             window.smCharts.length = new Chart(document.getElementById('query-length-chart'), {
                type: 'pie',
                data: {
                    labels: data.lengthDistribution.labels,
                    datasets: [{ data: data.lengthDistribution.values, backgroundColor: ['#3498db', '#9b59b6', '#34495e'] }]
                }
            });
        }

        // Render Word Cloud
        const container = $('#word-cloud-container');
        container.empty();
        if (data.wordCloud && data.wordCloud.length) {
            const maxWeight = Math.max(...data.wordCloud.map(w => w.weight));
            const minSize = 12;
            const maxSize = 48;
            
            data.wordCloud.forEach(w => {
                const size = minSize + ((w.weight / maxWeight) * (maxSize - minSize));
                const span = $('<span>')
                    .text(w.text)
                    .addClass('word-cloud-item')
                    .css('fontSize', size + 'px')
                    .attr('title', w.weight + ' searches');
                container.append(span).append(' ');
            });
        } else {
            container.html('<p class="light">No data available for word cloud.</p>');
        }
    }

    function renderContentGaps(data) {
        const tbody = $('#content-gaps-body');
        tbody.empty();
        
        if (!data.clusters || data.clusters.length === 0) {
            tbody.html('<tr><td colspan="5" class="thin light">No content gaps found!</td></tr>');
            return;
        }

        data.clusters.forEach(c => {
            let row = `<tr>
                <td><strong>${Craft.escapeHtml(c.representative)}</strong></td>
                <td>${c.count}</td>
                <td><small class="light">${c.queries.slice(0, 3).join(', ')}</small></td>
                <td>${c.lastSearched}</td>
                <td><a href="#" class="btn small">Create Content</a></td>
            </tr>`;
            tbody.append(row);
        });
    }

    // Date Range Handler (Reloads all data)
    $(document).on('click', '.main-date-range-option', function(e) {
        // ... (Existing logic, but simplified to just reload page for now to be safe with tabs)
        // Or re-implement to reload active tab
        // For V1, let's keep the existing logic but ensure it updates the current view
         e.preventDefault();
         const range = $(this).data('range');
         const url = new URL(window.location);
         url.searchParams.set('dateRange', range);
         window.location = url; // Simple reload to ensure all tabs get fresh data context
    });

{% endjs %}
