{% extends 'lindemannrock-base/_layouts/cp-table' %}

{% set plugin = craft.app.plugins.getPlugin('search-manager') %}
{% set settings = plugin.getSettings() %}

{# Get query parameters #}
{% set search = craft.app.request.getParam('search', '') %}
{% set statusFilter = craft.app.request.getParam('status', 'all') %}
{% set matchTypeFilter = craft.app.request.getParam('matchType', 'all') %}
{% set actionTypeFilter = craft.app.request.getParam('actionType', 'all') %}
{% set sort = craft.app.request.getParam('sort', 'priority') %}
{% set dir = craft.app.request.getParam('dir', 'asc') %}
{% set page = craft.app.request.getParam('page', 1)|number_format(0, '', '') %}
{% set limit = settings.itemsPerPage %}
{% set offset = (page - 1) * limit %}

{# Filter rules based on filters #}
{% set filteredRules = rules %}

{# Status filter #}
{% if statusFilter == 'enabled' %}
    {% set filteredRules = filteredRules|filter(r => r.enabled) %}
{% elseif statusFilter == 'disabled' %}
    {% set filteredRules = filteredRules|filter(r => not r.enabled) %}
{% endif %}

{# Match type filter #}
{% if matchTypeFilter != 'all' %}
    {% set filteredRules = filteredRules|filter(r => r.matchType == matchTypeFilter) %}
{% endif %}

{# Action type filter #}
{% if actionTypeFilter != 'all' %}
    {% set filteredRules = filteredRules|filter(r => r.actionType == actionTypeFilter) %}
{% endif %}

{# Search filter #}
{% if search %}
    {% set filteredRules = filteredRules|filter(r => search|lower in r.name|lower or search|lower in r.matchValue|lower) %}
{% endif %}

{# Sort #}
{% if sort == 'name' %}
    {% set filteredRules = dir == 'asc' ? filteredRules|sort((a, b) => a.name|lower <=> b.name|lower) : filteredRules|sort((a, b) => b.name|lower <=> a.name|lower) %}
{% elseif sort == 'matchValue' %}
    {% set filteredRules = dir == 'asc' ? filteredRules|sort((a, b) => a.matchValue|lower <=> b.matchValue|lower) : filteredRules|sort((a, b) => b.matchValue|lower <=> a.matchValue|lower) %}
{% elseif sort == 'matchType' %}
    {% set filteredRules = dir == 'asc' ? filteredRules|sort((a, b) => a.matchType <=> b.matchType) : filteredRules|sort((a, b) => b.matchType <=> a.matchType) %}
{% elseif sort == 'actionType' %}
    {% set filteredRules = dir == 'asc' ? filteredRules|sort((a, b) => a.actionType <=> b.actionType) : filteredRules|sort((a, b) => b.actionType <=> a.actionType) %}
{% elseif sort == 'priority' %}
    {% set filteredRules = dir == 'asc' ? filteredRules|sort((a, b) => a.priority <=> b.priority) : filteredRules|sort((a, b) => b.priority <=> a.priority) %}
{% elseif sort == 'enabled' %}
    {% set filteredRules = dir == 'asc' ? filteredRules|sort((a, b) => a.enabled <=> b.enabled) : filteredRules|sort((a, b) => b.enabled <=> a.enabled) %}
{% elseif sort == 'siteId' %}
    {% set filteredRules = dir == 'asc' ? filteredRules|sort((a, b) => (a.siteId ?? 0) <=> (b.siteId ?? 0)) : filteredRules|sort((a, b) => (b.siteId ?? 0) <=> (a.siteId ?? 0)) %}
{% endif %}

{# Pagination #}
{% set totalCount = filteredRules|length %}
{% set paginatedItems = filteredRules|slice(offset, limit) %}

{# Labels for badges #}
{% set matchTypeLabels = {
    'exact': 'Exact'|t('search-manager'),
    'contains': 'Contains'|t('search-manager'),
    'prefix': 'Starts With'|t('search-manager'),
    'regex': 'Regex'|t('search-manager'),
} %}

{% set actionTypeLabels = {
    'synonym': 'Synonyms'|t('search-manager'),
    'boost_section': 'Boost Section'|t('search-manager'),
    'boost_category': 'Boost Category'|t('search-manager'),
    'boost_element': 'Boost Element'|t('search-manager'),
    'filter': 'Filter'|t('search-manager'),
    'redirect': 'Redirect'|t('search-manager'),
} %}

{% set tableConfig = {
    plugin: {
        handle: 'search-manager',
        name: searchHelper.fullName,
    },
    page: {
        title: 'Query Rules'|t('search-manager'),
        subnav: 'query-rules',
        crumbs: [
            { label: searchHelper.fullName, url: url('search-manager') },
            { label: 'Query Rules'|t('search-manager'), url: url('search-manager/query-rules') }
        ],
    },
    filters: [
        {
            type: 'status',
            param: 'status',
            current: statusFilter,
            label: 'All'|t('search-manager'),
            groups: [
                {
                    param: 'status',
                    current: statusFilter,
                    options: [
                        {value: 'all', label: 'All'|t('search-manager'), status: 'all'},
                        {value: 'enabled', label: 'Enabled'|t('search-manager'), status: 'green'},
                        {value: 'disabled', label: 'Disabled'|t('search-manager'), status: 'disabled'},
                    ],
                },
                {
                    header: 'Match Type'|t('search-manager'),
                    param: 'matchType',
                    current: matchTypeFilter,
                    colorSet: 'matchType',
                    options: [
                        {value: 'all', label: 'All Types'|t('search-manager'), status: 'all'},
                        {value: 'exact', label: 'Exact Match'|t('search-manager'), colorKey: 'exact'},
                        {value: 'contains', label: 'Contains'|t('search-manager'), colorKey: 'contains'},
                        {value: 'prefix', label: 'Starts With'|t('search-manager'), colorKey: 'prefix'},
                        {value: 'regex', label: 'Regex'|t('search-manager'), colorKey: 'regex'},
                    ],
                },
                {
                    header: 'Action Type'|t('search-manager'),
                    param: 'actionType',
                    current: actionTypeFilter,
                    colorSet: 'actionType',
                    options: [
                        {value: 'all', label: 'All Actions'|t('search-manager'), status: 'all'},
                        {value: 'synonym', label: 'Synonyms'|t('search-manager'), colorKey: 'synonym'},
                        {value: 'boost_section', label: 'Boost Section'|t('search-manager'), colorKey: 'boost_section'},
                        {value: 'boost_category', label: 'Boost Category'|t('search-manager'), colorKey: 'boost_category'},
                        {value: 'boost_element', label: 'Boost Element'|t('search-manager'), colorKey: 'boost_element'},
                        {value: 'filter', label: 'Filter'|t('search-manager'), colorKey: 'filter'},
                        {value: 'redirect', label: 'Redirect'|t('search-manager'), colorKey: 'redirect'},
                    ],
                },
            ],
        },
    ],
    search: {
        placeholder: 'Search query rules...'|t('search-manager'),
        value: search,
    },
    sort: {
        field: sort,
        direction: dir,
    },
    table: {
        columns: [
            {key: 'name', label: 'Name'|t('search-manager'), sortable: true},
            {key: 'matchValue', label: 'Query Pattern'|t('search-manager'), sortable: true},
            {key: 'matchType', label: 'Match'|t('search-manager'), sortable: true, hideable: true},
            {key: 'actionType', label: 'Action'|t('search-manager'), sortable: true, hideable: true},
            {key: 'index', label: 'Index'|t('search-manager'), hideable: true},
            {key: 'siteId', label: 'Site'|t('search-manager'), sortable: true, hideable: true},
            {key: 'priority', label: 'Priority'|t('search-manager'), sortable: true, hideable: true},
            {key: 'enabled', label: 'Status'|t('search-manager'), sortable: true, hideable: true},
        ],
        items: paginatedItems,
        emptyMessage: 'No query rules found.'|t('search-manager'),
    },
    pagination: {
        page: page,
        limit: limit,
        totalCount: totalCount,
        itemLabel: {singular: 'rule'|t('search-manager'), plural: 'rules'|t('search-manager')},
    },
    checkboxes: currentUser.can('searchManager:editQueryRules') or currentUser.can('searchManager:deleteQueryRules'),
    newButton: {
        url: url('search-manager/query-rules/create'),
        label: 'New Query Rule'|t('search-manager'),
        permission: 'searchManager:createQueryRules',
    },
} %}

{% block tableRow %}
    {# Name #}
    <td data-column="name">
        <a class="label-link" href="{{ url('search-manager/query-rules/edit/' ~ item.id) }}">
            <span>{{ item.name }}</span>
        </a>
    </td>

    {# Query Pattern #}
    <td data-column="matchValue">
        <code>{{ item.matchValue }}</code>
    </td>

    {# Match Type #}
    <td data-column="matchType">
        {% include 'lindemannrock-base/_components/badge' with {
            label: matchTypeLabels[item.matchType] ?? item.matchType|capitalize,
            value: item.matchType,
            colorSet: 'matchType',
        } only %}
    </td>

    {# Action Type #}
    <td data-column="actionType">
        {% include 'lindemannrock-base/_components/badge' with {
            label: actionTypeLabels[item.actionType] ?? item.actionType|capitalize,
            value: item.actionType,
            colorSet: 'actionType',
        } only %}
    </td>

    {# Index #}
    <td data-column="index">
        {% if item.indexHandle %}
            {{ indexLookup[item.indexHandle] ?? item.indexHandle }}
        {% else %}
            <span class="light">{{ 'All'|t('search-manager') }}</span>
        {% endif %}
    </td>

    {# Site #}
    <td data-column="siteId">
        {% if item.siteId %}
            {% set site = craft.app.sites.getSiteById(item.siteId) %}
            {{ site ? site.name : 'Unknown' }}
        {% else %}
            <span class="light">{{ 'All Sites'|t('search-manager') }}</span>
        {% endif %}
    </td>

    {# Priority #}
    <td data-column="priority">
        <strong>{{ item.priority }}</strong>
    </td>

    {# Status #}
    <td data-column="enabled">
        {% if item.enabled %}
            {% include 'lindemannrock-base/_components/badge' with {
                label: 'Enabled'|t('search-manager'),
                value: 'enabled',
                colorSet: 'status',
            } only %}
        {% else %}
            {% include 'lindemannrock-base/_components/badge' with {
                label: 'Disabled'|t('search-manager'),
                value: 'disabled',
                colorSet: 'status',
            } only %}
        {% endif %}
    </td>
{% endblock %}

{% block rowActions %}
    {% include 'lindemannrock-base/_components/row-actions' with {
        item: item,
        actions: {
            type: 'menu',
            icon: 'settings',
            title: 'Actions'|t('app'),
            items: [
                {
                    label: 'Edit'|t('app'),
                    url: url('search-manager/query-rules/edit/' ~ item.id),
                    permission: 'searchManager:editQueryRules',
                },
                {
                    label: 'Delete'|t('app'),
                    class: 'error',
                    permission: 'searchManager:deleteQueryRules',
                    jsAction: 'delete',
                },
            ],
        },
    } only %}
{% endblock %}

{% block bulkActions %}
    {% if currentUser.can('searchManager:editQueryRules') %}
        <button type="button" class="btn menubtn secondary" id="lr-bulk-status-btn">
            {{ 'Set status'|t('app') }}
        </button>
        <div class="menu">
            <ul>
                <li><a id="lr-bulk-enable-action">{{ 'Enable'|t('search-manager') }}</a></li>
                <li><a id="lr-bulk-disable-action">{{ 'Disable'|t('search-manager') }}</a></li>
            </ul>
        </div>
    {% endif %}

    {% if currentUser.can('searchManager:deleteQueryRules') %}
        <button type="button" class="btn secondary" id="lr-bulk-delete-btn">
            {{ 'Delete'|t('search-manager') }} (<span id="lr-selected-count">0</span>)
        </button>
    {% endif %}
{% endblock %}

{% block scripts %}
<script>
(function() {
    // Initialize bulk status menu
    const bulkStatusBtn = document.getElementById('lr-bulk-status-btn');
    if (bulkStatusBtn && typeof Craft !== 'undefined' && Craft.MenuBtn) {
        new Craft.MenuBtn(bulkStatusBtn);
    }

    // Bulk enable
    document.getElementById('lr-bulk-enable-action')?.addEventListener('click', function(e) {
        e.preventDefault();
        const ids = window.lrTableSelection.getSelectedIds();
        if (ids.length === 0) return;

        Craft.sendActionRequest('POST', 'search-manager/query-rules/bulk-enable', {
            data: { ruleIds: ids }
        }).then(function(response) {
            if (response.data.success) {
                Craft.cp.displayNotice(Craft.t('search-manager', 'Enabled {count} query rules', {count: response.data.count}));
                setTimeout(() => window.location.reload(), 1000);
            }
        }).catch(function(error) {
            Craft.cp.displayError(Craft.t('search-manager', 'Failed to enable query rules'));
        });
    });

    // Bulk disable
    document.getElementById('lr-bulk-disable-action')?.addEventListener('click', function(e) {
        e.preventDefault();
        const ids = window.lrTableSelection.getSelectedIds();
        if (ids.length === 0) return;

        Craft.sendActionRequest('POST', 'search-manager/query-rules/bulk-disable', {
            data: { ruleIds: ids }
        }).then(function(response) {
            if (response.data.success) {
                Craft.cp.displayNotice(Craft.t('search-manager', 'Disabled {count} query rules', {count: response.data.count}));
                setTimeout(() => window.location.reload(), 1000);
            }
        }).catch(function(error) {
            Craft.cp.displayError(Craft.t('search-manager', 'Failed to disable query rules'));
        });
    });

    // Bulk delete
    document.getElementById('lr-bulk-delete-btn')?.addEventListener('click', function() {
        const ids = window.lrTableSelection.getSelectedIds();
        if (ids.length === 0) return;

        if (!confirm(Craft.t('search-manager', 'Delete {count} query rule(s)? This cannot be undone.', {count: ids.length}))) return;

        Craft.sendActionRequest('POST', 'search-manager/query-rules/bulk-delete', {
            data: { ruleIds: ids }
        }).then(function(response) {
            if (response.data.success) {
                Craft.cp.displayNotice(Craft.t('search-manager', 'Deleted {count} query rules', {count: response.data.count}));
                setTimeout(() => window.location.reload(), 1000);
            }
        }).catch(function(error) {
            Craft.cp.displayError(Craft.t('search-manager', 'Failed to delete query rules'));
        });
    });

    // Individual delete action
    document.querySelectorAll('[data-action="delete"]').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const row = this.closest('tr');
            const id = row?.dataset.id;
            const name = row?.dataset.name || '';

            if (!id) return;

            if (!confirm(Craft.t('search-manager', 'Delete query rule "{name}"? This cannot be undone.', {name: name}))) return;

            Craft.sendActionRequest('POST', 'search-manager/query-rules/delete', {
                data: { ruleId: id }
            }).then(function(response) {
                if (response.data.success) {
                    Craft.cp.displayNotice(Craft.t('search-manager', 'Query rule deleted'));
                    setTimeout(() => window.location.reload(), 1000);
                }
            }).catch(function(error) {
                Craft.cp.displayError(Craft.t('search-manager', 'Failed to delete query rule'));
            });
        });
    });

    // Update selected count
    document.addEventListener('lr:selectionChanged', function(e) {
        const countSpan = document.getElementById('lr-selected-count');
        if (countSpan) {
            countSpan.textContent = e.detail.count;
        }
    });
})();
</script>
{% endblock %}
