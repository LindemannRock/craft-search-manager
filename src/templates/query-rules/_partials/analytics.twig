{% set plugin = craft.app.plugins.getPlugin('search-manager') %}
{% set pluginHandle = pluginHandle ?? plugin.id %}
{% set dateRange = craft.app.request.getQueryParam('range') ?? lrDefaultDateRange(pluginHandle) %}

{# Get analytics data for this rule #}
{% set analytics = craft.searchManager.getRuleAnalytics(rule.id, dateRange) %}

{% embed 'lindemannrock-base/_partials/analytics-panel' with {
    config: {
        pluginHandle: pluginHandle,
        dateRange: {
            enabled: true,
            current: dateRange,
            param: 'range',
            hash: 'analytics',
        },
        export: {
            action: 'search-manager/analytics/export-rule-analytics',
            permission: 'searchManager:exportAnalytics',
            extraParams: {ruleId: rule.id},
        },
    }
} %}
    {% block content %}
        {% if analytics.totalTriggers == 0 %}
            <div class="lr-analytics-empty">
                <p>{{ "No analytics data yet"|t('search-manager') }}</p>
                <p class="light">{{ "Analytics will appear here once this rule starts being triggered by searches."|t('search-manager') }}</p>
            </div>
        {% else %}
            <div class="lr-unified-cards">
                {% include 'lindemannrock-base/_components/cards/unified-card' with {
                    value: analytics.totalTriggers|number,
                    description: 'Times Triggered'|t('search-manager'),
                    align: 'center',
                } only %}

                {% include 'lindemannrock-base/_components/cards/unified-card' with {
                    value: analytics.uniqueQueries|number,
                    description: 'Unique Queries'|t('search-manager'),
                    align: 'center',
                } only %}

                {% include 'lindemannrock-base/_components/cards/unified-card' with {
                    value: analytics.avgResultsAfter|number(1),
                    description: 'Avg Results After'|t('search-manager'),
                    align: 'center',
                } only %}

                {% if rule.actionType == 'redirect' %}
                    {% include 'lindemannrock-base/_components/cards/unified-card' with {
                        value: analytics.totalTriggers|number,
                        description: 'Redirects'|t('search-manager'),
                        align: 'center',
                    } only %}
                {% endif %}
            </div>

            {% if analytics.topQueries|length %}
                <h2 class="lr-section-heading">{{ "Top Queries Triggering This Rule"|t('search-manager') }}</h2>
                <div class="lr-chart-container">
                    <div class="lr-table-scroll">
                        <table class="data fullwidth">
                            <thead>
                                <tr>
                                    <th>{{ 'Query'|t('search-manager') }}</th>
                                    <th>{{ 'Times Triggered'|t('search-manager') }}</th>
                                    <th>{{ 'Avg Results'|t('search-manager') }}</th>
                                    <th>{{ 'Last Triggered'|t('search-manager') }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in analytics.topQueries %}
                                    <tr>
                                        <td><code>{{ item.query }}</code></td>
                                        <td>{{ item.count|number }}</td>
                                        <td>{{ item.avgResults|number(1) }}</td>
                                        <td>{{ item.lastTriggered|date('short') }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            {% endif %}

            {% if analytics.dailyTriggers|length %}
                <h2 class="lr-section-heading">{{ "Daily Triggers"|t('search-manager') }}</h2>
                <div class="lr-chart-container">
                    <div class="lr-chart-height-250">
                        <canvas id="rule-daily-chart" class="lr-chart-canvas"></canvas>
                    </div>
                </div>

                <script data-analytics-reinit="true">
                (function() {
                    function initRuleDailyChart() {
                        if (typeof Chart === 'undefined') return;
                        window.ruleCharts = window.ruleCharts || {};
                        if (window.ruleCharts.dailyChart) {
                            window.ruleCharts.dailyChart.destroy();
                        }

                        const ctx = document.getElementById('rule-daily-chart');
                        if (!ctx) return;
                        const dailyData = {{ analytics.dailyTriggers|json_encode|raw }};
                        window.ruleCharts.dailyChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: dailyData.map(d => d.date),
                                datasets: [{
                                    label: '{{ "Triggers"|t('search-manager') }}',
                                    data: dailyData.map(d => d.count),
                                    borderColor: '#0d78f2',
                                    backgroundColor: 'rgba(13, 120, 242, 0.1)',
                                    fill: true,
                                    tension: 0.3
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { display: false } },
                                scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                            }
                        });
                        ctx.style.width = '100%';
                        ctx.style.height = '100%';
                }

                    if (typeof Chart !== 'undefined') {
                        initRuleDailyChart();
                    }
                    document.addEventListener('lr:panelChartsReady', initRuleDailyChart, { once: true });
                })();
                </script>
            {% endif %}

            {% if analytics.recentTriggers|length %}
                <h2 class="lr-section-heading">{{ "Recent Triggers (Last 20)"|t('search-manager') }}</h2>
                <div class="lr-chart-container">
                    <div class="lr-table-scroll">
                        <table class="data fullwidth">
                            <thead>
                                <tr>
                                    <th>{{ 'Date'|t('search-manager') }}</th>
                                    <th>{{ 'Time'|t('search-manager') }}</th>
                                    <th>{{ 'Query'|t('search-manager') }}</th>
                                    <th>{{ 'Index'|t('search-manager') }}</th>
                                    <th>{{ 'Site'|t('search-manager') }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for trigger in analytics.recentTriggers %}
                                    <tr>
                                        <td>{{ trigger.dateCreated|date('short') }}</td>
                                        <td>{{ trigger.dateCreated|time('short') }}</td>
                                        <td><code>{{ trigger.query }}</code></td>
                                        <td>{{ trigger.indexHandle ?? '—' }}</td>
                                        <td>
                                            {% if trigger.siteId %}
                                                {% set site = craft.app.sites.getSiteById(trigger.siteId) %}
                                                {{ site ? site.name : '—' }}
                                            {% else %}
                                                —
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            {% endif %}
        {% endif %}
    {% endblock %}
{% endembed %}
