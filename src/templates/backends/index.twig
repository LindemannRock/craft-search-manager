{#
 # Backends Index - Using cp-table layout
 #
 # This template extends the base plugin's cp-table layout to provide
 # a consistent interface for viewing search backends with filters, sorting,
 # and bulk actions.
 #
 # @link      https://lindemannrock.com
 # @copyright Copyright (c) 2026 LindemannRock
 #}

{% extends 'lindemannrock-base/_layouts/cp-table' %}

{# ============================================================================
   PERMISSION CHECKS
   ============================================================================ #}

{% set canCreate = currentUser.can('searchManager:createBackends') %}
{% set canEdit = currentUser.can('searchManager:editBackends') %}
{% set canDelete = currentUser.can('searchManager:deleteBackends') %}

{# ============================================================================
   GET QUERY PARAMETERS
   ============================================================================ #}

{% set search = craft.app.request.getParam('search', '') %}
{% set statusFilter = craft.app.request.getParam('status', 'all') %}
{% set typeFilter = craft.app.request.getParam('type', 'all') %}
{% set sourceFilter = craft.app.request.getParam('source', 'all') %}
{% set sort = craft.app.request.getParam('sort', 'name') %}
{% set dir = craft.app.request.getParam('dir', 'asc') %}
{% set page = craft.app.request.getParam('page', 1)|number_format(0, '', '') %}
{% set limit = settings.itemsPerPage ?? 50 %}
{% set offset = (page - 1) * limit %}

{# ============================================================================
   FILTER BACKENDS
   ============================================================================ #}

{% set filteredBackends = backends %}

{# Status filter #}
{% if statusFilter == 'enabled' %}
    {% set filteredBackends = filteredBackends|filter(b => b.enabled) %}
{% elseif statusFilter == 'disabled' %}
    {% set filteredBackends = filteredBackends|filter(b => not b.enabled) %}
{% endif %}

{# Type filter #}
{% if typeFilter != 'all' %}
    {% set filteredBackends = filteredBackends|filter(b => b.backendType == typeFilter) %}
{% endif %}

{# Source filter #}
{% if sourceFilter == 'config' %}
    {% set filteredBackends = filteredBackends|filter(b => b.source == 'config') %}
{% elseif sourceFilter == 'database' %}
    {% set filteredBackends = filteredBackends|filter(b => b.source != 'config') %}
{% endif %}

{# Search filter #}
{% if search %}
    {% set filteredBackends = filteredBackends|filter(b => search|lower in b.name|lower or search|lower in b.handle|lower or search|lower in b.backendType|lower) %}
{% endif %}

{# Sort backends #}
{% if sort == 'name' %}
    {% set filteredBackends = filteredBackends|sort((a, b) => dir == 'asc' ? a.name|lower <=> b.name|lower : b.name|lower <=> a.name|lower) %}
{% elseif sort == 'handle' %}
    {% set filteredBackends = filteredBackends|sort((a, b) => dir == 'asc' ? a.handle|lower <=> b.handle|lower : b.handle|lower <=> a.handle|lower) %}
{% elseif sort == 'type' %}
    {% set filteredBackends = filteredBackends|sort((a, b) => dir == 'asc' ? a.backendType|lower <=> b.backendType|lower : b.backendType|lower <=> a.backendType|lower) %}
{% elseif sort == 'source' %}
    {% set filteredBackends = filteredBackends|sort((a, b) => dir == 'asc' ? (a.source ?? '') <=> (b.source ?? '') : (b.source ?? '') <=> (a.source ?? '')) %}
{% elseif sort == 'enabled' %}
    {% set filteredBackends = filteredBackends|sort((a, b) => dir == 'asc' ? a.enabled <=> b.enabled : b.enabled <=> a.enabled) %}
{% endif %}

{% set totalCount = filteredBackends|length %}
{% set paginatedBackends = filteredBackends|slice(offset, limit) %}


{# ============================================================================
   TABLE CONFIGURATION
   ============================================================================ #}

{% set tableConfig = {
    plugin: {
        handle: 'search-manager',
        name: searchHelper.fullName,
    },
    page: {
        title: 'Backends'|t('search-manager'),
        subnav: 'backends',
        crumbs: [
            { label: searchHelper.fullName, url: url('search-manager') },
            { label: 'Backends'|t('search-manager'), url: url('search-manager/backends') }
        ],
    },
    filters: [
        {
            type: 'status',
            param: 'status',
            current: statusFilter,
            label: 'All'|t('search-manager'),
            groups: [
                {
                    param: 'status',
                    current: statusFilter,
                    colorSet: 'status',
                    options: [
                        {value: 'all', label: 'All'|t('search-manager'), status: 'all'},
                        {value: 'enabled', label: 'Enabled'|t('search-manager'), colorKey: 'enabled'},
                        {value: 'disabled', label: 'Disabled'|t('search-manager'), colorKey: 'disabled'},
                    ],
                },
                {
                    header: 'Backend Type'|t('search-manager'),
                    param: 'type',
                    current: typeFilter,
                    colorSet: 'backendType',
                    options: [
                        {value: 'all', label: 'All Types'|t('search-manager'), status: 'all'},
                        {value: 'algolia', label: 'Algolia'|t('search-manager'), colorKey: 'algolia'},
                        {value: 'meilisearch', label: 'Meilisearch'|t('search-manager'), colorKey: 'meilisearch'},
                        {value: 'typesense', label: 'Typesense'|t('search-manager'), colorKey: 'typesense'},
                        {value: 'mysql', label: 'MySQL'|t('search-manager'), colorKey: 'mysql'},
                        {value: 'pgsql', label: 'PostgreSQL'|t('search-manager'), colorKey: 'pgsql'},
                        {value: 'redis', label: 'Redis'|t('search-manager'), colorKey: 'redis'},
                        {value: 'file', label: 'File'|t('search-manager'), colorKey: 'file'},
                    ],
                },
                {
                    header: 'Config Source'|t('search-manager'),
                    param: 'source',
                    current: sourceFilter,
                    colorSet: 'configSource',
                    options: [
                        {value: 'all', label: 'All Sources'|t('search-manager'), status: 'all'},
                        {value: 'config', label: 'Config File'|t('search-manager'), colorKey: 'config'},
                        {value: 'database', label: 'Database'|t('search-manager'), colorKey: 'database'},
                    ],
                },
            ],
        },
    ],
    search: {
        placeholder: 'Search backends...'|t('search-manager'),
        value: search,
    },
    sort: {
        field: sort,
        direction: dir,
    },
    table: {
        columns: [
            {key: 'name', label: 'Name'|t('search-manager'), sortable: true},
            {key: 'handle', label: 'Handle'|t('search-manager'), sortable: true},
            {key: 'type', label: 'Type'|t('search-manager'), sortable: true},
            {key: 'source', label: 'Source'|t('search-manager'), sortable: true},
            {key: 'enabled', label: 'Status'|t('search-manager'), sortable: true},
            {key: 'default', label: 'Default'|t('search-manager')},
        ],
        items: paginatedBackends,
        emptyMessage: 'No backends found.'|t('search-manager'),
        hasConfigItems: true,
    },
    pagination: {
        page: page,
        limit: limit,
        totalCount: totalCount,
        itemLabel: {singular: 'backend'|t('search-manager'), plural: 'backends'|t('search-manager')},
    },
    checkboxes: canEdit or canDelete,
    newButton: canCreate ? {
        url: url('search-manager/backends/new'),
        label: 'New Backend'|t('search-manager'),
        permission: 'searchManager:createBackends',
    } : null,
} %}


{# ============================================================================
   BEFORE TABLE - Warning messages
   ============================================================================ #}

{% block beforeTable %}
    {# Warning if default backend is missing or disabled #}
    {% if defaultBackendHandle %}
        {% set defaultBackend = backends|filter(b => b.handle == defaultBackendHandle)|first %}
        {% if not defaultBackend %}
            {# Default backend doesn't exist #}
            {% set warningMessage %}
            <strong>{{ 'Warning'|t('search-manager') }}:</strong>
            {{ 'The default backend handle "{handle}" does not exist.'|t('search-manager', {handle: '<strong>' ~ defaultBackendHandle ~ '</strong>'})|raw }}
            {% if isDefaultFromConfig %}
                {{ 'Update your config/search-manager.php to point to a valid backend handle.'|t('search-manager') }}
            {% else %}
                {{ 'Please set a different backend as default.'|t('search-manager') }}
            {% endif %}
            {% endset %}
            <div class="lr-info-box-table-wrapper">
                {% include 'lindemannrock-base/_components/info-box' with {
                    message: warningMessage,
                    type: 'warning',
                    margin: 'none',
                    stretch: true,
                } %}
            </div>
        {% elseif not defaultBackend.enabled %}
            {# Default backend exists but is disabled #}
            {% set warningMessage %}
            <strong>{{ 'Warning'|t('search-manager') }}:</strong>
            {{ 'The default backend "{name}" is disabled. Search functionality may not work.'|t('search-manager', {name: '<strong>' ~ defaultBackend.name ~ '</strong>'})|raw }}
            {% if not isDefaultFromConfig %}
                {{ 'Please enable it or set a different backend as default.'|t('search-manager') }}
            {% else %}
                {{ 'Update your config/search-manager.php to fix this.'|t('search-manager') }}
            {% endif %}
            {% endset %}
            <div class="lr-info-box-table-wrapper">
                {% include 'lindemannrock-base/_components/info-box' with {
                    message: warningMessage,
                    type: 'warning',
                    margin: 'none',
                    stretch: true,
                } %}
            </div>
        {% endif %}
    {% elseif backends|length > 0 %}
        {# No default handle set but backends exist #}
        {% set warningMessage %}
        <strong>{{ 'Warning'|t('search-manager') }}:</strong>
        {{ 'No default backend is configured. Please set one of the backends as default.'|t('search-manager') }}
        {% endset %}
        <div class="lr-info-box-table-wrapper">
            {% include 'lindemannrock-base/_components/info-box' with {
                message: warningMessage,
                type: 'warning',
                margin: 'none',
                stretch: true,
            } %}
        </div>
    {% endif %}

    {# Warning for handle collisions between config and database #}
    {% if collisionHandles is defined and collisionHandles|length %}
        {% set boldHandles = [] %}
        {% for handle in collisionHandles %}
            {% set boldHandles = boldHandles|merge(['<strong>' ~ handle ~ '</strong>']) %}
        {% endfor %}
        {% set warningMessage %}
        <strong>{{ 'Warning'|t('search-manager') }}:</strong>
        {{ 'These backend handles exist in both config/search-manager.php and the database:'|t('search-manager') }} {{ boldHandles|join(', ')|raw }}.
        {{ 'Config takes precedence; database entries with the same handle are ignored.'|t('search-manager') }}
        {{ 'Update your config/search-manager.php or remove the database entries to resolve this.'|t('search-manager') }}
        {% endset %}
        <div class="lr-info-box-table-wrapper">
            {% include 'lindemannrock-base/_components/info-box' with {
                message: warningMessage,
                type: 'warning',
                margin: 'none',
                stretch: true,
            } %}
        </div>
    {% endif %}
{% endblock %}


{# ============================================================================
   BULK ACTIONS (shown when items selected)
   ============================================================================ #}

{% block bulkActions %}
    {% if canEdit %}
        <div class="btngroup">
            <button type="button" class="btn menubtn secondary" id="lr-bulk-status-btn">
                {{ 'Set status'|t('app') }}
            </button>
            <div class="menu">
                <ul>
                    <li><a id="lr-bulk-enable-action">{{ 'Enable'|t('search-manager') }}</a></li>
                    <li><a id="lr-bulk-disable-action">{{ 'Disable'|t('search-manager') }}</a></li>
                </ul>
            </div>
        </div>
    {% endif %}
    {% if canDelete %}
        <button type="button" class="btn secondary" id="lr-bulk-delete-btn">
            {{ 'Delete'|t('app') }} (<span id="lr-selected-count">0</span>)
        </button>
    {% endif %}
{% endblock %}


{# ============================================================================
   ROW ACTIONS (per-row menu)
   ============================================================================ #}

{% block rowActions %}
    {% set isConfig = item.isFromConfig() %}
    {% set isDefault = defaultBackendHandle == item.handle %}

    <td class="thin lr-text-end">
        <button type="button" class="btn menubtn" data-icon="settings" title="{{ 'Actions'|t('app') }}"></button>
        <div class="menu">
            <ul>
                {% if item.canEdit() %}
                    {% if canEdit %}
                        <li>
                            <a href="{{ url('search-manager/backends/' ~ item.id) }}">
                                {{ 'Edit'|t('app') }}
                            </a>
                        </li>
                    {% endif %}
                {% else %}
                    <li>
                        <a href="{{ url('search-manager/backends/view/' ~ item.handle) }}">
                            {{ 'View'|t('app') }}
                        </a>
                    </li>
                {% endif %}
                <li><hr class="padded"></li>
                <li>
                    <a class="lr-backend-action" data-action="test" data-id="{{ item.id ?: item.handle }}" data-name="{{ item.name }}">
                        {{ 'Test Connection'|t('search-manager') }}
                    </a>
                </li>
                {% if canEdit and not isDefaultFromConfig and not isDefault %}
                    <li>
                        <a class="lr-backend-action" data-action="set-default" data-id="{{ item.id ?: item.handle }}" data-name="{{ item.name }}">
                            {{ 'Set as Default'|t('search-manager') }}
                        </a>
                    </li>
                {% endif %}
                {% if canDelete and item.canEdit() and not isDefault %}
                    <li><hr class="padded"></li>
                    <li>
                        <a class="lr-backend-action error" data-action="delete" data-id="{{ item.id ?: item.handle }}" data-name="{{ item.name }}">
                            {{ 'Delete'|t('app') }}
                        </a>
                    </li>
                {% endif %}
            </ul>
        </div>
    </td>
{% endblock %}


{# ============================================================================
   CUSTOM TABLE ROW RENDERING
   ============================================================================ #}

{% block tableRow %}
    {% set isConfig = item.isFromConfig() %}

    {# Name #}
    <td>
        {% if item.canEdit() %}
            <a class="label-link" href="{{ url('search-manager/backends/' ~ item.id) }}">
                <span>{{ item.name }}</span>
            </a>
        {% else %}
            <a class="label-link" href="{{ url('search-manager/backends/view/' ~ item.handle) }}">
                <span>{{ item.name }}</span>
            </a>
            <span class="lr-config-info-icon" data-config="{{ item.rawConfigDisplay|e('html_attr') }}" data-config-source="config/search-manager.php"></span>
        {% endif %}
    </td>

    {# Handle #}
    <td><code>{{ item.handle }}</code></td>

    {# Type badge #}
    <td>
        {% include 'lindemannrock-base/_components/badge' with {
            label: item.getTypeLabel(),
            value: item.backendType,
            colorSet: 'backendType',
        } only %}
    </td>

    {# Source badge #}
    <td>
        {% include 'lindemannrock-base/_components/badge' with {
            label: item.source|capitalize,
            value: item.source,
            colorSet: 'configSource',
        } only %}
    </td>

    {# Status badge #}
    <td>
        {% include 'lindemannrock-base/_components/badge' with {
            label: item.enabled ? 'Enabled'|t('search-manager') : 'Disabled'|t('search-manager'),
            value: item.enabled ? 'enabled' : 'disabled',
            colorSet: 'status',
        } only %}
    </td>

    {# Default indicator #}
    <td>
        {% if defaultBackendHandle == item.handle %}
            {% include 'lindemannrock-base/_components/badge' with {
                label: 'Yes'|t('search-manager'),
                value: 'yes',
                colorSet: 'yesNo',
            } only %}
        {% else %}
            <span class="light">-</span>
        {% endif %}
    </td>
{% endblock %}


{# ============================================================================
   CUSTOM SCRIPTS
   ============================================================================ #}

{% block scripts %}
    <script>
    (function() {
        // Highlight rows with handle collisions
        const collisionHandles = {{ collisionHandles|default([])|json_encode|raw }};
        if (collisionHandles.length > 0) {
            document.querySelectorAll('#lr-data-table tbody tr.lr-data-row').forEach(row => {
                const handleCell = row.querySelector('td:nth-child(3) code');
                if (handleCell && collisionHandles.includes(handleCell.textContent.trim())) {
                    row.classList.add('lr-row--warning');
                }
            });
        }

        // Update selected count when selection changes
        document.addEventListener('lr:selectionChanged', function(e) {
            const countSpan = document.getElementById('lr-selected-count');
            if (countSpan) {
                countSpan.textContent = e.detail.count;
            }
        });

        // Bulk enable
        document.getElementById('lr-bulk-enable-action')?.addEventListener('click', function(e) {
            e.preventDefault();
            if (!window.lrTableSelection) return;

            const ids = window.lrTableSelection.getSelectedIds();
            if (ids.length === 0) return;

            Craft.sendActionRequest('POST', 'search-manager/backends/bulk-enable', {
                data: { backendIds: ids }
            }).then(function(response) {
                if (response.data.count > 0) {
                    Craft.cp.displayNotice('{{ "Enabled {count} backends"|t("search-manager")|e("js") }}'.replace('{count}', response.data.count));
                }
                if (response.data.errors && response.data.errors.length > 0) {
                    response.data.errors.forEach(err => Craft.cp.displayError(err));
                }
                if (response.data.count > 0) {
                    setTimeout(() => window.location.reload(), 1000);
                }
            }).catch(function(error) {
                Craft.cp.displayError('{{ "Failed to enable backends"|t("search-manager")|e("js") }}');
            });
        });

        // Bulk disable
        document.getElementById('lr-bulk-disable-action')?.addEventListener('click', function(e) {
            e.preventDefault();
            if (!window.lrTableSelection) return;

            const ids = window.lrTableSelection.getSelectedIds();
            if (ids.length === 0) return;

            Craft.sendActionRequest('POST', 'search-manager/backends/bulk-disable', {
                data: { backendIds: ids }
            }).then(function(response) {
                if (response.data.count > 0) {
                    Craft.cp.displayNotice('{{ "Disabled {count} backends"|t("search-manager")|e("js") }}'.replace('{count}', response.data.count));
                }
                if (response.data.errors && response.data.errors.length > 0) {
                    response.data.errors.forEach(err => Craft.cp.displayError(err));
                } else if (response.data.error) {
                    Craft.cp.displayError(response.data.error);
                }
                if (response.data.count > 0) {
                    setTimeout(() => window.location.reload(), 1000);
                }
            }).catch(function(error) {
                Craft.cp.displayError('{{ "Failed to disable backends"|t("search-manager")|e("js") }}');
            });
        });

        // Bulk delete
        document.getElementById('lr-bulk-delete-btn')?.addEventListener('click', function(e) {
            e.preventDefault();
            if (!window.lrTableSelection) return;

            const ids = window.lrTableSelection.getSelectedIds();
            const count = window.lrTableSelection.getCount();

            if (count === 0) return;

            if (!confirm('{{ "Delete {count} backend(s)? This cannot be undone."|t("search-manager")|e("js") }}'.replace('{count}', count))) {
                return;
            }

            Craft.sendActionRequest('POST', 'search-manager/backends/bulk-delete', {
                data: { backendIds: ids }
            }).then(function(response) {
                if (response.data.count > 0) {
                    Craft.cp.displayNotice('{{ "Deleted {count} backends"|t("search-manager")|e("js") }}'.replace('{count}', response.data.count));
                }
                if (response.data.errors && response.data.errors.length > 0) {
                    response.data.errors.forEach(err => Craft.cp.displayError(err));
                } else if (response.data.error) {
                    Craft.cp.displayError(response.data.error);
                }
                if (response.data.count > 0) {
                    setTimeout(() => window.location.reload(), 1000);
                }
            }).catch(function(error) {
                Craft.cp.displayError('{{ "Failed to delete backends"|t("search-manager")|e("js") }}');
            });
        });

        // Individual backend action menu clicks
        document.querySelectorAll('.lr-backend-action').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();

                const action = this.dataset.action;
                const backendId = this.dataset.id;
                const backendName = this.dataset.name;

                if (action === 'test') {
                    Craft.sendActionRequest('POST', 'search-manager/backends/test', {
                        data: { backendId: backendId }
                    }).then(function(response) {
                        if (response.data.success) {
                            Craft.cp.displayNotice('{{ "Connection successful"|t("search-manager")|e("js") }}: ' + backendName);
                        } else {
                            Craft.cp.displayError('{{ "Connection failed"|t("search-manager")|e("js") }}: ' + (response.data.error || '{{ "Unknown error"|t("search-manager")|e("js") }}'));
                        }
                    }).catch(function(error) {
                        Craft.cp.displayError('{{ "Connection test failed"|t("search-manager")|e("js") }}');
                    });
                } else if (action === 'set-default') {
                    Craft.sendActionRequest('POST', 'search-manager/backends/set-default', {
                        data: { backendId: backendId }
                    }).then(function(response) {
                        if (response.data.success) {
                            Craft.cp.displayNotice('{{ "Default backend updated"|t("search-manager")|e("js") }}');
                            setTimeout(() => window.location.reload(), 500);
                        } else {
                            Craft.cp.displayError(response.data.error || '{{ "Failed to update default backend"|t("search-manager")|e("js") }}');
                        }
                    }).catch(function(error) {
                        Craft.cp.displayError('{{ "Failed to update default backend"|t("search-manager")|e("js") }}');
                    });
                } else if (action === 'delete') {
                    if (confirm('{{ "Delete backend \"{name}\"? This cannot be undone."|t("search-manager")|e("js") }}'.replace('{name}', backendName))) {
                        Craft.sendActionRequest('POST', 'search-manager/backends/delete', {
                            data: { backendId: backendId }
                        }).then(function(response) {
                            if (response.data.success) {
                                Craft.cp.displayNotice('{{ "Backend deleted"|t("search-manager")|e("js") }}');
                                setTimeout(() => window.location.reload(), 1000);
                            } else if (response.data.error) {
                                Craft.cp.displayError(response.data.error);
                            }
                        }).catch(function(error) {
                            Craft.cp.displayError('{{ "Failed to delete backend"|t("search-manager")|e("js") }}');
                        });
                    }
                }
            });
        });
    })();
    </script>
{% endblock %}
