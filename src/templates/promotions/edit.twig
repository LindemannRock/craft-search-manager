{% extends "_layouts/cp" %}
{% import "_includes/forms" as forms %}

{% set plugin = craft.app.plugins.getPlugin('search-manager') %}
{% set title = isNew ? 'New Promotion'|t('search-manager') : 'Edit Promotion'|t('search-manager') %}
{% set fullPageForm = true %}
{% set selectedSubnavItem = 'promotions' %}
{% set saveShortcutRedirect = cpUrl('search-manager/promotions/edit/{id}') %}
{% set retainScrollOnSaveShortcut = true %}

{% set crumbs = [
    { label: searchHelper.fullName, url: url('search-manager') },
    { label: 'Promotions'|t('search-manager'), url: url('search-manager/promotions') },
    { label: isNew ? 'New Promotion'|t('search-manager') : promotion.title }
] %}

{# Set up tabs #}
{% set tabs = {
    fields: {
        label: 'Settings'|t('search-manager'),
        url: '#fields',
    },
} %}

{# Add analytics tab if promotion exists and analytics are enabled #}
{% if not isNew and plugin.settings.enableAnalytics %}
    {% set tabs = tabs|merge({
        analytics: {
            label: 'Analytics'|t('search-manager'),
            url: '#analytics',
        },
    }) %}
{% endif %}

{% block actionButton %}
	<div class="btngroup submit">
		<button type="submit" class="btn submit">{{ "Save"|t('app') }}</button>
		<button type="button" class="btn submit menubtn"></button>
		<div class="menu">
			<ul role="listbox">
				<li>
					<a class="formsubmit" role="option" tabindex="0" data-redirect="{{ cpUrl('search-manager/promotions/edit/{id}')|hash }}">
						<span class="label">{{ 'Save and continue editing'|t('app') }}</span>
						<span class="shortcut" id="save-shortcut"></span>
					</a>
				</li>
			</ul>
		</div>
	</div>
	{% if not isNew and currentUser.can('searchManager:deletePromotions') %}
		<button type="button" id="action-btn" class="btn menubtn action-btn hairline-dark m" title="{{ 'Actions'|t('app') }}" aria-controls="action-menu" aria-label="{{ 'Actions'|t('app') }}" data-disclosure-trigger="true" aria-expanded="false"></button>
		<div id="action-menu" class="menu menu--disclosure">
			<ul>
				<li>
					<button class="menu-item error formsubmit" data-destructive data-action="search-manager/promotions/delete" data-params='{"promotionId":{{ promotion.id }}}' data-confirm="{{ 'Are you sure you want to delete this promotion?'|t('search-manager') }}" data-redirect="{{ 'search-manager/promotions'|hash }}" data-headers='{"Accept":"application/json"}'>
						<span class="icon">{{ svg('@app/icons/trash.svg') }}</span>
						<span class="menu-item-label">{{ "Delete"|t('app') }}</span>
					</button>
				</li>
			</ul>
		</div>
	{% endif %}
{% endblock %}

{% block content %}
	<input type="hidden" name="action" value="search-manager/promotions/save">
	<input type="hidden" name="redirect" value="{{ 'search-manager/promotions'|hash }}">
	{% if not isNew %}
		<input type="hidden" name="promotionId" value="{{ promotion.id }}">
	{% endif %}
	{{ csrfInput() }}

	<div id="fields">
		{{ forms.textField({
			first: true,
			label: 'Title'|t('search-manager'),
			instructions: 'A descriptive name to help identify this promotion.'|t('search-manager'),
			id: 'title',
			name: 'title',
			value: promotion.title,
			placeholder: 'e.g., Holiday Sale Banner'|t('search-manager'),
			errors: promotion.getErrors('title'),
		}) }}

		{{ forms.selectField({
			label: 'Index'|t('search-manager'),
			instructions: 'Which search index does this promotion apply to?'|t('search-manager'),
			id: 'indexHandle',
			name: 'indexHandle',
			options: indexOptions,
			value: promotion.indexHandle,
			required: true,
			errors: promotion.getErrors('indexHandle'),
		}) }}

		<hr>

		<div class="field">
			<div class="heading">
				<label for="matchType">{{ 'Match Type'|t('search-manager') }}
					<span class="required" aria-label="Required"></span>
				</label>
				<div class="instructions">
					<p id="matchTypeInstructions">
						{% if promotion.matchType == 'contains' %}
							{{ 'Match if the search query contains this pattern anywhere.'|t('search-manager') }}
						{% elseif promotion.matchType == 'prefix' %}
							{{ 'Match if the search query starts with this pattern.'|t('search-manager') }}
						{% else %}
							{{ 'Match only if the search query exactly matches this pattern.'|t('search-manager') }}
						{% endif %}
					</p>
				</div>
			</div>
			<div class="input">
				<div class="select">
					<select id="matchType" name="matchType" required>
						<option value="exact" {% if promotion.matchType == 'exact' %} selected {% endif %}>{{ 'Exact Match'|t('search-manager') }}</option>
						<option value="contains" {% if promotion.matchType == 'contains' %} selected {% endif %}>{{ 'Contains'|t('search-manager') }}</option>
						<option value="prefix" {% if promotion.matchType == 'prefix' %} selected {% endif %}>{{ 'Starts With'|t('search-manager') }}</option>
					</select>
				</div>
			</div>
		</div>

		<div class="field" id="query-field">
			<div class="heading">
				<label for="query">{{ 'Query Pattern'|t('search-manager') }}
					<span class="required" aria-label="Required"></span>
				</label>
				<div class="instructions">
					<p id="queryInstructions">
						{% if promotion.matchType == 'contains' %}
							{{ 'Enter text that should appear anywhere in the search query.'|t('search-manager') }}
						{% elseif promotion.matchType == 'prefix' %}
							{{ 'Enter text that the search query should start with.'|t('search-manager') }}
						{% else %}
							{{ 'Enter the exact search query to match.'|t('search-manager') }}
						{% endif %}
						{{ 'Use commas for multiple patterns (e.g., sale, تخفيض, soldes, angebot).'|t('search-manager') }}
					</p>
				</div>
			</div>
			<div class="input ltr">
				<input type="text" id="query" name="query" value="{{ promotion.query }}" placeholder="{{ promotion.matchType == 'contains' ? 'sale' : (promotion.matchType == 'prefix' ? 'best ' : 'holiday sale') }}" required class="text fullwidth{% if promotion.getErrors('query') %} error{% endif %}">
			</div>
			{% if promotion.getErrors('query') %}
				<ul class="errors">
					{% for error in promotion.getErrors('query') %}
						<li>{{ error }}</li>
					{% endfor %}
				</ul>
			{% endif %}
			<p id="matchTypeTip" class="notice has-icon" style="margin-top: 10px;">
				<span class="icon" aria-hidden="true"></span>
				<span class="visually-hidden">Tip:</span>
				<span id="matchTypeTipText">
					{% if promotion.matchType == 'contains' %}
						Example: "sale" matches "holiday sale", "sale items", "big sale event"
					{% elseif promotion.matchType == 'prefix' %}
						Example: "best " matches "best deals", "best products", "best sellers"
					{% else %}
						Example: "holiday sale" only matches exactly "holiday sale", not "holiday sale 2024"
					{% endif %}
				</span>
			</p>
		</div>

		<hr>

		{{ forms.elementSelectField({
			label: 'Promoted Element'|t('search-manager'),
			instructions: 'Select the element to pin to the top of search results when the query matches.'|t('search-manager'),
			id: 'promotedElement',
			name: 'promotedElement',
			elementType: 'craft\\elements\\Entry',
			selectionLabel: 'Select an element'|t('search-manager'),
			limit: 1,
			elements: promotion.elementId ? [craft.entries.id(promotion.elementId).status(null).one()] : [],
			required: true,
			errors: promotion.getErrors('elementId'),
		}) }}

		<div class="field">
			<div class="heading">
				<label for="position">{{ 'Position'|t('search-manager') }}</label>
				<div class="instructions">
					<p>{{ 'Where to place this element in search results. Position 1 = first result, position 2 = second result, etc.'|t('search-manager') }}</p>
				</div>
			</div>
			<div class="input ltr">
				<div class="select">
					<select id="position" name="position" style="width: 250px;">
						{% for i in 1..10 %}
							<option value="{{ i }}" {% if (promotion.position ?: 1) == i %} selected {% endif %}>
								{{ i }} - {{ i == 1 ? 'First result' : (i == 2 ? 'Second result' : (i == 3 ? 'Third result' : 'Position ' ~ i)) }}
							</option>
						{% endfor %}
					</select>
				</div>
			</div>
			<p class="notice has-icon" style="margin-top: 10px;">
				<span class="icon" aria-hidden="true"></span>
				<span class="visually-hidden">Tip:</span>
				<span>Multiple promotions for the same query are sorted by position. If two promotions have position 1, both will appear at the top in order of creation.</span>
			</p>
		</div>

	</div>{# /fields #}

	{# Analytics Tab Content - only for existing promotions #}
	{% if not isNew and plugin.settings.enableAnalytics %}
		<div id="analytics" class="hidden">
			{% include "search-manager/promotions/_partials/analytics" with {
				promotion: promotion
			} %}
		</div>
	{% endif %}
{% endblock %}

{% block details %}
	<div class="meta">
		{{ forms.lightswitchField({
			label: 'Enabled'|t('search-manager'),
			id: 'enabled',
			name: 'enabled',
			on: promotion.enabled ?? true
		}) }}

		{% if craft.app.getIsMultiSite() %}
			{{ forms.selectField({
				label: 'Site'|t('search-manager'),
				id: 'siteId',
				name: 'siteId',
				options: siteOptions,
				value: promotion.siteId
			}) }}
		{% endif %}
	</div>

	{% if not isNew %}
		<fieldset>
			<dl class="meta read-only">
				<div class="data">
					<dt class="heading">{{ 'Status'|t('search-manager') }}</dt>
					<dd class="value">
						<span class="status {{ promotion.enabled ? 'live' : 'disabled' }}"></span>
						<span>{{ promotion.enabled ? 'Live'|t('search-manager') : 'Disabled'|t('search-manager') }}</span>
					</dd>
				</div>
			</dl>
		</fieldset>
	{% endif %}
{% endblock %}

{% js %}
// Update instructions based on match type
const matchTypeSelect = document.getElementById('matchType');
const matchTypeInstructions = document.getElementById('matchTypeInstructions');
const queryInstructions = document.getElementById('queryInstructions');
const queryInput = document.getElementById('query');
const matchTypeTipText = document.getElementById('matchTypeTipText');

function updateMatchTypeUI() {
	const matchType = matchTypeSelect.value;
	const commaHint = ' {{ 'Use commas for multiple patterns (e.g., sale, تخفيض, soldes, angebot).'|t('search-manager') }}';

	switch(matchType) {
		case 'contains':
			matchTypeInstructions.textContent = '{{ 'Match if the search query contains this pattern anywhere.'|t('search-manager') }}';
			queryInstructions.textContent = '{{ 'Enter text that should appear anywhere in the search query.'|t('search-manager') }}' + commaHint;
			queryInput.placeholder = 'sale';
			matchTypeTipText.textContent = 'Example: "sale" matches "holiday sale", "sale items", "big sale event"';
			break;
		case 'prefix':
			matchTypeInstructions.textContent = '{{ 'Match if the search query starts with this pattern.'|t('search-manager') }}';
			queryInstructions.textContent = '{{ 'Enter text that the search query should start with.'|t('search-manager') }}' + commaHint;
			queryInput.placeholder = 'best ';
			matchTypeTipText.textContent = 'Example: "best " matches "best deals", "best products", "best sellers"';
			break;
		default: // exact
			matchTypeInstructions.textContent = '{{ 'Match only if the search query exactly matches this pattern.'|t('search-manager') }}';
			queryInstructions.textContent = '{{ 'Enter the exact search query to match.'|t('search-manager') }}' + commaHint;
			queryInput.placeholder = 'holiday sale';
			matchTypeTipText.textContent = 'Example: "holiday sale" only matches exactly "holiday sale", not "holiday sale 2024"';
	}
}

if (matchTypeSelect) {
	matchTypeSelect.addEventListener('change', updateMatchTypeUI);
}

// Set platform-specific keyboard shortcut
const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
const saveShortcut = document.getElementById('save-shortcut');
if (saveShortcut) {
	saveShortcut.textContent = isMac ? '⌘S' : 'Ctrl+S';
}
{% endjs %}
