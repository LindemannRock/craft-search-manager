{% set plugin = craft.app.plugins.getPlugin('search-manager') %}

{% if analytics.totalImpressions == 0 %}
    <div class="zilch">
        <p>{{ "No analytics data yet"|t('search-manager') }}</p>
        <p class="light">{{ "Analytics will appear here once this promotion starts being shown in search results."|t('search-manager') }}</p>
    </div>
{% else %}

{# Summary Stats #}
<div class="analytics-stats">
    <div class="stat-box">
        <div class="stat-value">{{ analytics.totalImpressions|number }}</div>
        <div class="stat-label">{{ "Impressions"|t('search-manager') }}</div>
    </div>
    <div class="stat-box">
        <div class="stat-value">{{ analytics.uniqueQueries|number }}</div>
        <div class="stat-label">{{ "Unique Queries"|t('search-manager') }}</div>
    </div>
    <div class="stat-box">
        <div class="stat-value">{{ analytics.avgPosition|number(1) }}</div>
        <div class="stat-label">{{ "Avg Position"|t('search-manager') }}</div>
    </div>
</div>

{# Top Queries that triggered this promotion #}
{% if analytics.topQueries|length %}
<div class="chart-container">
    <h3>{{ "Top Queries Showing This Promotion"|t('search-manager') }}</h3>
    <table class="data fullwidth">
        <thead>
            <tr>
                <th>{{ 'Query'|t('search-manager') }}</th>
                <th>{{ 'Impressions'|t('search-manager') }}</th>
                <th>{{ 'Avg Position'|t('search-manager') }}</th>
                <th>{{ 'Last Shown'|t('search-manager') }}</th>
            </tr>
        </thead>
        <tbody>
            {% for item in analytics.topQueries %}
                <tr>
                    <td><code>{{ item.query }}</code></td>
                    <td>{{ item.count|number }}</td>
                    <td>{{ item.avgPosition|number(1) }}</td>
                    <td>{{ item.lastShown|date('short') }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{# Daily Impressions Chart #}
{% if analytics.dailyImpressions|length %}
<div class="chart-container">
    <h3>{{ "Daily Impressions"|t('search-manager') }}</h3>
    <canvas id="promotion-daily-chart" style="max-height: 250px;"></canvas>
</div>

<script>
// Load Chart.js if not already loaded
if (typeof Chart === 'undefined') {
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js';
    script.onload = function() {
        initializePromotionCharts();
    };
    document.head.appendChild(script);
} else {
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializePromotionCharts);
    } else {
        initializePromotionCharts();
    }
}

window.promotionCharts = window.promotionCharts || {};

function initializePromotionCharts() {
    if (window.promotionCharts.dailyChart) {
        window.promotionCharts.dailyChart.destroy();
    }

    const ctx = document.getElementById('promotion-daily-chart');
    if (ctx) {
        const dailyData = {{ analytics.dailyImpressions|json_encode|raw }};
        window.promotionCharts.dailyChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dailyData.map(d => d.date),
                datasets: [{
                    label: '{{ "Impressions"|t('search-manager') }}',
                    data: dailyData.map(d => d.count),
                    borderColor: '#0d78f2',
                    backgroundColor: 'rgba(13, 120, 242, 0.1)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }
}
</script>
{% endif %}

{# Recent Impressions #}
{% if analytics.recentImpressions|length %}
<div class="chart-container">
    <h3>{{ "Recent Impressions (Last 20)"|t('search-manager') }}</h3>
    <table class="data fullwidth">
        <thead>
            <tr>
                <th>{{ 'Date'|t('search-manager') }}</th>
                <th>{{ 'Time'|t('search-manager') }}</th>
                <th>{{ 'Query'|t('search-manager') }}</th>
                <th>{{ 'Index'|t('search-manager') }}</th>
                <th>{{ 'Site'|t('search-manager') }}</th>
                <th>{{ 'Position'|t('search-manager') }}</th>
            </tr>
        </thead>
        <tbody>
            {% for impression in analytics.recentImpressions %}
                <tr>
                    <td>{{ impression.dateCreated|date('short') }}</td>
                    <td>{{ impression.dateCreated|time('short') }}</td>
                    <td><code>{{ impression.query }}</code></td>
                    <td>{{ impression.indexHandle ?? '—' }}</td>
                    <td>
                        {% if impression.siteId %}
                            {% set site = craft.app.sites.getSiteById(impression.siteId) %}
                            {{ site ? site.name : '—' }}
                        {% else %}
                            —
                        {% endif %}
                    </td>
                    <td>{{ impression.position ?? '—' }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{% endif %}{# end if analytics.totalImpressions == 0 #}
