{% set plugin = craft.app.plugins.getPlugin('search-manager') %}
{% set pluginHandle = pluginHandle ?? plugin.id %}
{% set dateRange = craft.app.request.getQueryParam('range') ?? lrDefaultDateRange(pluginHandle) %}

{# Get analytics data for this promotion #}
{% set analytics = craft.searchManager.getPromotionAnalytics(promotion.id, dateRange) %}

{% embed 'lindemannrock-base/_partials/analytics-panel' with {
    config: {
        pluginHandle: pluginHandle,
        dateRange: {
            enabled: true,
            current: dateRange,
            param: 'range',
            hash: 'analytics',
        },
        export: {
            action: 'search-manager/analytics/export-promotion-analytics',
            permission: 'searchManager:exportAnalytics',
            extraParams: {promotionId: promotion.id},
        },
    }
} %}
    {% block content %}
        {% if analytics.totalImpressions == 0 %}
            <div class="lr-analytics-empty">
                <p>{{ "No analytics data yet"|t('search-manager') }}</p>
                <p class="light">{{ "Analytics will appear here once this promotion starts being shown in search results."|t('search-manager') }}</p>
            </div>
        {% else %}
            <div class="lr-unified-cards">
                {% include 'lindemannrock-base/_components/cards/unified-card' with {
                    value: analytics.totalImpressions|number,
                    description: 'Impressions'|t('search-manager'),
                    align: 'center',
                } only %}

                {% include 'lindemannrock-base/_components/cards/unified-card' with {
                    value: analytics.uniqueQueries|number,
                    description: 'Unique Queries'|t('search-manager'),
                    align: 'center',
                } only %}

                {% include 'lindemannrock-base/_components/cards/unified-card' with {
                    value: analytics.avgPosition|number(1),
                    description: 'Avg Position'|t('search-manager'),
                    align: 'center',
                } only %}
            </div>

            {% if analytics.topQueries|length %}
                <h2 class="lr-section-heading">{{ "Top Queries Showing This Promotion"|t('search-manager') }}</h2>
                <div class="lr-chart-container">
                    <div class="lr-table-scroll">
                        <table class="data fullwidth">
                            <thead>
                                <tr>
                                    <th>{{ 'Query'|t('search-manager') }}</th>
                                    <th>{{ 'Impressions'|t('search-manager') }}</th>
                                    <th>{{ 'Avg Position'|t('search-manager') }}</th>
                                    <th>{{ 'Last Shown'|t('search-manager') }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in analytics.topQueries %}
                                    <tr>
                                        <td><code>{{ item.query }}</code></td>
                                        <td>{{ item.count|number }}</td>
                                        <td>{{ item.avgPosition|number(1) }}</td>
                                        <td>{{ item.lastShown|lrDate('short') }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            {% endif %}

            {% if analytics.dailyImpressions|length %}
                <h2 class="lr-section-heading">{{ "Daily Impressions"|t('search-manager') }}</h2>
                <div class="lr-chart-container">
                    <div class="lr-chart-height-250">
                        <canvas id="promotion-daily-chart" class="lr-chart-canvas"></canvas>
                    </div>
                </div>

                <script data-analytics-reinit="true">
                (function() {
                    function initPromotionDailyChart() {
                        if (typeof Chart === 'undefined') return;
                        window.promotionCharts = window.promotionCharts || {};
                        if (window.promotionCharts.dailyChart) {
                            window.promotionCharts.dailyChart.destroy();
                        }

                        const ctx = document.getElementById('promotion-daily-chart');
                        if (!ctx) return;
                        const dailyData = {{ analytics.dailyImpressions|json_encode|raw }};
                        window.promotionCharts.dailyChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: dailyData.map(d => d.date),
                                datasets: [{
                                    label: '{{ "Impressions"|t('search-manager') }}',
                                    data: dailyData.map(d => d.count),
                                    borderColor: '#0d78f2',
                                    backgroundColor: 'rgba(13, 120, 242, 0.1)',
                                    fill: true,
                                    tension: 0.3
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { display: false } },
                                scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                            }
                        });
                        ctx.style.width = '100%';
                        ctx.style.height = '100%';
                }

                    if (typeof Chart !== 'undefined') {
                        initPromotionDailyChart();
                    }
                    document.addEventListener('lr:panelChartsReady', initPromotionDailyChart, { once: true });
                })();
                </script>
            {% endif %}

            {% if analytics.recentImpressions|length %}
                <h2 class="lr-section-heading">{{ "Recent Impressions (Last 20)"|t('search-manager') }}</h2>
                <div class="lr-chart-container">
                    <div class="lr-table-scroll">
                        <table class="data fullwidth">
                            <thead>
                                <tr>
                                    <th>{{ 'Date'|t('search-manager') }}</th>
                                    <th>{{ 'Time'|t('search-manager') }}</th>
                                    <th>{{ 'Query'|t('search-manager') }}</th>
                                    <th>{{ 'Index'|t('search-manager') }}</th>
                                    <th>{{ 'Site'|t('search-manager') }}</th>
                                    <th>{{ 'Position'|t('search-manager') }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for impression in analytics.recentImpressions %}
                                    <tr>
                                        <td>{{ impression.dateCreated|lrDate('short') }}</td>
                                        <td>{{ impression.dateCreated|lrTime('short') }}</td>
                                        <td><code>{{ impression.query }}</code></td>
                                        <td>{{ impression.indexHandle ?? '—' }}</td>
                                        <td>
                                            {% if impression.siteId %}
                                                {% set site = craft.app.sites.getSiteById(impression.siteId) %}
                                                {{ site ? site.name : '—' }}
                                            {% else %}
                                                — 
                                            {% endif %}
                                        </td>
                                        <td>{{ impression.position ?? '—' }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            {% endif %}
        {% endif %}
    {% endblock %}
{% endembed %}
