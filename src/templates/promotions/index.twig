{% extends 'lindemannrock-base/_layouts/cp-table' %}

{% set plugin = craft.app.plugins.getPlugin('search-manager') %}
{% set settings = plugin.getSettings() %}

{# Get query parameters #}
{% set search = craft.app.request.getParam('search', '') %}
{% set statusFilter = craft.app.request.getParam('status', 'all') %}
{% set matchTypeFilter = craft.app.request.getParam('matchType', 'all') %}
{% set sort = craft.app.request.getParam('sort', 'position') %}
{% set dir = craft.app.request.getParam('dir', 'asc') %}
{% set page = craft.app.request.getParam('page', 1)|number_format(0, '', '') %}
{% set limit = settings.itemsPerPage %}
{% set offset = (page - 1) * limit %}

{# Filter promotions based on filters #}
{% set filteredPromotions = promotions %}

{# Status filter #}
{% if statusFilter == 'enabled' %}
    {% set filteredPromotions = filteredPromotions|filter(p => p.enabled) %}
{% elseif statusFilter == 'disabled' %}
    {% set filteredPromotions = filteredPromotions|filter(p => not p.enabled) %}
{% endif %}

{# Match type filter #}
{% if matchTypeFilter != 'all' %}
    {% set filteredPromotions = filteredPromotions|filter(p => p.matchType == matchTypeFilter) %}
{% endif %}

{# Search filter #}
{% if search %}
    {% set filteredPromotions = filteredPromotions|filter(p => search|lower in p.query|lower or (p.indexHandle and search|lower in p.indexHandle|lower) or (p.title and search|lower in p.title|lower)) %}
{% endif %}

{# Sort #}
{% if sort == 'query' %}
    {% set filteredPromotions = dir == 'asc' ? filteredPromotions|sort((a, b) => a.query|lower <=> b.query|lower) : filteredPromotions|sort((a, b) => b.query|lower <=> a.query|lower) %}
{% elseif sort == 'matchType' %}
    {% set filteredPromotions = dir == 'asc' ? filteredPromotions|sort((a, b) => a.matchType <=> b.matchType) : filteredPromotions|sort((a, b) => b.matchType <=> a.matchType) %}
{% elseif sort == 'title' %}
    {% set filteredPromotions = dir == 'asc' ? filteredPromotions|sort((a, b) => (a.title ?? '')|lower <=> (b.title ?? '')|lower) : filteredPromotions|sort((a, b) => (b.title ?? '')|lower <=> (a.title ?? '')|lower) %}
{% elseif sort == 'position' %}
    {% set filteredPromotions = dir == 'asc' ? filteredPromotions|sort((a, b) => a.position <=> b.position) : filteredPromotions|sort((a, b) => b.position <=> a.position) %}
{% elseif sort == 'enabled' %}
    {% set filteredPromotions = dir == 'asc' ? filteredPromotions|sort((a, b) => a.enabled <=> b.enabled) : filteredPromotions|sort((a, b) => b.enabled <=> a.enabled) %}
{% elseif sort == 'siteId' %}
    {% set filteredPromotions = dir == 'asc' ? filteredPromotions|sort((a, b) => (a.siteId ?? 0) <=> (b.siteId ?? 0)) : filteredPromotions|sort((a, b) => (b.siteId ?? 0) <=> (a.siteId ?? 0)) %}
{% endif %}

{# Pagination #}
{% set totalCount = filteredPromotions|length %}
{% set paginatedItems = filteredPromotions|slice(offset, limit) %}

{# Match type labels #}
{% set matchTypeLabels = {
    'exact': 'Exact'|t('search-manager'),
    'contains': 'Contains'|t('search-manager'),
    'prefix': 'Starts With'|t('search-manager'),
} %}

{% set tableConfig = {
    plugin: {
        handle: 'search-manager',
        name: searchHelper.fullName,
    },
    page: {
        title: 'Promotions'|t('search-manager'),
        subnav: 'promotions',
        crumbs: [
            { label: searchHelper.fullName, url: url('search-manager') },
            { label: 'Promotions'|t('search-manager'), url: url('search-manager/promotions') }
        ],
    },
    filters: [
        {
            type: 'status',
            param: 'status',
            current: statusFilter,
            label: 'All'|t('search-manager'),
            groups: [
                {
                    param: 'status',
                    current: statusFilter,
                    options: [
                        {value: 'all', label: 'All'|t('search-manager'), status: 'all'},
                        {value: 'enabled', label: 'Enabled'|t('search-manager'), status: 'green'},
                        {value: 'disabled', label: 'Disabled'|t('search-manager'), status: 'disabled'},
                    ],
                },
                {
                    header: 'Match Type'|t('search-manager'),
                    param: 'matchType',
                    current: matchTypeFilter,
                    colorSet: 'matchType',
                    options: [
                        {value: 'all', label: 'All Types'|t('search-manager'), status: 'all'},
                        {value: 'exact', label: 'Exact Match'|t('search-manager'), colorKey: 'exact'},
                        {value: 'contains', label: 'Contains'|t('search-manager'), colorKey: 'contains'},
                        {value: 'prefix', label: 'Starts With'|t('search-manager'), colorKey: 'prefix'},
                    ],
                },
            ],
        },
    ],
    search: {
        placeholder: 'Search promotions...'|t('search-manager'),
        value: search,
    },
    sort: {
        field: sort,
        direction: dir,
    },
    table: {
        columns: [
            {key: 'title', label: 'Title'|t('search-manager'), sortable: true},
            {key: 'query', label: 'Query Pattern'|t('search-manager'), sortable: true},
            {key: 'matchType', label: 'Match'|t('search-manager'), sortable: true, hideable: true},
            {key: 'element', label: 'Promoted Element'|t('search-manager'), hideable: true},
            {key: 'position', label: 'Position'|t('search-manager'), sortable: true, hideable: true},
            {key: 'siteId', label: 'Site'|t('search-manager'), sortable: true, hideable: true},
            {key: 'enabled', label: 'Status'|t('search-manager'), sortable: true, hideable: true},
        ],
        items: paginatedItems,
        emptyMessage: 'No promotions found.'|t('search-manager'),
    },
    pagination: {
        page: page,
        limit: limit,
        totalCount: totalCount,
        itemLabel: {singular: 'promotion'|t('search-manager'), plural: 'promotions'|t('search-manager')},
    },
    checkboxes: currentUser.can('searchManager:editPromotions') or currentUser.can('searchManager:deletePromotions'),
    newButton: {
        url: url('search-manager/promotions/create'),
        label: 'New Promotion'|t('search-manager'),
        permission: 'searchManager:createPromotions',
    },
} %}

{% block tableRow %}
    {# Title #}
    <td data-column="title">
        <a class="label-link" href="{{ url('search-manager/promotions/edit/' ~ item.id) }}">
            {% if item.title %}
                {{ item.title }}
            {% else %}
                <span class="light">{{ 'Untitled'|t('search-manager') }}</span>
            {% endif %}
        </a>
    </td>

    {# Query Pattern #}
    <td data-column="query">
        <code>{{ item.query }}</code>
    </td>

    {# Match Type #}
    <td data-column="matchType">
        {% include 'lindemannrock-base/_components/badge' with {
            label: matchTypeLabels[item.matchType] ?? item.matchType|capitalize,
            value: item.matchType,
            colorSet: 'matchType',
        } only %}
    </td>

    {# Promoted Element #}
    <td data-column="element">
        {% set element = craft.entries.id(item.elementId).status(null).one() %}
        {% if element and element.id %}
            <a href="{{ element.cpEditUrl }}" target="_blank">
                {{ element.title ?? element.id }}
            </a>
            <span class="light">(#{{ element.id }})</span>
        {% else %}
            <span class="light">{{ 'ID'|t('search-manager') }}: {{ item.elementId }}</span>
        {% endif %}
    </td>

    {# Position #}
    <td data-column="position">
        <strong>{{ item.position }}</strong>
    </td>

    {# Site #}
    <td data-column="siteId">
        {% if item.siteId %}
            {% set site = craft.app.sites.getSiteById(item.siteId) %}
            {{ site ? site.name : 'Unknown' }}
        {% else %}
            <span class="light">{{ 'All Sites'|t('search-manager') }}</span>
        {% endif %}
    </td>

    {# Status #}
    <td data-column="enabled">
        {% if item.enabled %}
            {% include 'lindemannrock-base/_components/badge' with {
                label: 'Enabled'|t('search-manager'),
                value: 'enabled',
                colorSet: 'status',
            } only %}
        {% else %}
            {% include 'lindemannrock-base/_components/badge' with {
                label: 'Disabled'|t('search-manager'),
                value: 'disabled',
                colorSet: 'status',
            } only %}
        {% endif %}
    </td>
{% endblock %}

{% block rowActions %}
    {% include 'lindemannrock-base/_components/row-actions' with {
        item: item,
        actions: {
            type: 'menu',
            icon: 'settings',
            title: 'Actions'|t('app'),
            items: [
                {
                    label: 'Edit'|t('app'),
                    url: url('search-manager/promotions/edit/' ~ item.id),
                    permission: 'searchManager:editPromotions',
                },
                {
                    label: 'Delete'|t('app'),
                    class: 'error',
                    permission: 'searchManager:deletePromotions',
                    jsAction: 'delete',
                },
            ],
        },
    } only %}
{% endblock %}

{% block bulkActions %}
    {% if currentUser.can('searchManager:editPromotions') %}
        <button type="button" class="btn menubtn secondary" id="lr-bulk-status-btn">
            {{ 'Set status'|t('app') }}
        </button>
        <div class="menu">
            <ul>
                <li><a id="lr-bulk-enable-action">{{ 'Enable'|t('search-manager') }}</a></li>
                <li><a id="lr-bulk-disable-action">{{ 'Disable'|t('search-manager') }}</a></li>
            </ul>
        </div>
    {% endif %}

    {% if currentUser.can('searchManager:deletePromotions') %}
        <button type="button" class="btn secondary" id="lr-bulk-delete-btn">
            {{ 'Delete'|t('search-manager') }} (<span id="lr-selected-count">0</span>)
        </button>
    {% endif %}
{% endblock %}

{% block scripts %}
<script>
(function() {
    // Initialize bulk status menu
    const bulkStatusBtn = document.getElementById('lr-bulk-status-btn');
    if (bulkStatusBtn && typeof Craft !== 'undefined' && Craft.MenuBtn) {
        new Craft.MenuBtn(bulkStatusBtn);
    }

    // Bulk enable
    document.getElementById('lr-bulk-enable-action')?.addEventListener('click', function(e) {
        e.preventDefault();
        const ids = window.lrTableSelection.getSelectedIds();
        if (ids.length === 0) return;

        Craft.sendActionRequest('POST', 'search-manager/promotions/bulk-enable', {
            data: { promotionIds: ids }
        }).then(function(response) {
            if (response.data.success) {
                Craft.cp.displayNotice(Craft.t('search-manager', 'Enabled {count} promotions', {count: response.data.count}));
                setTimeout(() => window.location.reload(), 1000);
            }
        }).catch(function(error) {
            Craft.cp.displayError(Craft.t('search-manager', 'Failed to enable promotions'));
        });
    });

    // Bulk disable
    document.getElementById('lr-bulk-disable-action')?.addEventListener('click', function(e) {
        e.preventDefault();
        const ids = window.lrTableSelection.getSelectedIds();
        if (ids.length === 0) return;

        Craft.sendActionRequest('POST', 'search-manager/promotions/bulk-disable', {
            data: { promotionIds: ids }
        }).then(function(response) {
            if (response.data.success) {
                Craft.cp.displayNotice(Craft.t('search-manager', 'Disabled {count} promotions', {count: response.data.count}));
                setTimeout(() => window.location.reload(), 1000);
            }
        }).catch(function(error) {
            Craft.cp.displayError(Craft.t('search-manager', 'Failed to disable promotions'));
        });
    });

    // Bulk delete
    document.getElementById('lr-bulk-delete-btn')?.addEventListener('click', function() {
        const ids = window.lrTableSelection.getSelectedIds();
        if (ids.length === 0) return;

        if (!confirm(Craft.t('search-manager', 'Delete {count} promotion(s)? This cannot be undone.', {count: ids.length}))) return;

        Craft.sendActionRequest('POST', 'search-manager/promotions/bulk-delete', {
            data: { promotionIds: ids }
        }).then(function(response) {
            if (response.data.success) {
                Craft.cp.displayNotice(Craft.t('search-manager', 'Deleted {count} promotions', {count: response.data.count}));
                setTimeout(() => window.location.reload(), 1000);
            }
        }).catch(function(error) {
            Craft.cp.displayError(Craft.t('search-manager', 'Failed to delete promotions'));
        });
    });

    // Individual delete action
    document.querySelectorAll('[data-action="delete"]').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const row = this.closest('tr');
            const id = row?.dataset.id;
            const name = row?.dataset.name || '';

            if (!id) return;

            if (!confirm(Craft.t('search-manager', 'Delete promotion for "{name}"? This cannot be undone.', {name: name}))) return;

            Craft.sendActionRequest('POST', 'search-manager/promotions/delete', {
                data: { promotionId: id }
            }).then(function(response) {
                if (response.data.success) {
                    Craft.cp.displayNotice(Craft.t('search-manager', 'Promotion deleted'));
                    setTimeout(() => window.location.reload(), 1000);
                }
            }).catch(function(error) {
                Craft.cp.displayError(Craft.t('search-manager', 'Failed to delete promotion'));
            });
        });
    });

    // Update selected count
    document.addEventListener('lr:selectionChanged', function(e) {
        const countSpan = document.getElementById('lr-selected-count');
        if (countSpan) {
            countSpan.textContent = e.detail.count;
        }
    });
})();
</script>
{% endblock %}
