{% extends 'lindemannrock-base/_layouts/cp-utilities' %}

{% import "_includes/forms" as forms %}

{# Permission checks #}
{% set canViewIndices = currentUser.can('searchManager:viewIndices') %}
{% set canRebuildIndices = currentUser.can('searchManager:rebuildIndices') %}
{% set canClearCache = currentUser.can('searchManager:clearCache') %}
{% set canClearAnalytics = currentUser.can('searchManager:clearAnalytics') %}
{% set canViewAnalytics = currentUser.can('searchManager:viewAnalytics') %}
{% set canManageSettings = currentUser.can('searchManager:manageSettings') %}

{% set hasNavigation = canViewIndices or (settings.enableAnalytics and canViewAnalytics) or canManageSettings %}
{% set hasIndexManagement = canRebuildIndices %}
{% set hasCacheManagement = canClearCache and (settings.cacheDeviceDetection or settings.enableCache or settings.enableAutocompleteCache) %}
{% set hasAnalyticsManagement = canClearAnalytics and settings.enableAnalytics %}
{% set hasAnyQuickAction = hasNavigation or hasIndexManagement or hasCacheManagement or hasAnalyticsManagement %}

{# Backend labels #}
{% set backendLabels = {
    'mysql': 'MySQL',
    'pgsql': 'PostgreSQL',
    'redis': 'Redis',
    'file': 'File',
    'algolia': 'Algolia',
    'meilisearch': 'Meilisearch',
    'typesense': 'Typesense'
} %}

{% set utilitiesConfig = {
    plugin: {
        handle: 'search-manager',
        name: searchHelper.fullName,
    },
    page: {
        title: 'Overview'|t('search-manager'),
        description: 'Monitor search indices, clear file cache, and manage your search infrastructure.'|t('search-manager'),
    },
} %}

{% block overview %}
    {# Search Indices Card #}
    {% include 'lindemannrock-base/_components/cards/unified-card' with {
        title: 'Search Indices'|t('search-manager'),
        color: lrPaletteColor('emerald').color,
        value: indexCount,
        description: 'Total indices configured'|t('search-manager'),
        subBoxes: [
            {value: totalDocuments, label: 'Total Documents'|t('search-manager')},
        ],
    } only %}

    {# Backend Distribution Card #}
    {% if backendDistribution|length > 0 %}
        {% set backendSubBoxes = [] %}
        {% for backendType, stats in backendDistribution %}
            {% set backendSubBoxes = backendSubBoxes|merge([{
                value: stats.count,
                label: backendLabels[backendType] ?? backendType|capitalize
            }]) %}
        {% endfor %}

        {% set backendDescription = 'Backend types in use'|t('search-manager') %}
        {% if defaultBackendName %}
            {% set backendDescription = backendDescription ~ ' (' ~ 'Default: {name}'|t('search-manager', {name: defaultBackendName}) ~ ')' %}
        {% endif %}

        {% include 'lindemannrock-base/_components/cards/unified-card' with {
            title: 'Backend Distribution'|t('search-manager'),
            color: lrPaletteColor('sky').color,
            value: backendDistribution|length,
            description: backendDescription,
            subBoxes: backendSubBoxes,
        } only %}
    {% else %}
        {% include 'lindemannrock-base/_components/cards/unified-card' with {
            title: 'Backend Distribution'|t('search-manager'),
            color: lrPaletteColor('sky').color,
            value: 0,
            valueColor: lrPaletteColor('gray').color,
            description: 'No indices configured'|t('search-manager'),
        } only %}
    {% endif %}

    {# Cache Status Card #}
    {% if storageMethod == 'redis' %}
        {% set cacheSubBoxes = [] %}
        {% if settings.enableCache %}
            {% set cacheSubBoxes = cacheSubBoxes|merge([{value: '✓', label: 'Search'|t('search-manager')}]) %}
        {% endif %}
        {% if settings.enableAutocompleteCache %}
            {% set cacheSubBoxes = cacheSubBoxes|merge([{value: '✓', label: 'Autocomplete'|t('search-manager')}]) %}
        {% endif %}
        {% if settings.cacheDeviceDetection %}
            {% set cacheSubBoxes = cacheSubBoxes|merge([{value: '✓', label: 'Devices'|t('search-manager')}]) %}
        {% endif %}

        {% include 'lindemannrock-base/_components/cards/unified-card' with {
            title: 'Cache Status'|t('search-manager') ~ ' (Redis)',
            color: lrPaletteColor('emerald').color,
            value: 'Active'|t('search-manager'),
            subBoxes: cacheSubBoxes,
        } only %}
    {% else %}
        {% set cacheSubBoxes = [] %}
        {% if settings.enableCache %}
            {% set cacheSubBoxes = cacheSubBoxes|merge([{value: searchCacheFiles, label: 'Search'|t('search-manager')}]) %}
        {% endif %}
        {% if settings.enableAutocompleteCache %}
            {% set cacheSubBoxes = cacheSubBoxes|merge([{value: autocompleteCacheFiles, label: 'Autocomplete'|t('search-manager')}]) %}
        {% endif %}
        {% if settings.cacheDeviceDetection %}
            {% set cacheSubBoxes = cacheSubBoxes|merge([{value: deviceCacheFiles, label: 'Devices'|t('search-manager')}]) %}
        {% endif %}

        {% include 'lindemannrock-base/_components/cards/unified-card' with {
            title: 'Cache Status'|t('search-manager') ~ ' (File)',
            color: lrPaletteColor('emerald').color,
            value: searchCacheFiles + autocompleteCacheFiles + deviceCacheFiles,
            description: 'Total cached entries'|t('search-manager'),
            subBoxes: cacheSubBoxes,
        } only %}
    {% endif %}
{% endblock %}

{% block quickActions %}
    {% if hasAnyQuickAction %}
        {# Navigation Section #}
        {% if hasNavigation %}
            {% set navButtons = [] %}
            {% if canViewIndices %}
                {% set navButtons = navButtons|merge([{type: 'link', label: 'Manage Indices'|t('search-manager'), url: url('search-manager/indices')}]) %}
            {% endif %}
            {% if settings.enableAnalytics and canViewAnalytics %}
                {% set navButtons = navButtons|merge([{type: 'link', label: 'View Analytics'|t('search-manager'), url: url('search-manager/analytics')}]) %}
            {% endif %}
            {% if canManageSettings %}
                {% set navButtons = navButtons|merge([{type: 'link', label: 'View Settings'|t('search-manager'), url: url('search-manager/settings')}]) %}
            {% endif %}

            {% include 'lindemannrock-base/_layouts/cp-utilities/_action-section' with {
                title: 'Navigation'|t('search-manager'),
                description: 'Access main plugin sections'|t('search-manager'),
                buttons: navButtons,
            } only %}
        {% endif %}

        {# Index Management Section - Custom due to form and dropdown #}
        {% if hasIndexManagement %}
            {% if hasNavigation %}<hr style="margin: 24px 0; border: none; border-top: 1px solid #e5e7eb;">{% endif %}

            <div style="margin-bottom: 24px;">
                <h3 style="margin-bottom: 8px;">{{ "Index Management"|t('search-manager') }}</h3>
                <p class="light" style="margin-bottom: 16px;">{{ "Rebuild indices or clear storage data."|t('search-manager') }}</p>

                <form method="post" accept-charset="UTF-8" style="display: inline; margin-bottom: 20px;">
                    {{ csrfInput() }}
                    {{ actionInput('search-manager/utilities/rebuild-all-indices') }}
                    {{ redirectInput('utilities/clear-search-cache') }}
                    <button type="submit" class="btn submit">
                        {{ "Rebuild All Indices"|t('search-manager') }}
                    </button>
                </form>

                <p class="light" style="margin-bottom: 12px;">{{ "Clear ALL data from a specific storage type. Use this to remove orphaned data when changing backends."|t('search-manager') }}</p>

                <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                    {{ forms.select({
                        id: 'storage-type-select',
                        name: 'storageType',
                        options: [
                            {label: 'Database (loading...)', value: 'database'},
                            {label: 'Redis (loading...)', value: 'redis'},
                            {label: 'File (loading...)', value: 'file'},
                        ],
                        value: 'database',
                    }) }}

                    <button type="button" class="btn secondary" id="clear-storage-by-type">
                        {{ "Clear Storage"|t('search-manager') }}
                    </button>
                </div>

                {% include 'lindemannrock-base/_components/info-box' with {
                    message: 'Clears ALL data from the selected storage type including orphaned data.'|t('search-manager'),
                    type: 'warning',
                    bg: 'white'
                } %}
            </div>
        {% endif %}

        {# Cache Management Section #}
        {% if hasCacheManagement %}
            {% set cacheButtons = [] %}
            {% if settings.enableCache %}
                {% set cacheButtons = cacheButtons|merge([{
                    id: 'clear-search-cache',
                    label: 'Clear Search Cache'|t('search-manager'),
                    count: storageMethod != 'redis' ? searchCacheFiles : null,
                }]) %}
            {% endif %}
            {% if settings.enableAutocompleteCache %}
                {% set cacheButtons = cacheButtons|merge([{
                    id: 'clear-autocomplete-cache',
                    label: 'Clear Autocomplete Cache'|t('search-manager'),
                    count: storageMethod != 'redis' ? autocompleteCacheFiles : null,
                }]) %}
            {% endif %}
            {% if settings.cacheDeviceDetection %}
                {% set cacheButtons = cacheButtons|merge([{
                    id: 'clear-device-cache',
                    label: 'Clear Device Cache'|t('search-manager'),
                    count: storageMethod != 'redis' ? deviceCacheFiles : null,
                }]) %}
            {% endif %}
            {% if settings.cacheDeviceDetection or settings.enableCache or settings.enableAutocompleteCache %}
                {% set cacheButtons = cacheButtons|merge([{
                    id: 'clear-all-caches',
                    label: 'Clear All Caches'|t('search-manager'),
                    class: 'btn secondary',
                }]) %}
            {% endif %}

            {% include 'lindemannrock-base/_layouts/cp-utilities/_action-section' with {
                title: 'Cache Management'|t('search-manager'),
                description: 'Clear temporary cached data to improve performance and free up storage space.'|t('search-manager'),
                showSeparator: hasNavigation or hasIndexManagement,
                buttons: cacheButtons,
            } only %}
        {% endif %}

        {# Analytics Management Section #}
        {% if hasAnalyticsManagement %}
            {% include 'lindemannrock-base/_layouts/cp-utilities/_action-section' with {
                title: 'Analytics Data Management'|t('search-manager'),
                description: 'Permanently delete all analytics tracking data. This action cannot be undone!'|t('search-manager'),
                showSeparator: hasNavigation or hasIndexManagement or hasCacheManagement,
                buttons: [
                    {id: 'clear-all-analytics', label: 'Clear All Analytics'|t('search-manager'), class: 'btn secondary', count: analyticsCount},
                ],
            } only %}
        {% endif %}
    {% endif %}
{% endblock %}

{% block scripts %}
{% js %}
// Load storage stats and update dropdown options
function loadStorageStats() {
    $.ajax({
        url: '{{ actionUrl('search-manager/utilities/get-storage-stats')|raw }}',
        type: 'GET',
        dataType: 'json',
        success: function(response) {
            if (response.success && response.stats) {
                var $select = $('#storage-type-select');
                var currentVal = $select.val();

                // Database (MySQL or PostgreSQL)
                var dbLabel = 'Database';
                if (response.stats.database && response.stats.database.driverLabel) {
                    dbLabel = response.stats.database.driverLabel;
                }
                var dbText = dbLabel;
                if (response.stats.database && response.stats.database.available) {
                    dbText += ' (' + response.stats.database.totalRows.toLocaleString() + ' rows)';
                }
                $select.find('option[value="database"]').text(dbText);

                // Redis
                var redisText = 'Redis';
                if (response.stats.redis && response.stats.redis.available) {
                    redisText += ' (' + response.stats.redis.keyCount.toLocaleString() + ' keys)';
                } else if (response.stats.redis && response.stats.redis.status === 'not_configured') {
                    redisText += ' (not configured)';
                } else if (response.stats.redis && response.stats.redis.status === 'extension_not_installed') {
                    redisText += ' (n/a)';
                }
                $select.find('option[value="redis"]').text(redisText);

                // File
                var fileText = 'File';
                if (response.stats.file && response.stats.file.available) {
                    fileText += ' (' + response.stats.file.fileCount.toLocaleString() + ' files)';
                }
                $select.find('option[value="file"]').text(fileText);

                $select.val(currentVal);
            }
        }
    });
}

$(document).ready(function() {
    loadStorageStats();
});

// Clear storage by type handler
$('#clear-storage-by-type').on('click', function() {
    var selectedType = $('#storage-type-select').val();
    var typeName = $('#storage-type-select option:selected').text();

    if (!confirm('{{ "Are you sure you want to clear ALL data from"|t('search-manager')|e('js') }} ' + typeName + '{{ "? This cannot be undone!"|t('search-manager')|e('js') }}')) {
        return;
    }

    const $btn = $(this);
    $btn.addClass('loading').prop('disabled', true);

    $.ajax({
        url: '{{ actionUrl('search-manager/utilities/clear-storage-by-type')|raw }}',
        type: 'POST',
        dataType: 'json',
        data: {
            {{ craft.app.config.general.csrfTokenName }}: '{{ craft.app.request.csrfToken }}',
            type: selectedType
        },
        success: function(response) {
            if (response.success) {
                Craft.cp.displayNotice(response.message);
                loadStorageStats();
            } else {
                Craft.cp.displayError(response.error || '{{ "Failed to clear storage"|t('search-manager')|e('js') }}');
            }
        },
        error: function() {
            Craft.cp.displayError('{{ "Failed to clear storage"|t('search-manager')|e('js') }}');
        },
        complete: function() {
            $btn.removeClass('loading').prop('disabled', false);
        }
    });
});

{% if settings.cacheDeviceDetection %}
{% include 'lindemannrock-base/_layouts/cp-utilities/_ajax-button' with {
    id: 'clear-device-cache',
    action: actionUrl('search-manager/utilities/clear-device-cache'),
    errorMessage: 'Failed to clear device cache'|t('search-manager'),
} only %}
{% endif %}

{% if settings.enableCache %}
{% include 'lindemannrock-base/_layouts/cp-utilities/_ajax-button' with {
    id: 'clear-search-cache',
    action: actionUrl('search-manager/utilities/clear-search-cache'),
    errorMessage: 'Failed to clear search cache'|t('search-manager'),
} only %}
{% endif %}

{% if settings.enableAutocompleteCache %}
{% include 'lindemannrock-base/_layouts/cp-utilities/_ajax-button' with {
    id: 'clear-autocomplete-cache',
    action: actionUrl('search-manager/utilities/clear-autocomplete-cache'),
    errorMessage: 'Failed to clear autocomplete cache'|t('search-manager'),
} only %}
{% endif %}

{% include 'lindemannrock-base/_layouts/cp-utilities/_ajax-button' with {
    id: 'clear-all-caches',
    action: actionUrl('search-manager/utilities/clear-all-caches'),
    confirm: 'Are you sure you want to clear all caches?'|t('search-manager'),
    errorMessage: 'Failed to clear caches'|t('search-manager'),
} only %}

{% if settings.enableAnalytics %}
{% include 'lindemannrock-base/_layouts/cp-utilities/_ajax-button' with {
    id: 'clear-all-analytics',
    action: actionUrl('search-manager/utilities/clear-all-analytics'),
    confirm: 'Are you sure you want to permanently delete ALL analytics data? This action cannot be undone!'|t('search-manager'),
    confirmSecond: 'This will delete all search tracking data and reset all statistics. Are you absolutely sure?'|t('search-manager'),
    errorMessage: 'Failed to clear analytics'|t('search-manager'),
    reloadDelay: 2000,
} only %}
{% endif %}
{% endjs %}
{% endblock %}
