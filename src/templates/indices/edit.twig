{% extends "_layouts/cp" %}
{% set title = isNew ? "Create Index"|t('search-manager') : "Edit Index: {name}"|t('search-manager', { name: index.name }) %}
{% set selectedSubnavItem = 'indices' %}
{% set crumbs = [
    { label: searchHelper.fullName, url: url('search-manager') },
    { label: 'Indices'|t('search-manager'), url: url('search-manager/indices') },
    { label: isNew ? 'New Index'|t('search-manager') : index.name }
] %}
{% set fullPageForm = true %}
{% set saveShortcutRedirect = cpUrl('search-manager/indices/edit/{id}') %}
{% set retainScrollOnSaveShortcut = true %}

{% import "_includes/forms" as forms %}
{% import "search-manager/_macros/index" as indexMacros %}

{% block actionButton %}
	<div class="btngroup submit">
		<button type="submit" class="btn submit">{{ "Save"|t('app') }}</button>
		<button type="button" class="btn submit menubtn"></button>
		<div class="menu">
			<ul role="listbox">
				<li>
					<a class="formsubmit" role="option" tabindex="0" data-redirect="{{ cpUrl('search-manager/indices/edit/{id}')|hash }}">
						<span class="label">{{ 'Save and continue editing'|t('app') }}</span>
						<span class="shortcut" id="save-shortcut"></span>
					</a>
				</li>
			</ul>
		</div>
	</div>
	{% if not isNew and index.canEdit() and currentUser.can('searchManager:deleteIndices') %}
		<button type="button" id="action-btn" class="btn menubtn action-btn hairline-dark m" title="{{ 'Actions'|t('app') }}" aria-controls="action-menu" aria-label="{{ 'Actions'|t('app') }}" data-disclosure-trigger="true" aria-expanded="false"></button>
		<div id="action-menu" class="menu menu--disclosure">
			<ul>
				<li>
					<button class="menu-item error formsubmit" data-destructive data-action="search-manager/indices/delete" data-params='{"indexId":{{ index.id }}}' data-confirm="{{ 'Are you sure you want to delete this index?'|t('search-manager') }}" data-redirect="{{ 'search-manager/indices'|hash }}" data-headers='{"Accept":"application/json"}'>
						<span class="icon">{{ svg('@app/icons/trash.svg') }}</span>
						<span class="menu-item-label">{{ "Delete"|t('app') }}</span>
					</button>
				</li>
			</ul>
		</div>
	{% endif %}
{% endblock %}

{% block content %}

<form method="post" accept-charset="UTF-8">
    {{ actionInput('search-manager/indices/save') }}
    {{ csrfInput() }}
    {{ redirectInput('search-manager/indices') }}

    {% if not isNew %}
        {{ hiddenInput('indexId', index.id) }}
    {% endif %}

    {{ forms.textField({
        first: true,
        label: "Name"|t('search-manager'),
        instructions: "The display name for this index"|t('search-manager'),
        id: 'name',
        name: 'name',
        value: index.name,
        required: true,
        autofocus: true,
    }) }}

    {{ forms.textField({
        label: "Handle"|t('search-manager'),
        instructions: "Unique identifier for this index (used in code)"|t('search-manager'),
        id: 'handle',
        name: 'handle',
        value: index.handle,
        required: true,
        class: 'code',
    }) }}

    {% set elementTypeOptions = {
        'craft\\elements\\Entry': 'Entries',
        'craft\\elements\\Asset': 'Assets',
        'craft\\elements\\Category': 'Categories',
        'craft\\elements\\User': 'Users',
    } %}
    {% if craft.app.plugins.getPlugin('smartlink-manager') %}
        {% set elementTypeOptions = elementTypeOptions|merge({
            'lindemannrock\\smartlinkmanager\\elements\\SmartLink': 'SmartLinks'
        }) %}
    {% endif %}
    {% if craft.app.plugins.getPlugin('shortlink-manager') %}
        {% set elementTypeOptions = elementTypeOptions|merge({
            'lindemannrock\\shortlinkmanager\\elements\\ShortLink': 'ShortLinks'
        }) %}
    {% endif %}

    {{ forms.selectField({
        label: "Element Type"|t('search-manager'),
        instructions: "The type of elements to index"|t('search-manager'),
        id: 'elementType',
        name: 'elementType',
        value: index.elementType,
        required: true,
        options: elementTypeOptions
    }) }}

    <div id="entry-criteria" {% if index.elementType != 'craft\\elements\\Entry' %}style="display:none;"{% endif %}>
        {% set sectionOptions = [] %}
        {% for section in craft.app.entries.getAllSections() %}
            {% set sectionOptions = sectionOptions|merge([{
                label: section.name,
                value: section.handle
            }]) %}
        {% endfor %}

        {{ forms.checkboxGroupField({
            label: "Sections"|t('search-manager'),
            instructions: "Which sections to index (leave all unchecked for all sections)"|t('search-manager'),
            id: 'sections',
            name: 'criteria[sections]',
            options: sectionOptions,
            values: index.criteria.sections ?? [],
        }) }}
    </div>

    {% set selectedSiteIds = [] %}
    {% if index.siteId is iterable %}
        {% set selectedSiteIds = index.siteId %}
    {% elseif index.siteId %}
        {% set selectedSiteIds = [index.siteId] %}
    {% endif %}

    {{ forms.checkboxGroupField({
        label: "Sites"|t('search-manager'),
        instructions: "Which sites to index (leave all unchecked to index all sites)"|t('search-manager'),
        id: 'siteId',
        name: 'siteId',
        options: craft.app.sites.getAllSites()|map(s => { label: s.name, value: s.id }),
        values: selectedSiteIds,
    }) }}

    {% set settings = craft.searchManager.getSettings() %}
    {% if settings.enableStopWords %}
        {% set languageOptions = { '': 'Auto-detect from site (recommended)'|t('search-manager') } %}
        {% for site in craft.app.sites.getAllSites() %}
            {% set langCode = site.language|lower %}
            {% set languageOptions = languageOptions|merge({ (langCode): site.name ~ ' (' ~ langCode ~ ')' }) %}
        {% endfor %}

        {{ forms.selectField({
            label: "Language (Search Processing)"|t('search-manager'),
            instructions: "Auto-detect uses each site's language for stop words, query operator parsing, and internal autocomplete language. Only override if you want a different processing language."|t('search-manager'),
            id: 'language',
            name: 'language',
            value: index.language,
            options: languageOptions,
            warning: index.language ? 'Manual override active. Language will NOT auto-detect from site.'|t('search-manager') : null,
        }) }}
    {% else %}
        <div class="field">
            <div class="heading">
                <label>{{ "Language"|t('search-manager') }}</label>
            </div>
            <div class="notice" style="margin-top: 5px;">
                {{ "Stop words filtering is currently disabled in plugin settings. Language selection is not available."|t('search-manager') }}
                <a href="{{ cpUrl('search-manager/settings/language') }}">{{ "Enable stop words"|t('search-manager') }}</a>
            </div>
        </div>
        {{ hiddenInput('language', '') }}
    {% endif %}

    <div id="language-preview" style="display: none;">
        {% include 'lindemannrock-base/_components/info-box' with {
            type: 'info',
            message: '<strong>' ~ "Auto-detected language:"|t('search-manager') ~ '</strong> <span id="detected-language">-</span><br>' ~ "Stop words file:"|t('search-manager') ~ ' <span id="stopwords-file">-</span><br>' ~ "Used for:"|t('search-manager') ~ ' ' ~ "stop words, query operators, and internal autocomplete language."|t('search-manager') ~ '<span id="multi-site-note" style="display:none;"><br>' ~ "For multiple sites, language is resolved per site unless manually set."|t('search-manager') ~ '</span>'
        } %}
    </div>

    {{ forms.textField({
        label: "Transformer Class"|t('search-manager'),
        instructions: "Custom transformer class (optional - AutoTransformer is used by default)"|t('search-manager'),
        id: 'transformerClass',
        name: 'transformerClass',
        value: index.transformerClass,
        required: false,
        class: 'code',
        placeholder: 'lindemannrock\\searchmanager\\transformers\\AutoTransformer',
        tip: "Leave blank to use AutoTransformer (automatically indexes all fields including Entries, Categories, Tags, Matrix, Table, and custom fields). Only specify a custom class for advanced requirements."|t('search-manager'),
        warning: index.transformerClass ? ("Custom transformer active: " ~ index.transformerClass)|t('search-manager') : null,
    }) }}

    {# Helpful transformer examples #}
    <div class="field" style="margin-top: -10px;">
        <div class="heading">
            <label style="font-size: 0.9em; font-weight: normal; color: #596673;">{{ "Available Transformers"|t('search-manager') }}</label>
        </div>
        <div style="font-size: 0.85em; color: #596673; line-height: 1.6;">
            <div style="margin-bottom: 8px;">
                <strong style="color: #0d78f2;">Recommended:</strong> Leave blank for <code style="background: #f3f7fc; padding: 2px 6px; border-radius: 3px;">AutoTransformer</code> (default)
            </div>
            <div style="padding-left: 20px; border-left: 2px solid #e3e5e8; margin-bottom: 12px;">
                <div style="margin-bottom: 4px;">✓ Automatically handles all field types</div>
                <div style="margin-bottom: 4px;">✓ Traverses relational fields (Entries, Categories, Tags, Assets)</div>
                <div style="margin-bottom: 4px;">✓ Indexes Matrix blocks, Table fields, and custom fields</div>
                <div>✓ No configuration needed</div>
            </div>
            <details style="margin-top: 10px;">
                <summary style="cursor: pointer; color: #0d78f2; font-weight: 500;">Custom transformer examples</summary>
                <ul style="margin: 8px 0 0 20px; padding: 0;">
                    <li style="margin-bottom: 6px;">
                        <code style="background: #f3f7fc; padding: 2px 6px; border-radius: 3px;">lindemannrock\searchmanager\transformers\EntryTransformer</code>
                        <span style="display: block; color: #8f98a3; font-size: 0.9em; margin-top: 2px;">Basic entry fields only</span>
                    </li>
                    <li style="margin-bottom: 6px;">
                        <code style="background: #f3f7fc; padding: 2px 6px; border-radius: 3px;">modules\transformers\MyCustomTransformer</code>
                        <span style="display: block; color: #8f98a3; font-size: 0.9em; margin-top: 2px;">Your custom transformer class</span>
                    </li>
                </ul>
            </details>
        </div>
    </div>

    <hr style="margin: 25px 0; border: none; border-top: 1px solid #e3e5e8;">

    <h2 style="font-size: 1.1em; font-weight: 600; margin-bottom: 15px;">{{ "Advanced Settings"|t('search-manager') }}</h2>

    {% set backendOptions = craft.searchManager.getPlugin().backend.getBackendOptions() %}

    {{ forms.selectField({
        label: "Search Backend"|t('search-manager'),
        instructions: "Override the global search backend for this index. Leave as 'Default' to use the backend configured in plugin settings."|t('search-manager'),
        id: 'backend',
        name: 'backend',
        value: index.backend ?? '',
        options: backendOptions,
    }) }}

    {% if backendOptions|length <= 1 %}
        {% include 'lindemannrock-base/_components/info-box' with {
            message: '<strong>No configured backends yet.</strong> <a href="' ~ cpUrl('search-manager/backends/new') ~ '">Create a backend</a> to use a different search service for this index.'
        } %}
    {% elseif index.backend %}
        {% include 'lindemannrock-base/_components/info-box' with {
            type: 'warning',
            message: '<strong>Custom Backend:</strong> This index uses a different backend than the global default. Data will be stored and searched in the selected backend.'
        } %}
    {% endif %}

</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const nameInput = document.getElementById('name');
    const handleInput = document.getElementById('handle');
    const elementTypeSelect = document.getElementById('elementType');
    const entryCriteria = document.getElementById('entry-criteria');
    const siteInputs = document.querySelectorAll('input[name="siteId[]"], input[name="siteId"]');
    const languageSelect = document.getElementById('language');
    const languagePreview = document.getElementById('language-preview');
    const detectedLanguageSpan = document.getElementById('detected-language');
    const stopwordsFileSpan = document.getElementById('stopwords-file');
    const multiSiteNote = document.getElementById('multi-site-note');
    const isNew = {{ isNew ? 'true' : 'false' }};
    let handleModifiedManually = !isNew; // Don't auto-update existing handles

    // Site ID to language mapping
    const siteLanguages = {
        {% for site in craft.app.sites.getAllSites() %}
        '{{ site.id }}': '{{ site.language|lower }}',
        {% endfor %}
    };
    const siteNames = {
        {% for site in craft.app.sites.getAllSites() %}
        '{{ site.id }}': '{{ site.name|e('js') }}',
        {% endfor %}
    };

    // Convert name to handle format
    function nameToHandle(name) {
        return name
            .toLowerCase()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-+|-+$/g, '');
    }

    // Update language preview based on selected site
    function getSelectedSiteIds() {
        return Array.from(siteInputs)
            .filter(input => input.checked)
            .map(input => input.value);
    }

    function updateLanguagePreview() {
        const selectedSiteIds = getSelectedSiteIds();
        const manualLanguage = languageSelect.value;
        const resolvedSiteIds = selectedSiteIds.length ? selectedSiteIds : Object.keys(siteLanguages);

        if (manualLanguage) {
            detectedLanguageSpan.textContent = 'Manual override: ' + manualLanguage;
            const manualBase = manualLanguage.split('-')[0];
            if (manualLanguage.includes('-')) {
                stopwordsFileSpan.textContent = manualLanguage + '.php → ' + manualBase + '.php';
            } else {
                stopwordsFileSpan.textContent = manualLanguage + '.php';
            }
            if (multiSiteNote) {
                multiSiteNote.style.display = 'none';
            }
            languagePreview.style.display = 'block';
            return;
        }

        if (resolvedSiteIds.length === 1) {
            const siteLanguage = siteLanguages[resolvedSiteIds[0]];
            if (siteLanguage) {
                detectedLanguageSpan.textContent = siteLanguage;

                const baseLang = siteLanguage.split('-')[0];
                if (siteLanguage.includes('-')) {
                    stopwordsFileSpan.textContent = siteLanguage + '.php → ' + baseLang + '.php';
                } else {
                    stopwordsFileSpan.textContent = siteLanguage + '.php';
                }
            }
            if (multiSiteNote) {
                multiSiteNote.style.display = 'none';
            }
            languagePreview.style.display = 'block';
            return;
        }

        const languageList = resolvedSiteIds.map(siteId => {
            const name = siteNames[siteId] || siteId;
            const lang = siteLanguages[siteId] || '-';
            return `${name}: ${lang}`;
        }).join(', ');

        const stopwordsList = resolvedSiteIds.map(siteId => {
            const name = siteNames[siteId] || siteId;
            const lang = siteLanguages[siteId] || '';
            if (!lang) {
                return `${name}: -`;
            }
            const baseLang = lang.split('-')[0];
            const fileLabel = lang.includes('-') ? `${lang}.php → ${baseLang}.php` : `${lang}.php`;
            return `${name}: ${fileLabel}`;
        }).join(', ');

        detectedLanguageSpan.textContent = languageList || '-';
        stopwordsFileSpan.textContent = stopwordsList || '-';
        if (multiSiteNote) {
            multiSiteNote.style.display = 'inline';
        }
        languagePreview.style.display = 'block';
    }

    // Update preview on site selection change
    siteInputs.forEach(input => {
        input.addEventListener('change', updateLanguagePreview);
    });

    // Only auto-generate handle for new indices
    if (isNew && nameInput && handleInput) {
        nameInput.addEventListener('input', function() {
            if (!handleModifiedManually) {
                handleInput.value = nameToHandle(this.value);
            }
        });

        // If user manually edits handle, stop auto-generation
        handleInput.addEventListener('input', function() {
            handleModifiedManually = true;
        });
    }

    // Show/hide criteria based on element type
    if (elementTypeSelect && entryCriteria) {
        function updateCriteriaVisibility() {
            if (elementTypeSelect.value === 'craft\\elements\\Entry') {
                entryCriteria.style.display = 'block';
            } else {
                entryCriteria.style.display = 'none';
            }
        }

        // Update on change
        elementTypeSelect.addEventListener('change', updateCriteriaVisibility);

        // Initial state
        updateCriteriaVisibility();
    }

    // Language preview updates (only if stop words enabled)
    if (siteInputs.length && languageSelect && languagePreview) {
        const stopWordsEnabled = {{ settings.enableStopWords ? 'true' : 'false' }};

        if (stopWordsEnabled) {
            languageSelect.addEventListener('change', updateLanguagePreview);

            // Initial state
            updateLanguagePreview();
        } else {
            // Hide preview if stop words disabled
            languagePreview.style.display = 'none';
        }
    }
});
</script>

{% endblock %}

{% block details %}
	{% set globalSettings = craft.searchManager.getSettings() %}

	<div class="meta">
		{{ forms.lightswitchField({
			label: 'Enabled'|t('search-manager'),
			id: 'enabled',
			name: 'enabled',
			on: index.enabled ?? true
		}) }}

		{% if globalSettings.enableAnalytics %}
			{{ forms.lightswitchField({
				label: 'Track Analytics'|t('search-manager'),
				id: 'enableAnalytics',
				name: 'enableAnalytics',
				on: index.enableAnalytics ?? true
			}) }}
		{% else %}
			{# Hidden field to preserve value when global analytics is disabled #}
			<input type="hidden" name="enableAnalytics" value="{{ index.enableAnalytics ?? true ? '1' : '0' }}">
		{% endif %}

		{{ forms.lightswitchField({
			label: 'Skip Entries Without URL'|t('search-manager'),
			instructions: 'Skip indexing entries that do not have a URL (e.g., entries from sections without URL format)'|t('search-manager'),
			id: 'skipEntriesWithoutUrl',
			name: 'skipEntriesWithoutUrl',
			on: index.skipEntriesWithoutUrl ?? false
		}) }}

		{{ forms.lightswitchField({
			label: 'Disable Stop Words'|t('search-manager'),
			instructions: 'Keep all words during indexing and search for this index.'|t('search-manager'),
			id: 'disableStopWords',
			name: 'disableStopWords',
			on: index.disableStopWords ?? false,
			disabled: not index.canEdit(),
			warning: not index.canEdit() ? "Set via config/search-manager.php. Edit the file to change."|t('search-manager') : null
		}) }}

		{% if not isNew and (currentUser.can('searchManager:rebuildIndices') or currentUser.can('searchManager:clearIndices')) %}
			<div class="field">
				<div class="heading">
					<label>{{ 'Actions'|t('search-manager') }}</label>
				</div>
				<div class="input">
					<div class="btngroup" style="width: 100%;">
						<button type="button" class="btn menubtn" data-icon="settings" style="width: 100%;">{{ "Index Actions"|t('search-manager') }}</button>
						<div class="menu">
							<ul>
								{% if currentUser.can('searchManager:rebuildIndices') %}
								<li>
									<a class="formsubmit" data-action="search-manager/indices/rebuild" data-params='{"indexId":{{ index.id }}}' data-confirm="{{ 'This will rebuild the entire index. Continue?'|t('search-manager') }}" data-redirect="{{ cpUrl('search-manager/indices/edit/' ~ index.id)|hash }}">
										{{ "Rebuild Index"|t('search-manager') }}
									</a>
								</li>
								{% if index.effectiveBackendType in ['algolia', 'meilisearch', 'typesense'] %}
								<li>
									<a id="sync-count-btn" href="#">
										{{ "Sync Count from Backend"|t('search-manager') }}
									</a>
								</li>
								{% endif %}
								{% endif %}
								{% if currentUser.can('searchManager:clearIndices') %}
								<li>
									<a class="formsubmit error" data-action="search-manager/indices/clear" data-params='{"indexId":{{ index.id }}}' data-confirm="{{ 'This will remove all documents from the index. Continue?'|t('search-manager') }}" data-redirect="{{ cpUrl('search-manager/indices/edit/' ~ index.id)|hash }}">
										{{ "Clear Index"|t('search-manager') }} ({{ index.documentCount|number_format }})
									</a>
								</li>
								{% endif %}
								{% if currentUser.can('searchManager:clearCache') and (globalSettings.enableCache or globalSettings.enableAutocompleteCache) %}
								<li><hr class="padded"></li>
								<li>
									<a id="clear-index-cache-btn" href="#">
										{{ "Clear Index Cache"|t('search-manager') }}
									</a>
								</li>
								{% endif %}
							</ul>
						</div>
					</div>
				</div>
			</div>
		{% endif %}
	</div>

	{% if not isNew %}
		<hr>
		<dl class="meta read-only">
				<div class="data">
					<dt class="heading">{{ 'Status'|t('search-manager') }}</dt>
					<dd class="value">
						<span class="status {{ index.enabled ? 'live' : 'disabled' }}"></span>
						<span>{{ index.enabled ? 'Live'|t('search-manager') : 'Disabled'|t('search-manager') }}</span>
					</dd>
				</div>
				<div class="data">
				<dt class="heading">{{ 'Backend'|t('search-manager') }}</dt>
				<dd class="value">
					{% set configuredBackend = index.configuredBackend %}
					{% set defaultBackendHandle = craft.searchManager.getSettings().defaultBackendHandle %}
					{% set defaultConfiguredBackend = defaultBackendHandle ? craft.searchManager.getPlugin().getConfiguredBackend(defaultBackendHandle) : null %}
					{% if index.backend %}
						{# Show configured backend name #}
						{% if configuredBackend %}
							{{ configuredBackend.name }}
						{% else %}
							{{ index.backend }}&nbsp;<span style="color: #ef4444; font-size: 0.85em;">(not found)</span>
						{% endif %}
					{% else %}
						{# Show default backend from settings #}
						{% if defaultBackendHandle %}
							{% if defaultConfiguredBackend %}
								{{ defaultConfiguredBackend.name }}
							{% else %}
								{{ defaultBackendHandle }}&nbsp;<span style="color: #8f98a3; font-size: 0.85em;">(default, not found)</span>
							{% endif %}
						{% else %}
							<span class="light">{{ 'No default backend'|t('search-manager') }}</span>
						{% endif %}
					{% endif %}
					{% set backendType = index.effectiveBackendType %}
					{% if backendType %}
						&nbsp;{{ indexMacros.backendBadge(backendType, configuredBackend ? configuredBackend.getTypeLabel() : (backendType|capitalize)) }}
					{% endif %}
				</dd>
			</div>
					<div class="data">
						<dt class="heading">{{ 'Documents'|t('search-manager') }}</dt>
						<dd class="value">
							{% set expected = index.expectedCount %}
							{% if index.documentCount == expected %}
								{% include 'lindemannrock-base/_components/status-dot' with { value: 'ok', colorSet: 'healthStatus' } only %}
							{% elseif index.documentCount < expected %}
								{% include 'lindemannrock-base/_components/status-dot' with { value: 'low', colorSet: 'healthStatus' } only %}
							{% else %}
								{% include 'lindemannrock-base/_components/status-dot' with { value: 'high', colorSet: 'healthStatus' } only %}
							{% endif %}
							{{ index.documentCount }}&nbsp;/&nbsp;{{ expected }}
						</dd>
					</div>
				{% if index.lastIndexed %}
					<div class="data">
						<dt class="heading">{{ 'Last indexed'|t('search-manager') }}</dt>
						<dd class="value">{{ index.lastIndexed|datetime('short') }}</dd>
					</div>
				{% endif %}
			</dl>
		</fieldset>
	{% endif %}
{% endblock %}

{% js %}
	// Set platform-specific keyboard shortcut
	const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
	const saveShortcut = document.getElementById('save-shortcut');
	if (saveShortcut) {
		saveShortcut.textContent = isMac ? '⌘S' : 'Ctrl+S';
	}

	// Clear index cache handler
	const clearCacheBtn = document.getElementById('clear-index-cache-btn');
	if (clearCacheBtn) {
		clearCacheBtn.addEventListener('click', function(e) {
			e.preventDefault();
			if (!confirm('{{ "Clear cached search results and autocomplete suggestions for this index?"|t('search-manager')|e('js') }}')) {
				return;
			}

			Craft.sendActionRequest('POST', 'search-manager/indices/clear-cache', {
				data: { indexId: {{ index.id }} }
			}).then(function(response) {
				if (response.data.success) {
					Craft.cp.displayNotice(response.data.message || '{{ "Cache cleared successfully"|t('search-manager')|e('js') }}');
				} else {
					Craft.cp.displayError(response.data.error || '{{ "Failed to clear cache"|t('search-manager')|e('js') }}');
				}
			}).catch(function(error) {
				Craft.cp.displayError('{{ "Failed to clear cache"|t('search-manager')|e('js') }}');
			});
		});
	}

	const syncCountBtn = document.getElementById('sync-count-btn');
	if (syncCountBtn) {
		syncCountBtn.addEventListener('click', function(e) {
			e.preventDefault();

			Craft.sendActionRequest('POST', 'search-manager/indices/sync-count', {
				data: { indexId: '{{ index.id ?: index.handle }}' }
			}).then(function(response) {
				if (response.data.success) {
					Craft.cp.displayNotice(response.data.message || '{{ "Count synced successfully"|t('search-manager')|e('js') }}');
					setTimeout(() => window.location.reload(), 1000);
				} else {
					Craft.cp.displayError(response.data.error || '{{ "Failed to sync count"|t('search-manager')|e('js') }}');
				}
			}).catch(function(error) {
				Craft.cp.displayError('{{ "Failed to sync count"|t('search-manager')|e('js') }}');
			});
		});
	}
{% endjs %}
