{% extends "_layouts/cp" %}
{% set title = isNew ? "Create Index"|t('search-manager') : "Edit Index: {name}"|t('search-manager', { name: index.name }) %}
{% set selectedSubnavItem = 'indices' %}
{% set crumbs = [
    { label: searchHelper.fullName, url: url('search-manager') },
    { label: 'Indices'|t('search-manager'), url: url('search-manager/indices') },
    { label: isNew ? 'New Index'|t('search-manager') : index.name }
] %}
{% set fullPageForm = true %}
{% set saveShortcutRedirect = cpUrl('search-manager/indices/edit/{id}') %}
{% set retainScrollOnSaveShortcut = true %}

{% import "_includes/forms" as forms %}

{% block actionButton %}
	<div class="btngroup submit">
		<button type="submit" class="btn submit">{{ "Save"|t('app') }}</button>
		<button type="button" class="btn submit menubtn"></button>
		<div class="menu">
			<ul role="listbox">
				<li>
					<a class="formsubmit" role="option" tabindex="0" data-redirect="{{ cpUrl('search-manager/indices/edit/{id}')|hash }}">
						<span class="label">{{ 'Save and continue editing'|t('app') }}</span>
						<span class="shortcut" id="save-shortcut"></span>
					</a>
				</li>
			</ul>
		</div>
	</div>
	{% if not isNew and index.canEdit() and currentUser.can('searchManager:deleteIndices') %}
		<button type="button" id="action-btn" class="btn menubtn action-btn hairline-dark m" title="{{ 'Actions'|t('app') }}" aria-controls="action-menu" aria-label="{{ 'Actions'|t('app') }}" data-disclosure-trigger="true" aria-expanded="false"></button>
		<div id="action-menu" class="menu menu--disclosure">
			<ul>
				<li>
					<button class="menu-item error formsubmit" data-destructive data-action="search-manager/indices/delete" data-params='{"indexId":{{ index.id }}}' data-confirm="{{ 'Are you sure you want to delete this index?'|t('search-manager') }}" data-redirect="{{ 'search-manager/indices'|hash }}" data-headers='{"Accept":"application/json"}'>
						<span class="icon">{{ svg('@app/icons/trash.svg') }}</span>
						<span class="menu-item-label">{{ "Delete"|t('app') }}</span>
					</button>
				</li>
			</ul>
		</div>
	{% endif %}
{% endblock %}

{% block content %}

<form method="post" accept-charset="UTF-8">
    {{ actionInput('search-manager/indices/save') }}
    {{ csrfInput() }}
    {{ redirectInput('search-manager/indices') }}

    {% if not isNew %}
        {{ hiddenInput('indexId', index.id) }}
    {% endif %}

    {{ forms.textField({
        first: true,
        label: "Name"|t('search-manager'),
        instructions: "The display name for this index"|t('search-manager'),
        id: 'name',
        name: 'name',
        value: index.name,
        required: true,
        autofocus: true,
    }) }}

    {{ forms.textField({
        label: "Handle"|t('search-manager'),
        instructions: "Unique identifier for this index (used in code)"|t('search-manager'),
        id: 'handle',
        name: 'handle',
        value: index.handle,
        required: true,
        class: 'code',
    }) }}

    {{ forms.selectField({
        label: "Element Type"|t('search-manager'),
        instructions: "The type of elements to index"|t('search-manager'),
        id: 'elementType',
        name: 'elementType',
        value: index.elementType,
        required: true,
        options: {
            'craft\\elements\\Entry': 'Entries',
            'craft\\elements\\Asset': 'Assets',
            'craft\\elements\\Category': 'Categories',
            'craft\\elements\\User': 'Users',
        }
    }) }}

    <div id="entry-criteria" {% if index.elementType != 'craft\\elements\\Entry' %}style="display:none;"{% endif %}>
        {% set sectionOptions = [] %}
        {% for section in craft.app.entries.getAllSections() %}
            {% set sectionOptions = sectionOptions|merge([{
                label: section.name,
                value: section.handle
            }]) %}
        {% endfor %}

        {{ forms.checkboxGroupField({
            label: "Sections"|t('search-manager'),
            instructions: "Which sections to index (leave all unchecked for all sections)"|t('search-manager'),
            id: 'sections',
            name: 'criteria[sections]',
            options: sectionOptions,
            values: index.criteria.sections ?? [],
        }) }}
    </div>

    {{ forms.selectField({
        label: "Site"|t('search-manager'),
        instructions: "Which site to index (select 'All Sites' to index all sites)"|t('search-manager'),
        id: 'siteId',
        name: 'siteId',
        value: index.siteId,
        options: [{ label: 'All Sites'|t('search-manager'), value: '' }]|merge(craft.app.sites.getAllSites()|map(s => { label: s.name, value: s.id })),
    }) }}

    {% set settings = craft.searchManager.getSettings() %}
    {% if settings.enableStopWords %}
        {% set languageOptions = { '': 'Auto-detect from site (recommended)'|t('search-manager') } %}
        {% for site in craft.app.sites.getAllSites() %}
            {% set langCode = site.language|lower %}
            {% set languageOptions = languageOptions|merge({ (langCode): site.name ~ ' (' ~ langCode ~ ')' }) %}
        {% endfor %}

        {{ forms.selectField({
            label: "Language"|t('search-manager'),
            instructions: "Select 'Auto-detect from site' to automatically use the site's language setting. Only override if you need different stop words than the site language."|t('search-manager'),
            id: 'language',
            name: 'language',
            value: index.language,
            options: languageOptions,
            warning: index.language ? 'Manual override active. Language will NOT auto-detect from site.'|t('search-manager') : null,
        }) }}
    {% else %}
        <div class="field">
            <div class="heading">
                <label>{{ "Language"|t('search-manager') }}</label>
            </div>
            <div class="notice" style="margin-top: 5px;">
                {{ "Stop words filtering is currently disabled in plugin settings. Language selection is not available."|t('search-manager') }}
                <a href="{{ cpUrl('search-manager/settings/language') }}">{{ "Enable stop words"|t('search-manager') }}</a>
            </div>
        </div>
        {{ hiddenInput('language', '') }}
    {% endif %}

    <div id="language-preview" style="margin-top: -15px; margin-bottom: 20px; padding: 10px; background: #f9fafb; border-left: 3px solid #0d78f2; display: none;">
        <strong>{{ "Auto-detected language:"|t('search-manager') }}</strong> <span id="detected-language">-</span><br>
        <small style="color: #666;">{{ "Stop words file:"|t('search-manager') }} <code id="stopwords-file">-</code></small>
    </div>

    {{ forms.textField({
        label: "Transformer Class"|t('search-manager'),
        instructions: "Custom transformer class (optional - AutoTransformer is used by default)"|t('search-manager'),
        id: 'transformerClass',
        name: 'transformerClass',
        value: index.transformerClass,
        required: false,
        class: 'code',
        placeholder: 'lindemannrock\\searchmanager\\transformers\\AutoTransformer',
        tip: "Leave blank to use AutoTransformer (automatically indexes all fields including Entries, Categories, Tags, Matrix, Table, and custom fields). Only specify a custom class for advanced requirements."|t('search-manager'),
        warning: index.transformerClass ? ("Custom transformer active: " ~ index.transformerClass)|t('search-manager') : null,
    }) }}

    {# Helpful transformer examples #}
    <div class="field" style="margin-top: -10px;">
        <div class="heading">
            <label style="font-size: 0.9em; font-weight: normal; color: #596673;">{{ "Available Transformers"|t('search-manager') }}</label>
        </div>
        <div style="font-size: 0.85em; color: #596673; line-height: 1.6;">
            <div style="margin-bottom: 8px;">
                <strong style="color: #0d78f2;">Recommended:</strong> Leave blank for <code style="background: #f3f7fc; padding: 2px 6px; border-radius: 3px;">AutoTransformer</code> (default)
            </div>
            <div style="padding-left: 20px; border-left: 2px solid #e3e5e8; margin-bottom: 12px;">
                <div style="margin-bottom: 4px;">✓ Automatically handles all field types</div>
                <div style="margin-bottom: 4px;">✓ Traverses relational fields (Entries, Categories, Tags, Assets)</div>
                <div style="margin-bottom: 4px;">✓ Indexes Matrix blocks, Table fields, and custom fields</div>
                <div>✓ No configuration needed</div>
            </div>
            <details style="margin-top: 10px;">
                <summary style="cursor: pointer; color: #0d78f2; font-weight: 500;">Custom transformer examples</summary>
                <ul style="margin: 8px 0 0 20px; padding: 0;">
                    <li style="margin-bottom: 6px;">
                        <code style="background: #f3f7fc; padding: 2px 6px; border-radius: 3px;">lindemannrock\searchmanager\transformers\EntryTransformer</code>
                        <span style="display: block; color: #8f98a3; font-size: 0.9em; margin-top: 2px;">Basic entry fields only</span>
                    </li>
                    <li style="margin-bottom: 6px;">
                        <code style="background: #f3f7fc; padding: 2px 6px; border-radius: 3px;">modules\transformers\MyCustomTransformer</code>
                        <span style="display: block; color: #8f98a3; font-size: 0.9em; margin-top: 2px;">Your custom transformer class</span>
                    </li>
                </ul>
            </details>
        </div>
    </div>

</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const nameInput = document.getElementById('name');
    const handleInput = document.getElementById('handle');
    const elementTypeSelect = document.getElementById('elementType');
    const entryCriteria = document.getElementById('entry-criteria');
    const siteSelect = document.getElementById('siteId');
    const languageSelect = document.getElementById('language');
    const languagePreview = document.getElementById('language-preview');
    const detectedLanguageSpan = document.getElementById('detected-language');
    const stopwordsFileSpan = document.getElementById('stopwords-file');
    const isNew = {{ isNew ? 'true' : 'false' }};
    let handleModifiedManually = !isNew; // Don't auto-update existing handles

    // Site ID to language mapping
    const siteLanguages = {
        {% for site in craft.app.sites.getAllSites() %}
        '{{ site.id }}': '{{ site.language|lower }}',
        {% endfor %}
    };

    // Convert name to handle format
    function nameToHandle(name) {
        return name
            .toLowerCase()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-+|-+$/g, '');
    }

    // Update language preview based on selected site
    function updateLanguagePreview() {
        const selectedSiteId = siteSelect.value;
        const manualLanguage = languageSelect.value;

        if (!selectedSiteId || manualLanguage) {
            // Hide preview if All Sites or manual language selected
            languagePreview.style.display = 'none';
            return;
        }

        const siteLanguage = siteLanguages[selectedSiteId];
        if (siteLanguage) {
            detectedLanguageSpan.textContent = siteLanguage;

            // Show fallback chain
            const baseLang = siteLanguage.split('-')[0];
            if (siteLanguage.includes('-')) {
                stopwordsFileSpan.textContent = siteLanguage + '.php → ' + baseLang + '.php';
            } else {
                stopwordsFileSpan.textContent = siteLanguage + '.php';
            }

            languagePreview.style.display = 'block';
        }
    }

    // Only auto-generate handle for new indices
    if (isNew && nameInput && handleInput) {
        nameInput.addEventListener('input', function() {
            if (!handleModifiedManually) {
                handleInput.value = nameToHandle(this.value);
            }
        });

        // If user manually edits handle, stop auto-generation
        handleInput.addEventListener('input', function() {
            handleModifiedManually = true;
        });
    }

    // Show/hide criteria based on element type
    if (elementTypeSelect && entryCriteria) {
        function updateCriteriaVisibility() {
            if (elementTypeSelect.value === 'craft\\elements\\Entry') {
                entryCriteria.style.display = 'block';
            } else {
                entryCriteria.style.display = 'none';
            }
        }

        // Update on change
        elementTypeSelect.addEventListener('change', updateCriteriaVisibility);

        // Initial state
        updateCriteriaVisibility();
    }

    // Language preview updates (only if stop words enabled)
    if (siteSelect && languageSelect && languagePreview) {
        const stopWordsEnabled = {{ settings.enableStopWords ? 'true' : 'false' }};

        if (stopWordsEnabled) {
            siteSelect.addEventListener('change', updateLanguagePreview);
            languageSelect.addEventListener('change', updateLanguagePreview);

            // Initial state
            updateLanguagePreview();
        } else {
            // Hide preview if stop words disabled
            languagePreview.style.display = 'none';
        }
    }
});
</script>

{% endblock %}

{% block details %}
	<fieldset>
		<legend class="h6">{{ 'Status'|t('search-manager') }}</legend>
		<div class="meta">
			{{ forms.lightswitchField({
				label: 'Enabled'|t('search-manager'),
				id: 'enabled',
				name: 'enabled',
				on: index.enabled ?? true
			}) }}

			{% if not isNew and (currentUser.can('searchManager:rebuildIndices') or currentUser.can('searchManager:clearIndices')) %}
				<div class="field" style="margin-top: 15px;">
					<div class="heading">
						<label>{{ 'Actions'|t('search-manager') }}</label>
					</div>
					<div class="input">
						<div class="btngroup" style="width: 100%;">
							<button type="button" class="btn menubtn" data-icon="settings" style="width: 100%;">{{ "Index Actions"|t('search-manager') }}</button>
							<div class="menu">
								<ul>
									{% if currentUser.can('searchManager:rebuildIndices') %}
									<li>
										<a class="formsubmit" data-action="search-manager/indices/rebuild" data-params='{"indexId":{{ index.id }}}' data-confirm="{{ 'This will rebuild the entire index. Continue?'|t('search-manager') }}" data-redirect="{{ cpUrl('search-manager/indices/edit/' ~ index.id)|hash }}">
											{{ "Rebuild Index"|t('search-manager') }}
										</a>
									</li>
									{% endif %}
									{% if currentUser.can('searchManager:clearIndices') %}
									<li>
										<a class="formsubmit error" data-action="search-manager/indices/clear" data-params='{"indexId":{{ index.id }}}' data-confirm="{{ 'This will remove all documents from the index. Continue?'|t('search-manager') }}" data-redirect="{{ cpUrl('search-manager/indices/edit/' ~ index.id)|hash }}">
											{{ "Clear Index"|t('search-manager') }}
										</a>
									</li>
									{% endif %}
								</ul>
							</div>
						</div>
					</div>
				</div>
			{% endif %}
		</div>
	</fieldset>

	{% if not isNew %}
		<fieldset>
			<dl class="meta read-only">
				<div class="data">
					<dt class="heading">{{ 'Status'|t('search-manager') }}</dt>
					<dd class="value">
						<span class="status {{ index.enabled ? 'live' : 'disabled' }}"></span>
						<span>{{ index.enabled ? 'Live'|t('search-manager') : 'Disabled'|t('search-manager') }}</span>
					</dd>
				</div>
				<div class="data">
					<dt class="heading">{{ 'Documents'|t('search-manager') }}</dt>
					<dd class="value">{{ index.documentCount }}</dd>
				</div>
				{% if index.lastIndexed %}
					<div class="data">
						<dt class="heading">{{ 'Last indexed'|t('search-manager') }}</dt>
						<dd class="value">{{ index.lastIndexed|datetime('short') }}</dd>
					</div>
				{% endif %}
			</dl>
		</fieldset>
	{% endif %}
{% endblock %}

{% js %}
	// Set platform-specific keyboard shortcut
	const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
	const saveShortcut = document.getElementById('save-shortcut');
	if (saveShortcut) {
		saveShortcut.textContent = isMac ? '⌘S' : 'Ctrl+S';
	}
{% endjs %}
