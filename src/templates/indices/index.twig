{% extends 'lindemannrock-base/_layouts/cp-table' %}

{% set plugin = craft.app.plugins.getPlugin('search-manager') %}
{% set settings = plugin.getSettings() %}
{% set globalSettings = craft.searchManager.getSettings() %}

{# Get query parameters #}
{% set search = craft.app.request.getParam('search', '') %}
{% set statusFilter = craft.app.request.getParam('status', 'all') %}
{% set sourceFilter = craft.app.request.getParam('source', 'all') %}
{% set backendFilter = craft.app.request.getParam('backend', 'all') %}
{% set sort = craft.app.request.getParam('sort', 'source') %}
{% set dir = craft.app.request.getParam('dir', 'asc') %}
{% set page = craft.app.request.getParam('page', 1)|number_format(0, '', '') %}
{% set limit = 50 %}
{% set offset = (page - 1) * limit %}

{# Permission checks #}
{% set canCreate = currentUser.can('searchManager:createIndices') %}
{% set canEdit = currentUser.can('searchManager:editIndices') %}
{% set canDelete = currentUser.can('searchManager:deleteIndices') %}
{% set canRebuild = currentUser.can('searchManager:rebuildIndices') %}
{% set canClear = currentUser.can('searchManager:clearIndices') %}
{% set canClearCache = currentUser.can('searchManager:clearCache') %}

{# Filter indices based on filters #}
{% set filteredIndices = indices %}

{# Status filter #}
{% if statusFilter == 'enabled' %}
    {% set filteredIndices = filteredIndices|filter(i => i.enabled) %}
{% elseif statusFilter == 'disabled' %}
    {% set filteredIndices = filteredIndices|filter(i => not i.enabled) %}
{% endif %}

{# Source filter #}
{% if sourceFilter == 'config' %}
    {% set filteredIndices = filteredIndices|filter(i => i.source == 'config') %}
{% elseif sourceFilter == 'database' %}
    {% set filteredIndices = filteredIndices|filter(i => i.source != 'config') %}
{% endif %}

{# Backend filter #}
{% if backendFilter != 'all' %}
    {% set filteredIndices = filteredIndices|filter(i => i.effectiveBackendType == backendFilter) %}
{% endif %}

{# Search filter #}
{% if search %}
    {% set filteredIndices = filteredIndices|filter(i => search|lower in i.name|lower or search|lower in i.handle|lower) %}
{% endif %}

{# Sort #}
{% if sort == 'name' %}
    {% set filteredIndices = dir == 'asc' ? filteredIndices|sort((a, b) => a.name|lower <=> b.name|lower) : filteredIndices|sort((a, b) => b.name|lower <=> a.name|lower) %}
{% elseif sort == 'handle' %}
    {% set filteredIndices = dir == 'asc' ? filteredIndices|sort((a, b) => a.handle|lower <=> b.handle|lower) : filteredIndices|sort((a, b) => b.handle|lower <=> a.handle|lower) %}
{% elseif sort == 'elementType' %}
    {% set filteredIndices = dir == 'asc' ? filteredIndices|sort((a, b) => a.elementType <=> b.elementType) : filteredIndices|sort((a, b) => b.elementType <=> a.elementType) %}
{% elseif sort == 'source' %}
    {% set filteredIndices = dir == 'asc' ? filteredIndices|sort((a, b) => (a.source ?? '') <=> (b.source ?? '')) : filteredIndices|sort((a, b) => (b.source ?? '') <=> (a.source ?? '')) %}
{% elseif sort == 'enabled' %}
    {% set filteredIndices = dir == 'asc' ? filteredIndices|sort((a, b) => a.enabled <=> b.enabled) : filteredIndices|sort((a, b) => b.enabled <=> a.enabled) %}
{% endif %}

{# Pagination #}
{% set totalCount = filteredIndices|length %}
{% set paginatedItems = filteredIndices|slice(offset, limit) %}

{# Build columns array - Analytics column is conditional #}
{% set columns = [
    {key: 'name', label: 'Name'|t('search-manager'), sortable: true},
    {key: 'handle', label: 'Handle'|t('search-manager'), sortable: true, hideable: true},
    {key: 'elementType', label: 'Element Type'|t('search-manager'), sortable: true, hideable: true},
    {key: 'backend', label: 'Backend'|t('search-manager'), hideable: true},
    {key: 'type', label: 'Type'|t('search-manager'), hideable: true},
    {key: 'craft', label: 'Craft'|t('search-manager'), hideable: true},
    {key: 'indexed', label: 'Indexed'|t('search-manager'), hideable: true},
    {key: 'lastIndexed', label: 'Last Indexed'|t('search-manager'), hideable: true},
    {key: 'source', label: 'Source'|t('search-manager'), sortable: true, hideable: true},
    {key: 'enabled', label: 'Status'|t('search-manager'), sortable: true, hideable: true},
] %}

{% if globalSettings.enableAnalytics %}
    {% set columns = columns|merge([{key: 'analytics', label: 'Analytics'|t('search-manager'), hideable: true}]) %}
{% endif %}

{% set tableConfig = {
    plugin: {
        handle: 'search-manager',
        name: searchHelper.fullName,
    },
    page: {
        title: 'Indices'|t('search-manager'),
        subnav: 'indices',
        crumbs: [
            { label: searchHelper.fullName, url: url('search-manager') },
            { label: 'Indices'|t('search-manager'), url: url('search-manager/indices') }
        ],
    },
    filters: [
        {
            type: 'status',
            param: 'status',
            current: statusFilter,
            label: 'All'|t('search-manager'),
            groups: [
                {
                    param: 'status',
                    current: statusFilter,
                    options: [
                        {value: 'all', label: 'All'|t('search-manager'), status: 'all'},
                        {value: 'enabled', label: 'Enabled'|t('search-manager'), status: 'green'},
                        {value: 'disabled', label: 'Disabled'|t('search-manager'), status: 'disabled'},
                    ],
                },
                {
                    header: 'Config Source'|t('search-manager'),
                    param: 'source',
                    current: sourceFilter,
                    colorSet: 'configSource',
                    options: [
                        {value: 'all', label: 'All Sources'|t('search-manager'), status: 'all'},
                        {value: 'config', label: 'Config File'|t('search-manager'), colorKey: 'config'},
                        {value: 'database', label: 'Database'|t('search-manager'), colorKey: 'database'},
                    ],
                },
                {
                    header: 'Backend'|t('search-manager'),
                    param: 'backend',
                    current: backendFilter,
                    colorSet: 'backendType',
                    options: [
                        {value: 'all', label: 'All Backends'|t('search-manager'), status: 'all'},
                        {value: 'mysql', label: 'MySQL'|t('search-manager'), colorKey: 'mysql'},
                        {value: 'pgsql', label: 'PostgreSQL'|t('search-manager'), colorKey: 'pgsql'},
                        {value: 'file', label: 'File'|t('search-manager'), colorKey: 'file'},
                        {value: 'redis', label: 'Redis'|t('search-manager'), colorKey: 'redis'},
                        {value: 'typesense', label: 'Typesense'|t('search-manager'), colorKey: 'typesense'},
                        {value: 'algolia', label: 'Algolia'|t('search-manager'), colorKey: 'algolia'},
                        {value: 'meilisearch', label: 'Meilisearch'|t('search-manager'), colorKey: 'meilisearch'},
                    ],
                },
            ],
        },
    ],
    search: {
        placeholder: 'Search indices...'|t('search-manager'),
        value: search,
    },
    sort: {
        field: sort,
        direction: dir,
    },
    table: {
        columns: columns,
        items: paginatedItems,
        emptyMessage: 'No indices found.'|t('search-manager'),
        hasConfigItems: true,
    },
    pagination: {
        page: page,
        limit: limit,
        totalCount: totalCount,
        itemLabel: {singular: 'index'|t('search-manager'), plural: 'indices'|t('search-manager')},
    },
    checkboxes: canEdit or canDelete,
    newButton: {
        url: url('search-manager/indices/create'),
        label: 'New Index'|t('search-manager'),
        permission: 'searchManager:createIndices',
    },
} %}

{% block beforeTable %}
    {% if collisionHandles is defined and collisionHandles|length %}
        {% set boldHandles = [] %}
        {% for handle in collisionHandles %}
            {% set boldHandles = boldHandles|merge(['<strong>' ~ handle ~ '</strong>']) %}
        {% endfor %}
        {% set warningMessage %}
        <strong>{{ 'Warning'|t('search-manager') }}:</strong>
        {{ 'These index handles exist in both config/search-manager.php and the database:'|t('search-manager') }} {{ boldHandles|join(', ')|raw }}.
        {{ 'Config takes precedence; database entries with the same handle are ignored.'|t('search-manager') }}
        {{ 'Update your config/search-manager.php or remove the database entries to resolve this.'|t('search-manager') }}
        {% endset %}
        <div class="lr-info-box-table-wrapper">
            {% include 'lindemannrock-base/_components/info-box' with {
                message: warningMessage,
                type: 'warning',
                margin: 'none',
                stretch: true,
            } %}
        </div>
    {% endif %}
{% endblock %}

{% block tableRow %}
    {% set isConfig = item.source == 'config' %}
    {% set hasCollision = collisionHandles is defined and item.handle in collisionHandles %}
    {% set indexBackendType = item.effectiveBackendType %}
    {% set configuredBackend = item.configuredBackend %}

    {# Name #}
    <td data-column="name">
        {% if item.canEdit() %}
            <a class="label-link" href="{{ url('search-manager/indices/edit/' ~ item.id) }}">
                <span>{{ item.name }}</span>
            </a>
        {% else %}
            <a class="label-link" href="{{ url('search-manager/indices/view/' ~ item.handle) }}">
                <span>{{ item.name }}</span>
            </a>
            <span class="lr-config-info-icon" data-config="{{ item.rawConfigDisplay|e('html_attr') }}" data-config-source="config/search-manager.php"></span>
        {% endif %}
    </td>

    {# Handle #}
    <td data-column="handle">
        <code>{{ item.handle }}</code>
    </td>

    {# Element Type #}
    <td data-column="elementType">
        {{ item.elementType|split('\\')|last }}
    </td>

    {# Backend #}
    <td data-column="backend">
        {% if configuredBackend %}
            {% if configuredBackend.source == 'config' %}
                <a href="{{ url('search-manager/backends/view/' ~ configuredBackend.handle) }}">{{ configuredBackend.name }}</a>
            {% else %}
                <a href="{{ url('search-manager/backends/' ~ configuredBackend.id) }}">{{ configuredBackend.name }}</a>
            {% endif %}
        {% elseif indexBackendType %}
            <span class="light">{{ indexBackendType|capitalize }}</span>
        {% else %}
            <span class="light">{{ 'Default'|t('search-manager') }}</span>
        {% endif %}
    </td>

    {# Type (backend badge) #}
    <td data-column="type">
        {% if indexBackendType %}
            {% include 'lindemannrock-base/_components/badge' with {
                label: indexBackendType|upper,
                value: indexBackendType,
                colorSet: 'backendType',
            } only %}
        {% endif %}
    </td>

    {# Craft (expected count) #}
    <td data-column="craft">
        {{ item.expectedCount }}
    </td>

    {# Indexed (document count) #}
    <td data-column="indexed">
        {% set expected = item.expectedCount %}
        {% if item.documentCount == expected %}
            <span class="lr-text-green">{{ item.documentCount }}</span>
        {% elseif item.documentCount < expected %}
            <span class="lr-text-amber" title="{{ expected - item.documentCount }} missing">{{ item.documentCount }}</span>
        {% else %}
            <span class="lr-text-red" title="{{ item.documentCount - expected }} stale">{{ item.documentCount }}</span>
        {% endif %}
    </td>

    {# Last Indexed #}
    <td data-column="lastIndexed">
        {% if item.lastIndexed %}
            {{ item.lastIndexed|lrDatetime('short') }}
        {% else %}
            <span class="light">{{ "Never"|t('search-manager') }}</span>
        {% endif %}
    </td>

    {# Source #}
    <td data-column="source">
        {% include 'lindemannrock-base/_components/badge' with {
            label: item.source == 'config' ? 'Config'|t('search-manager') : 'Database'|t('search-manager'),
            value: item.source == 'config' ? 'config' : 'database',
            colorSet: 'configSource',
        } only %}
    </td>

    {# Status #}
    <td data-column="enabled">
        {% include 'lindemannrock-base/_components/badge' with {
            label: item.enabled ? 'Enabled'|t('search-manager') : 'Disabled'|t('search-manager'),
            value: item.enabled ? 'enabled' : 'disabled',
            colorSet: 'status',
        } only %}
    </td>

    {# Analytics (conditional) #}
    {% if globalSettings.enableAnalytics %}
        <td data-column="analytics">
            {% include 'lindemannrock-base/_components/badge' with {
                label: item.enableAnalytics ? 'Enabled'|t('search-manager') : 'Disabled'|t('search-manager'),
                value: item.enableAnalytics ? 'enabled' : 'disabled',
                colorSet: 'status',
            } only %}
        </td>
    {% endif %}
{% endblock %}

{% block rowActions %}
    {% set isConfig = item.source == 'config' %}
    {% set indexBackendType = item.effectiveBackendType %}

    <td class="thin lr-text-end">
        <button type="button" class="btn menubtn" data-icon="settings" title="{{ 'Actions'|t('search-manager') }}"></button>
        <div class="menu">
            <ul>
                {% if item.canEdit() %}
                    {% if canEdit %}
                        <li>
                            <a href="{{ url('search-manager/indices/edit/' ~ item.id) }}">
                                {{ 'Edit'|t('search-manager') }}
                            </a>
                        </li>
                    {% endif %}
                {% else %}
                    <li>
                        <a href="{{ url('search-manager/indices/view/' ~ item.handle) }}">
                            {{ 'View'|t('search-manager') }}
                        </a>
                    </li>
                {% endif %}

                {% if canRebuild %}
                    <li><hr class="padded"></li>
                    <li>
                        <a class="index-action" data-action="rebuild" data-id="{{ item.id ?: item.handle }}" data-name="{{ item.name }}">
                            {{ 'Rebuild Index'|t('search-manager') }}
                        </a>
                    </li>
                    {% if indexBackendType in ['algolia', 'meilisearch', 'typesense'] %}
                        <li>
                            <a class="index-action" data-action="sync-count" data-id="{{ item.id ?: item.handle }}" data-name="{{ item.name }}">
                                {{ 'Sync Count from Backend'|t('search-manager') }}
                            </a>
                        </li>
                    {% endif %}
                {% endif %}

                {% if canClear %}
                    <li>
                        <a class="index-action" data-action="clear" data-id="{{ item.id ?: item.handle }}" data-name="{{ item.name }}">
                            {{ 'Clear Index Data'|t('search-manager') }} ({{ item.documentCount|number_format }})
                        </a>
                    </li>
                {% endif %}

                {% if canClearCache and (globalSettings.enableCache or globalSettings.enableAutocompleteCache) %}
                    <li>
                        <a class="index-action" data-action="clear-cache" data-id="{{ item.id ?: item.handle }}" data-name="{{ item.name }}">
                            {{ 'Clear Index Cache'|t('search-manager') }}
                        </a>
                    </li>
                {% endif %}

                {% if item.canEdit() and canDelete %}
                    <li><hr class="padded"></li>
                    <li>
                        <a class="index-action error" data-action="delete" data-id="{{ item.id ?: item.handle }}" data-name="{{ item.name }}">
                            {{ 'Delete Index'|t('search-manager') }}
                        </a>
                    </li>
                {% endif %}
            </ul>
        </div>
    </td>
{% endblock %}

{% block bulkActions %}
    {% if canEdit %}
        <button type="button" class="btn menubtn secondary" id="lr-bulk-status-btn">
            {{ 'Set status'|t('app') }}
        </button>
        <div class="menu">
            <ul>
                <li><a id="lr-bulk-enable-action">{{ 'Enable'|t('search-manager') }}</a></li>
                <li><a id="lr-bulk-disable-action">{{ 'Disable'|t('search-manager') }}</a></li>
            </ul>
        </div>
    {% endif %}

    {% if canDelete %}
        <button type="button" class="btn secondary" id="lr-bulk-delete-btn">
            {{ 'Delete'|t('search-manager') }} (<span id="lr-selected-count">0</span>)
        </button>
    {% endif %}
{% endblock %}

{% block scripts %}
<script>
(function() {
    // Initialize bulk status menu
    const bulkStatusBtn = document.getElementById('lr-bulk-status-btn');
    if (bulkStatusBtn && typeof Craft !== 'undefined' && Craft.MenuBtn) {
        new Craft.MenuBtn(bulkStatusBtn);
    }

    // Initialize row action menu buttons
    document.querySelectorAll('.menubtn').forEach(btn => {
        if (typeof Craft !== 'undefined' && Craft.MenuBtn) {
            new Craft.MenuBtn(btn);
        }
    });

    // Bulk enable
    document.getElementById('lr-bulk-enable-action')?.addEventListener('click', function(e) {
        e.preventDefault();
        const ids = window.lrTableSelection.getSelectedIds();
        if (ids.length === 0) return;

        Craft.sendActionRequest('POST', 'search-manager/indices/bulk-enable', {
            data: { indexIds: ids }
        }).then(function(response) {
            if (response.data.success) {
                Craft.cp.displayNotice(Craft.t('search-manager', 'Enabled {count} indices', {count: response.data.count}));
                setTimeout(() => window.location.reload(), 1000);
            }
        }).catch(function(error) {
            Craft.cp.displayError(Craft.t('search-manager', 'Failed to enable indices'));
        });
    });

    // Bulk disable
    document.getElementById('lr-bulk-disable-action')?.addEventListener('click', function(e) {
        e.preventDefault();
        const ids = window.lrTableSelection.getSelectedIds();
        if (ids.length === 0) return;

        Craft.sendActionRequest('POST', 'search-manager/indices/bulk-disable', {
            data: { indexIds: ids }
        }).then(function(response) {
            if (response.data.success) {
                Craft.cp.displayNotice(Craft.t('search-manager', 'Disabled {count} indices', {count: response.data.count}));
                setTimeout(() => window.location.reload(), 1000);
            }
        }).catch(function(error) {
            Craft.cp.displayError(Craft.t('search-manager', 'Failed to disable indices'));
        });
    });

    // Bulk delete
    document.getElementById('lr-bulk-delete-btn')?.addEventListener('click', function() {
        const ids = window.lrTableSelection.getSelectedIds();
        if (ids.length === 0) return;

        if (!confirm(Craft.t('search-manager', 'Delete {count} index(es)? This cannot be undone.', {count: ids.length}))) return;

        Craft.sendActionRequest('POST', 'search-manager/indices/bulk-delete', {
            data: { indexIds: ids }
        }).then(function(response) {
            if (response.data.success) {
                Craft.cp.displayNotice(Craft.t('search-manager', 'Deleted {count} indices', {count: response.data.count}));
                setTimeout(() => window.location.reload(), 1000);
            }
        }).catch(function(error) {
            Craft.cp.displayError(Craft.t('search-manager', 'Failed to delete indices'));
        });
    });

    // Individual index action menu clicks
    document.querySelectorAll('.index-action').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();

            const action = this.dataset.action;
            const indexId = this.dataset.id;
            const indexName = this.dataset.name;

            if (action === 'rebuild') {
                if (confirm(Craft.t('search-manager', 'Rebuild index "{name}"? This will re-index all elements.', {name: indexName}))) {
                    submitIndexAction('search-manager/indices/rebuild', indexId);
                }
            } else if (action === 'clear') {
                if (confirm(Craft.t('search-manager', 'Clear all data from index "{name}"? This cannot be undone.', {name: indexName}))) {
                    submitIndexAction('search-manager/indices/clear', indexId);
                }
            } else if (action === 'clear-cache') {
                if (confirm(Craft.t('search-manager', 'Clear cached search results and autocomplete suggestions for "{name}"?', {name: indexName}))) {
                    submitIndexCacheAction('search-manager/indices/clear-cache', indexId, indexName);
                }
            } else if (action === 'delete') {
                if (confirm(Craft.t('search-manager', 'Delete index "{name}"? This will remove the index and all its data.', {name: indexName}))) {
                    submitIndexAction('search-manager/indices/delete', indexId);
                }
            } else if (action === 'sync-count') {
                syncCountFromBackend(indexId, indexName);
            }
        });
    });

    function submitIndexAction(action, indexId) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = Craft.getActionUrl(action);

        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = '{{ craft.app.config.general.csrfTokenName }}';
        csrfInput.value = '{{ craft.app.request.csrfToken }}';
        form.appendChild(csrfInput);

        const indexIdInput = document.createElement('input');
        indexIdInput.type = 'hidden';
        indexIdInput.name = 'indexId';
        indexIdInput.value = indexId;
        form.appendChild(indexIdInput);

        document.body.appendChild(form);
        form.submit();
    }

    function submitIndexCacheAction(action, indexId, indexName) {
        Craft.sendActionRequest('POST', action, {
            data: { indexId: indexId }
        }).then(function(response) {
            if (response.data.success) {
                Craft.cp.displayNotice(response.data.message || Craft.t('search-manager', 'Cache cleared for "{name}"', {name: indexName}));
            } else {
                Craft.cp.displayError(response.data.error || Craft.t('search-manager', 'Failed to clear cache'));
            }
        }).catch(function(error) {
            Craft.cp.displayError(Craft.t('search-manager', 'Failed to clear cache for "{name}"', {name: indexName}));
        });
    }

    function syncCountFromBackend(indexId, indexName) {
        Craft.sendActionRequest('POST', 'search-manager/indices/sync-count', {
            data: { indexId: indexId }
        }).then(function(response) {
            if (response.data.success) {
                Craft.cp.displayNotice(response.data.message || Craft.t('search-manager', 'Count synced for "{name}"', {name: indexName}));
                setTimeout(() => window.location.reload(), 1000);
            } else {
                Craft.cp.displayError(response.data.error || Craft.t('search-manager', 'Failed to sync count'));
            }
        }).catch(function(error) {
            Craft.cp.displayError(Craft.t('search-manager', 'Failed to sync count for "{name}"', {name: indexName}));
        });
    }

    // Update selected count
    document.addEventListener('lr:selectionChanged', function(e) {
        const countSpan = document.getElementById('lr-selected-count');
        if (countSpan) {
            countSpan.textContent = e.detail.count;
        }
    });

    // Highlight rows with handle collisions
    const collisionHandles = {{ collisionHandles is defined ? collisionHandles|json_encode|raw : '[]' }};
    if (collisionHandles.length > 0) {
        document.querySelectorAll('#lr-data-table tbody tr.lr-data-row').forEach(row => {
            const handleCell = row.querySelector('td[data-column="handle"] code');
            if (handleCell && collisionHandles.includes(handleCell.textContent.trim())) {
                row.style.backgroundColor = '#fef3c7';
            }
        });
    }
})();
</script>
{% endblock %}
