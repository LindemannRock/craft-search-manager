{% extends "_layouts/cp" %}
{% import "_includes/forms" as forms %}

{% set plugin = craft.app.plugins.getPlugin('search-manager') %}

{% set title = "Indices"|t('search-manager') %}
{% set fullPageForm = false %}
{% set selectedSubnavItem = 'indices' %}

{# Get query parameters #}
{% set search = craft.app.request.getParam('search', '') %}
{% set page = craft.app.request.getParam('page', 1)|number_format(0, '', '') %}
{% set limit = 50 %}
{% set offset = (page - 1) * limit %}

{# Filter indices based on search #}
{% set filteredIndices = indices %}
{% if search %}
	{% set filteredIndices = [] %}
	{% for index in indices %}
		{% if search|lower in index.name|lower or search|lower in index.handle|lower %}
			{% set filteredIndices = filteredIndices|merge([index]) %}
		{% endif %}
	{% endfor %}
{% endif %}

{# Pagination #}
{% set totalCount = filteredIndices|length %}
{% set totalPages = (totalCount / limit)|round(0, 'ceil') %}
{% set paginatedIndices = filteredIndices|slice(offset, limit) %}

{% set crumbs = [
    { label: 'Search Manager', url: url('search-manager') },
    { label: 'Indices'|t('search-manager'), url: url('search-manager/indices') }
] %}

{% block toolbar %}
	<div id="toolbar" class="flex" style="align-items: flex-end;">
		<div class="flex-grow">
			<form method="get" action="{{ url('search-manager/indices') }}">
				<div class="flex">
					<div class="search-container texticon flex-grow">
						<span class="texticon-icon search icon" aria-hidden="true"></span>
						<input type="text" class="clearable text fullwidth" name="search" value="{{ search }}" placeholder="{{ 'Search indices...'|t('search-manager') }}" autocomplete="off" dir="ltr" aria-label="Search" {% if search %} autofocus {% endif %}>
						<button type="button" class="clear-btn {{ search ? '' : 'hidden' }}" title="Clear search" role="button" aria-label="Clear search"></button>
					</div>
				</div>
			</form>
		</div>
		{% if currentUser.can('searchManager:createIndices') %}
			<a href="{{ url('search-manager/indices/create') }}" class="btn submit add icon" id="new-index-btn">
				<span class="label-full">{{ 'New Index'|t('search-manager') }}</span>
				<span class="label-short" style="display: none;">{{ 'New'|t('search-manager') }}</span>
			</a>
		{% endif %}
	</div>
{% endblock %}

{% css %}
@media (max-width: 768px) {
	#new-index-btn .label-full {
		display: none;
	}
	#new-index-btn .label-short {
		display: inline;
	}
	#new-index-btn:before {
		margin-inline-end: 0 !important;
	}
}
{% endcss %}

{% block content %}
	<style>
		.checkbox-cell {
			width: 40px !important;
			text-align: center;
		}
		/* Keep toolbar on one row even on smaller screens */
		#toolbar.flex {
			flex-wrap: nowrap;
			gap: 8px;
		}
		#toolbar .flex-grow {
			min-width: 0;
			flex-shrink: 1;
		}
	</style>

	<div id="elements" class="elements">
		<div class="tableview tablepane">
			<table class="data fullwidth">
				<thead>
					<tr>
						<th class="checkbox-cell selectallcontainer">
							<div class="checkbox" role="checkbox" tabindex="0" aria-checked="false" aria-label="Select all"></div>
						</th>
						<th scope="col">{{ "Name"|t('search-manager') }}</th>
						<th scope="col">{{ "Handle"|t('search-manager') }}</th>
						<th scope="col">{{ "Element Type"|t('search-manager') }}</th>
						<th scope="col">{{ "Backend"|t('search-manager') }}</th>
						<th scope="col">{{ "Craft"|t('search-manager') }}</th>
						<th scope="col">{{ "Indexed"|t('search-manager') }}</th>
						<th scope="col">{{ "Last Indexed"|t('search-manager') }}</th>
						<th scope="col">{{ "Config Source"|t('search-manager') }}</th>
						<th scope="col">{{ "Status"|t('search-manager') }}</th>
						<th class="thin" style="width: 60px;">{{ 'Actions'|t('search-manager') }}</th>
					</tr>
				</thead>
				<tbody>
					{% if paginatedIndices|length %}
						{% for index in paginatedIndices %}
							<tr data-id="{{ index.id }}" data-name="{{ index.name }}">
								<td class="checkbox-cell">
									<div class="checkbox" title="Select" tabindex="0" aria-checked="false" role="checkbox"></div>
								</td>
								<td>
									{% if index.canEdit() %}
										<a class="label-link" href="{{ url('search-manager/indices/edit/' ~ index.id) }}">
											<span>{{ index.name }}</span>
										</a>
									{% else %}
										{{ index.name }}
										<span class="info">{{ "(Config)"|t('search-manager') }}</span>
									{% endif %}
								</td>
								<td><code>{{ index.handle }}</code></td>
								<td>{{ index.elementType|split('\\')|last }}</td>
								<td><span class="status" style="background: #0ea5e9;"></span> {{ craft.searchManager.settings.searchBackend|title }}</td>
								{% set expected = index.expectedCount %}
								<td>{{ expected }}</td>
								<td>
									{% if index.documentCount == expected %}
										<span style="color: #059669;">{{ index.documentCount }}</span>
									{% elseif index.documentCount < expected %}
										<span style="color: #d97706;" title="{{ expected - index.documentCount }} missing">{{ index.documentCount }}</span>
									{% else %}
										<span style="color: #dc2626;" title="{{ index.documentCount - expected }} stale">{{ index.documentCount }}</span>
									{% endif %}
								</td>
								<td>
									{% if index.lastIndexed %}
										{{ index.lastIndexed|datetime('short') }}
									{% else %}
										<span class="light">{{ "Never"|t('search-manager') }}</span>
									{% endif %}
								</td>
								<td>
									{% if index.source == 'config' %}
										<span class="status blue"></span> {{ "Config"|t('search-manager') }}
									{% else %}
										<span class="status green"></span> {{ "Database"|t('search-manager') }}
									{% endif %}
								</td>
								<td>
									{% if index.enabled %}
										<span class="status green"></span>
									{% else %}
										<span class="status disabled"></span>
									{% endif %}
								</td>
								<td class="thin" style="text-align: right;">
									<button type="button" class="btn menubtn" data-icon="settings" title="{{ 'Actions'|t('search-manager') }}"></button>
									<div class="menu">
										<ul>
											{% if currentUser.can('searchManager:rebuildIndices') %}
												<li>
													<a class="index-action" data-action="rebuild" data-id="{{ index.id ?: index.handle }}" data-name="{{ index.name }}">
														{{ 'Rebuild Index'|t('search-manager') }}
													</a>
												</li>
											{% endif %}

											<li>
												<a class="index-action" data-action="clear" data-id="{{ index.id ?: index.handle }}" data-name="{{ index.name }}">
													{{ 'Clear Index Data'|t('search-manager') }}
												</a>
											</li>

											{% if index.canEdit() and currentUser.can('searchManager:deleteIndices') %}
												<li><hr class="padded"></li>
												<li>
													<a class="index-action error" data-action="delete" data-id="{{ index.id ?: index.handle }}" data-name="{{ index.name }}">
														{{ 'Delete Index'|t('search-manager') }}
													</a>
												</li>
											{% endif %}
										</ul>
									</div>
								</td>
							</tr>
						{% endfor %}
					{% else %}
						<tr>
							<td colspan="11" style="text-align: center; padding: 2em;">
								{{ 'No indices found.'|t('search-manager') }}
							</td>
						</tr>
					{% endif %}
				</tbody>
			</table>
		</div>
	</div>

	<div id="footer" class="flex flex-justify">
		<div class="light">
			<div class="flex pagination">
				<nav class="flex" aria-label="index pagination">
					<button type="button" class="page-link prev-page {{ page <= 1 ? 'disabled' : '' }}" {{ page <= 1 ? 'disabled' : '' }} title="Previous Page"></button>
					<button type="button" class="page-link next-page {{ page >= totalPages ? 'disabled' : '' }}" {{ page >= totalPages ? 'disabled' : '' }} title="Next Page"></button>
				</nav>
				<div class="page-info" style="margin: 0 12px; color: #596673;">
					{% set endRange = min(offset + limit, totalCount) %}
					{% if totalCount == 0 %}
						{{ 'no indices'|t('search-manager') }}
					{% else %}
						{{ offset + 1 }} â€“ {{ endRange }} of {{ totalCount }} {{ totalCount == 1 ? 'index' : 'indices' }}
					{% endif %}
				</div>
			</div>
		</div>
	</div>

	<script>
	// Initialize menu buttons
	document.querySelectorAll('.menubtn').forEach(btn => {
		if (typeof Craft !== 'undefined' && Craft.MenuBtn) {
			new Craft.MenuBtn(btn);
		} else if (typeof Garnish !== 'undefined' && Garnish.MenuBtn) {
			new Garnish.MenuBtn(btn);
		}
	});

	// Clear search
	const clearBtn = document.querySelector('.clear-btn');
	if (clearBtn) {
		clearBtn.addEventListener('click', function() {
			const searchInput = this.previousElementSibling.previousElementSibling;
			searchInput.value = '';
			searchInput.form.submit();
		});
	}

	// Search on Enter
	const searchInput = document.querySelector('input[name="search"]');
	if (searchInput) {
		searchInput.addEventListener('keyup', function(e) {
			if (e.key === 'Enter') {
				this.form.submit();
			}
		});
	}

	// Pagination
	document.querySelector('.prev-page:not(.disabled)')?.addEventListener('click', function() {
		window.location.href = '?search={{ search }}&page={{ page - 1 }}';
	});

	document.querySelector('.next-page:not(.disabled)')?.addEventListener('click', function() {
		window.location.href = '?search={{ search }}&page={{ page + 1 }}';
	});

	// Individual index action menu clicks
	document.querySelectorAll('.index-action').forEach(link => {
		link.addEventListener('click', function(e) {
			e.preventDefault();

			const action = this.dataset.action;
			const indexId = this.dataset.id;
			const indexName = this.dataset.name;

			if (action === 'rebuild') {
				if (confirm('Rebuild index "' + indexName + '"? This will re-index all elements.')) {
					submitIndexAction('search-manager/indices/rebuild', indexId);
				}
			} else if (action === 'clear') {
				if (confirm('Clear all data from index "' + indexName + '"? This cannot be undone.')) {
					submitIndexAction('search-manager/indices/clear', indexId);
				}
			} else if (action === 'delete') {
				if (confirm('Delete index "' + indexName + '"? This will remove the index and all its data.')) {
					submitIndexAction('search-manager/indices/delete', indexId);
				}
			}
		});
	});

	function submitIndexAction(action, indexId) {
		const form = document.createElement('form');
		form.method = 'POST';
		form.action = Craft.getActionUrl(action);

		const csrfInput = document.createElement('input');
		csrfInput.type = 'hidden';
		csrfInput.name = '{{ craft.app.config.general.csrfTokenName }}';
		csrfInput.value = '{{ craft.app.request.csrfToken }}';
		form.appendChild(csrfInput);

		const indexIdInput = document.createElement('input');
		indexIdInput.type = 'hidden';
		indexIdInput.name = 'indexId';
		indexIdInput.value = indexId;
		form.appendChild(indexIdInput);

		document.body.appendChild(form);
		form.submit();
	}
	</script>
{% endblock %}
