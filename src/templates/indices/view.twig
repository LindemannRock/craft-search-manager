{% extends "_layouts/cp" %}
{% import "_includes/forms" as forms %}

{% set title = index.name %}
{% set fullPageForm = false %}
{% set selectedSubnavItem = 'indices' %}

{% set canRebuild = currentUser.can('searchManager:rebuildIndices') %}
{% set canClear = currentUser.can('searchManager:clearIndices') %}
{% set canClearCache = currentUser.can('searchManager:clearCache') %}
{% set globalSettings = craft.searchManager.getSettings() %}

{% set crumbs = [
    { label: searchHelper.fullName, url: url('search-manager') },
    { label: 'Indices'|t('search-manager'), url: url('search-manager/indices') },
    { label: index.name }
] %}

{% block content %}
	<div class="pane">
		<h2>{{ 'Configuration'|t('search-manager') }}</h2>
		<p class="light">{{ 'This index is defined in your config file and cannot be edited here.'|t('search-manager') }}</p>
		<pre style="background: #f3f7fc; padding: 14px; border-radius: 4px; overflow-x: auto; font-size: 12px;"><code>{{ index.rawConfigDisplay }}</code></pre>
	</div>

	{% include 'lindemannrock-base/_components/plugin-credit' %}
{% endblock %}

{% block details %}
	{# Enabled toggle (disabled, showing current state) #}
	<div class="meta">
		{{ forms.lightswitchField({
			label: 'Enabled'|t('search-manager'),
			instructions: 'Set via config/search-manager.php. Edit the file to change.'|t('search-manager'),
			id: 'enabled',
			on: index.enabled,
			disabled: true
		}) }}

		{# Actions #}
		{% if canRebuild or canClear or (canClearCache and (globalSettings.enableCache or globalSettings.enableAutocompleteCache)) %}
			<div class="field">
				<div class="heading">
					<label>{{ 'Actions'|t('search-manager') }}</label>
				</div>
				<div class="input">
					<button type="button" class="btn menubtn" data-icon="settings" style="width: 100%;">{{ "Index Actions"|t('search-manager') }}</button>
					<div class="menu">
						<ul>
							{% if canRebuild %}
							<li>
								<a id="rebuild-btn" href="#">
									{{ "Rebuild Index"|t('search-manager') }}
								</a>
							</li>
							{% endif %}
							{% if canClear %}
							<li>
								<a id="clear-btn" href="#" class="error">
									{{ "Clear Index"|t('search-manager') }} ({{ index.documentCount|number_format }})
								</a>
							</li>
							{% endif %}
							{% if canClearCache and (globalSettings.enableCache or globalSettings.enableAutocompleteCache) %}
							<li><hr class="padded"></li>
							<li>
								<a id="clear-cache-btn" href="#">
									{{ "Clear Index Cache"|t('search-manager') }}
								</a>
							</li>
							{% endif %}
						</ul>
					</div>
				</div>
			</div>
		{% endif %}
	</div>

	{# Index Info #}
	<fieldset>
		<dl class="meta read-only">
			<div class="data">
				<dt class="heading">{{ 'Status'|t('search-manager') }}</dt>
				<dd class="value">
					<span class="status {{ index.enabled ? 'live' : 'disabled' }}"></span>
					<span>{{ index.enabled ? 'Enabled'|t('search-manager') : 'Disabled'|t('search-manager') }}</span>
				</dd>
			</div>
			<div class="data">
				<dt class="heading">{{ 'Handle'|t('search-manager') }}</dt>
				<dd class="value"><code>{{ index.handle }}</code></dd>
			</div>
			<div class="data">
				<dt class="heading">{{ 'Source'|t('search-manager') }}</dt>
				<dd class="value">{{ 'Config File'|t('search-manager') }}</dd>
			</div>
			<div class="data">
				<dt class="heading">{{ 'Element Type'|t('search-manager') }}</dt>
				<dd class="value">{{ index.elementType|split('\\')|last }}</dd>
			</div>
			{% set configuredBackend = index.configuredBackend %}
			<div class="data">
				<dt class="heading">{{ 'Backend'|t('search-manager') }}</dt>
				<dd class="value">
					{% if configuredBackend %}
						{% if configuredBackend.source == 'config' %}
							<a href="{{ url('search-manager/backends/view/' ~ configuredBackend.handle) }}">{{ configuredBackend.name }}</a>
						{% else %}
							<a href="{{ url('search-manager/backends/' ~ configuredBackend.id) }}">{{ configuredBackend.name }}</a>
						{% endif %}
					{% elseif index.effectiveBackendType %}
						<span>{{ index.effectiveBackendType|capitalize }}</span>
					{% else %}
						<span class="light">{{ 'Default'|t('search-manager') }}</span>
					{% endif %}
				</dd>
			</div>
			<div class="data">
				<dt class="heading">{{ 'Documents'|t('search-manager') }}</dt>
				<dd class="value">
					{% set expected = index.expectedCount %}
					{% if index.documentCount == expected %}
						<span style="color: #059669;">{{ index.documentCount }}</span> / {{ expected }}
					{% elseif index.documentCount < expected %}
						<span style="color: #d97706;">{{ index.documentCount }}</span> / {{ expected }}
					{% else %}
						<span style="color: #dc2626;">{{ index.documentCount }}</span> / {{ expected }}
					{% endif %}
				</dd>
			</div>
			<div class="data">
				<dt class="heading">{{ 'Last Indexed'|t('search-manager') }}</dt>
				<dd class="value">
					{% if index.lastIndexed %}
						{{ index.lastIndexed|datetime('short') }}
					{% else %}
						<span class="light">{{ 'Never'|t('search-manager') }}</span>
					{% endif %}
				</dd>
			</div>
		</dl>
	</fieldset>
{% endblock %}

{% js %}
// Initialize menu buttons
document.querySelectorAll('.menubtn').forEach(btn => {
	if (typeof Craft !== 'undefined' && Craft.MenuBtn) {
		new Craft.MenuBtn(btn);
	}
});

// Helper function for form submissions
function submitAction(action, indexId) {
	const form = document.createElement('form');
	form.method = 'POST';
	form.action = Craft.getActionUrl(action);

	const csrfInput = document.createElement('input');
	csrfInput.type = 'hidden';
	csrfInput.name = '{{ craft.app.config.general.csrfTokenName }}';
	csrfInput.value = '{{ craft.app.request.csrfToken }}';
	form.appendChild(csrfInput);

	const indexIdInput = document.createElement('input');
	indexIdInput.type = 'hidden';
	indexIdInput.name = 'indexId';
	indexIdInput.value = indexId;
	form.appendChild(indexIdInput);

	document.body.appendChild(form);
	form.submit();
}

// Rebuild button
{% if canRebuild %}
document.getElementById('rebuild-btn')?.addEventListener('click', function(e) {
	e.preventDefault();
	if (confirm('{{ "Rebuild index? This will re-index all elements."|t('search-manager')|e('js') }}')) {
		submitAction('search-manager/indices/rebuild', '{{ index.handle }}');
	}
});
{% endif %}

// Clear button
{% if canClear %}
document.getElementById('clear-btn')?.addEventListener('click', function(e) {
	e.preventDefault();
	if (confirm('{{ "Clear all data from this index? This cannot be undone."|t('search-manager')|e('js') }}')) {
		submitAction('search-manager/indices/clear', '{{ index.handle }}');
	}
});
{% endif %}

// Clear cache button
{% if canClearCache and (globalSettings.enableCache or globalSettings.enableAutocompleteCache) %}
document.getElementById('clear-cache-btn')?.addEventListener('click', function(e) {
	e.preventDefault();
	Craft.sendActionRequest('POST', 'search-manager/indices/clear-cache', {
		data: { indexId: '{{ index.handle }}' }
	}).then(function(response) {
		if (response.data.success) {
			Craft.cp.displayNotice(response.data.message || '{{ "Cache cleared"|t('search-manager') }}');
		} else {
			Craft.cp.displayError(response.data.error || '{{ "Failed to clear cache"|t('search-manager') }}');
		}
	}).catch(function(error) {
		Craft.cp.displayError('{{ "Failed to clear cache"|t('search-manager') }}');
	});
});
{% endif %}
{% endjs %}
