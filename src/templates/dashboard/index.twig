{% extends "_layouts/cp" %}
{% set title = searchHelper.fullName %}
{% set selectedSubnavItem = 'dashboard' %}

{% set crumbs = [
    { label: searchHelper.fullName, url: url('search-manager') },
] %}

{# Permission checks #}
{% set canViewIndices = currentUser.can('searchManager:viewIndices') %}
{% set canViewPromotions = currentUser.can('searchManager:viewPromotions') %}
{% set canViewQueryRules = currentUser.can('searchManager:viewQueryRules') %}
{% set canViewAnalytics = currentUser.can('searchManager:viewAnalytics') %}
{% set canCreateIndices = currentUser.can('searchManager:createIndices') %}
{% set canCreatePromotions = currentUser.can('searchManager:createPromotions') %}
{% set canCreateQueryRules = currentUser.can('searchManager:createQueryRules') %}
{% set canManageSettings = currentUser.can('searchManager:manageSettings') %}
{% set canViewWidgetConfigs = currentUser.can('searchManager:viewWidgetConfigs') %}

{% block actionButton %}
    {% set hasAnyQuickAction = canCreateIndices or canCreatePromotions or canCreateQueryRules or canViewWidgetConfigs or canManageSettings or (settings.enableAnalytics and canViewAnalytics) %}
    {% if hasAnyQuickAction %}
        <div class="btngroup">
            <button type="button" class="btn menubtn">{{ "Quick Actions"|t('search-manager') }}</button>
            <div class="menu">
                <ul>
                    {% if canCreateIndices %}
                        <li><a href="{{ url('search-manager/indices/create') }}">{{ "New Index"|t('search-manager') }}</a></li>
                    {% endif %}
                    {% if canCreatePromotions %}
                        <li><a href="{{ url('search-manager/promotions/create') }}">{{ "New Promotion"|t('search-manager') }}</a></li>
                    {% endif %}
                    {% if canCreateQueryRules %}
                        <li><a href="{{ url('search-manager/query-rules/create') }}">{{ "New Query Rule"|t('search-manager') }}</a></li>
                    {% endif %}
                    {% if settings.enableAnalytics and canViewAnalytics %}
                        <li><a href="{{ url('search-manager/analytics') }}">{{ "View Analytics"|t('search-manager') }}</a></li>
                    {% endif %}
                    {% if canViewWidgetConfigs %}
                        <li><a href="{{ url('search-manager/widgets') }}">{{ "Widgets"|t('search-manager') }}</a></li>
                    {% endif %}
                    {% if canManageSettings %}
                        <li><a href="{{ url('search-manager/settings') }}">{{ "Settings"|t('search-manager') }}</a></li>
                    {% endif %}
                </ul>
            </div>
        </div>
    {% endif %}
{% endblock %}

{% block content %}

{# Stats Overview Cards #}
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px;">
    {# Indices Card #}
    {% if canViewIndices %}
    <a href="{{ url('search-manager/indices') }}" class="pane" style="padding: 24px; margin-block: 0; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); text-decoration: none; display: block;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
            <div style="width: 12px; height: 12px; border-radius: 50%; background: #059669;"></div>
            <h4 style="margin: 0; color: #374151; font-size: 14px; font-weight: 600;">{{ "Search Indices"|t('search-manager') }}</h4>
        </div>
        <div style="display: flex; align-items: baseline; gap: 8px; margin-bottom: 8px;">
            <div style="font-size: 32px; font-weight: 700; color: #059669; line-height: 1;">{{ enabledIndices|number_format }}</div>
            {% if indices|length > enabledIndices %}
                <div style="font-size: 14px; color: #6b7280;">/ {{ indices|length|number_format }}</div>
            {% endif %}
        </div>
        <div style="font-size: 13px; color: #6b7280;">{{ totalDocuments|number_format }} {{ "documents indexed"|t('search-manager') }}</div>
    </a>
    {% endif %}

    {# Promotions Card #}
    {% if canViewPromotions %}
    <a href="{{ url('search-manager/promotions') }}" class="pane" style="padding: 24px; margin-block: 0; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); text-decoration: none; display: block;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
            <div style="width: 12px; height: 12px; border-radius: 50%; background: #f59e0b;"></div>
            <h4 style="margin: 0; color: #374151; font-size: 14px; font-weight: 600;">{{ "Promotions"|t('search-manager') }}</h4>
        </div>
        <div style="display: flex; align-items: baseline; gap: 8px; margin-bottom: 8px;">
            <div style="font-size: 32px; font-weight: 700; color: #f59e0b; line-height: 1;">{{ enabledPromotions|number_format }}</div>
            {% if promotionsCount > enabledPromotions %}
                <div style="font-size: 14px; color: #6b7280;">/ {{ promotionsCount|number_format }}</div>
            {% endif %}
        </div>
        <div style="font-size: 13px; color: #6b7280;">{{ "pinned results active"|t('search-manager') }}</div>
    </a>
    {% endif %}

    {# Query Rules Card #}
    {% if canViewQueryRules %}
    <a href="{{ url('search-manager/query-rules') }}" class="pane" style="padding: 24px; margin-block: 0; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); text-decoration: none; display: block;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
            <div style="width: 12px; height: 12px; border-radius: 50%; background: #8b5cf6;"></div>
            <h4 style="margin: 0; color: #374151; font-size: 14px; font-weight: 600;">{{ "Query Rules"|t('search-manager') }}</h4>
        </div>
        <div style="display: flex; align-items: baseline; gap: 8px; margin-bottom: 8px;">
            <div style="font-size: 32px; font-weight: 700; color: #8b5cf6; line-height: 1;">{{ enabledQueryRules|number_format }}</div>
            {% if queryRulesCount > enabledQueryRules %}
                <div style="font-size: 14px; color: #6b7280;">/ {{ queryRulesCount|number_format }}</div>
            {% endif %}
        </div>
        <div style="font-size: 13px; color: #6b7280;">{{ "synonyms, boosts, redirects"|t('search-manager') }}</div>
    </a>
    {% endif %}

    {# Searches Today Card (only if analytics enabled and user has permission) #}
    {% if settings.enableAnalytics and canViewAnalytics %}
    <a href="{{ url('search-manager/analytics') }}" class="pane" style="padding: 24px; margin-block: 0; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); text-decoration: none; display: block;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
            <div style="width: 12px; height: 12px; border-radius: 50%; background: #0ea5e9;"></div>
            <h4 style="margin: 0; color: #374151; font-size: 14px; font-weight: 600;">{{ "Searches Today"|t('search-manager') }}</h4>
        </div>
        <div style="display: flex; align-items: baseline; gap: 8px; margin-bottom: 8px;">
            <div style="font-size: 32px; font-weight: 700; color: #0ea5e9; line-height: 1;">{{ searchesToday|number_format }}</div>
            {% if searchesYesterday > 0 %}
                {% set change = ((searchesToday - searchesYesterday) / searchesYesterday * 100)|round %}
                <div style="font-size: 13px; padding: 2px 8px; border-radius: 12px; background: {{ change >= 0 ? '#dcfce7' : '#fee2e2' }}; color: {{ change >= 0 ? '#166534' : '#991b1b' }};">
                    {{ change >= 0 ? '+' : '' }}{{ change|number_format }}%
                </div>
            {% endif %}
        </div>
        <div style="font-size: 13px; color: #6b7280;">{{ searchesYesterday|number_format }} {{ "yesterday"|t('search-manager') }}</div>
    </a>
    {% endif %}
</div>

{# Two Column Layout for Lists #}
{% if settings.enableAnalytics and canViewAnalytics %}
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px; margin-bottom: 32px;">

    {# Top Searches (Last 7 Days) #}
    <div style="display: flex; flex-direction: column;">
        <h3 style="margin-bottom: 12px;">{{ "Top Searches"|t('search-manager') }} <span style="font-weight: normal;">({{ "Last 7 days"|t('search-manager') }})</span></h3>
        <div class="pane" style="margin-block: 0; flex: 1; display: flex; flex-direction: column;">
            {% if topSearches|length %}
                <table class="data fullwidth" style="margin: 0;">
                    <tbody>
                        {% for search in topSearches %}
                            <tr>
                                <td style="padding: {{ loop.first ? '0' : '12px' }} 0 12px 0; border-bottom: 1px solid #e5e7eb;">
                                    <code style="font-family: monospace; font-size: 13px;">{{ search.query }}</code>
                                </td>
                                <td style="text-align: right; padding: {{ loop.first ? '0' : '12px' }} 0 12px 0; border-bottom: 1px solid #e5e7eb; color: #6b7280; white-space: nowrap; font-size: 13px;">
                                    {{ search.count|number_format }} {{ search.count == 1 ? 'search' : 'searches' }}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div style="margin-top: auto; padding-top: 16px;">
                    <a href="{{ url('search-manager/analytics') }}" class="go">{{ "View all analytics"|t('search-manager') }}</a>
                </div>
            {% else %}
                <p class="light" style="margin: 0;">{{ "No searches recorded yet"|t('search-manager') }}</p>
            {% endif %}
        </div>
    </div>

    {# Recent Zero-Result Searches #}
    <div style="display: flex; flex-direction: column;">
        <h3 style="margin-bottom: 12px;">{{ "Content Gaps"|t('search-manager') }} <span style="font-weight: normal;">({{ "Zero results"|t('search-manager') }})</span></h3>
        <div class="pane" style="margin-block: 0; flex: 1; display: flex; flex-direction: column;">
            {% if recentZeroResults|length %}
                <table class="data fullwidth" style="margin: 0;">
                    <tbody>
                        {% for search in recentZeroResults %}
                            <tr>
                                <td style="padding: {{ loop.first ? '0' : '12px' }} 0 12px 0; border-bottom: 1px solid #e5e7eb;">
                                    <code style="font-family: monospace; font-size: 13px;">{{ search.query }}</code>
                                </td>
                                <td style="text-align: right; padding: {{ loop.first ? '0' : '12px' }} 0 12px 0; border-bottom: 1px solid #e5e7eb; color: #6b7280; white-space: nowrap; font-size: 13px;">
                                    {{ search.dateCreated|date('M j') }}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div style="margin-top: auto; padding-top: 16px;">
                    <a href="{{ url('search-manager/analytics') }}#content-gaps" class="go">{{ "View content gaps"|t('search-manager') }}</a>
                </div>
            {% else %}
                <p class="light" style="margin: 0;">{{ "No zero-result searches"|t('search-manager') }}</p>
            {% endif %}
        </div>
    </div>

</div>
{% endif %}

{% include 'lindemannrock-base/_components/plugin-credit' %}

{% endblock %}
