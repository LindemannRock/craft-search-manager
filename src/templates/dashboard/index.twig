{% extends "_layouts/cp" %}
{% set title = searchHelper.fullName %}
{% set selectedSubnavItem = 'dashboard' %}

{% set crumbs = [
    { label: searchHelper.fullName, url: url('search-manager') },
] %}

{% block content %}

<div class="readable" style="margin-bottom: 24px;">
    <p>{{ "Advanced multi-backend search management for Craft CMS"|t('search-manager') }}</p>
</div>

{# Stats Overview Cards #}
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px;">
    {# Indices Card #}
    <a href="{{ url('search-manager/indices') }}" class="pane" style="padding: 24px; margin-block: 0; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); text-decoration: none; display: block;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
            <div style="width: 12px; height: 12px; border-radius: 50%; background: #059669;"></div>
            <h4 style="margin: 0; color: #374151; font-size: 14px; font-weight: 600;">{{ "Search Indices"|t('search-manager') }}</h4>
        </div>
        <div style="display: flex; align-items: baseline; gap: 8px; margin-bottom: 8px;">
            <div style="font-size: 32px; font-weight: 700; color: #059669; line-height: 1;">{{ enabledIndices|number_format }}</div>
            {% if indices|length > enabledIndices %}
                <div style="font-size: 14px; color: #6b7280;">/ {{ indices|length|number_format }}</div>
            {% endif %}
        </div>
        <div style="font-size: 13px; color: #6b7280;">{{ totalDocuments|number_format }} {{ "documents indexed"|t('search-manager') }}</div>
    </a>

    {# Promotions Card #}
    <a href="{{ url('search-manager/promotions') }}" class="pane" style="padding: 24px; margin-block: 0; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); text-decoration: none; display: block;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
            <div style="width: 12px; height: 12px; border-radius: 50%; background: #f59e0b;"></div>
            <h4 style="margin: 0; color: #374151; font-size: 14px; font-weight: 600;">{{ "Promotions"|t('search-manager') }}</h4>
        </div>
        <div style="display: flex; align-items: baseline; gap: 8px; margin-bottom: 8px;">
            <div style="font-size: 32px; font-weight: 700; color: #f59e0b; line-height: 1;">{{ enabledPromotions|number_format }}</div>
            {% if promotionsCount > enabledPromotions %}
                <div style="font-size: 14px; color: #6b7280;">/ {{ promotionsCount|number_format }}</div>
            {% endif %}
        </div>
        <div style="font-size: 13px; color: #6b7280;">{{ "pinned results active"|t('search-manager') }}</div>
    </a>

    {# Query Rules Card #}
    <a href="{{ url('search-manager/query-rules') }}" class="pane" style="padding: 24px; margin-block: 0; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); text-decoration: none; display: block;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
            <div style="width: 12px; height: 12px; border-radius: 50%; background: #8b5cf6;"></div>
            <h4 style="margin: 0; color: #374151; font-size: 14px; font-weight: 600;">{{ "Query Rules"|t('search-manager') }}</h4>
        </div>
        <div style="display: flex; align-items: baseline; gap: 8px; margin-bottom: 8px;">
            <div style="font-size: 32px; font-weight: 700; color: #8b5cf6; line-height: 1;">{{ enabledQueryRules|number_format }}</div>
            {% if queryRulesCount > enabledQueryRules %}
                <div style="font-size: 14px; color: #6b7280;">/ {{ queryRulesCount|number_format }}</div>
            {% endif %}
        </div>
        <div style="font-size: 13px; color: #6b7280;">{{ "synonyms, boosts, redirects"|t('search-manager') }}</div>
    </a>

    {# Searches Today Card (only if analytics enabled) #}
    {% if settings.enableAnalytics %}
    <a href="{{ url('search-manager/analytics') }}" class="pane" style="padding: 24px; margin-block: 0; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); text-decoration: none; display: block;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
            <div style="width: 12px; height: 12px; border-radius: 50%; background: #0ea5e9;"></div>
            <h4 style="margin: 0; color: #374151; font-size: 14px; font-weight: 600;">{{ "Searches Today"|t('search-manager') }}</h4>
        </div>
        <div style="display: flex; align-items: baseline; gap: 8px; margin-bottom: 8px;">
            <div style="font-size: 32px; font-weight: 700; color: #0ea5e9; line-height: 1;">{{ searchesToday|number_format }}</div>
            {% if searchesYesterday > 0 %}
                {% set change = ((searchesToday - searchesYesterday) / searchesYesterday * 100)|round %}
                <div style="font-size: 13px; padding: 2px 8px; border-radius: 12px; background: {{ change >= 0 ? '#dcfce7' : '#fee2e2' }}; color: {{ change >= 0 ? '#166534' : '#991b1b' }};">
                    {{ change >= 0 ? '+' : '' }}{{ change|number_format }}%
                </div>
            {% endif %}
        </div>
        <div style="font-size: 13px; color: #6b7280;">{{ searchesYesterday|number_format }} {{ "yesterday"|t('search-manager') }}</div>
    </a>
    {% endif %}
</div>

{# Two Column Layout for Lists #}
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px; margin-bottom: 32px;">

    {# Top Searches (Last 7 Days) #}
    {% if settings.enableAnalytics %}
    <div class="pane" style="margin-block: 0;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h3 style="margin: 0;">{{ "Top Searches"|t('search-manager') }}</h3>
            <span style="font-size: 12px; color: #6b7280;">{{ "Last 7 days"|t('search-manager') }}</span>
        </div>

        {% if topSearches|length %}
            <table class="data fullwidth" style="margin: 0;">
                <tbody>
                    {% for search in topSearches %}
                        <tr>
                            <td style="padding: 12px 0; border-bottom: 1px solid #e5e7eb;">
                                <code style="font-family: monospace; font-size: 13px;">{{ search.query }}</code>
                            </td>
                            <td style="text-align: right; padding: 12px 0; border-bottom: 1px solid #e5e7eb; color: #6b7280; white-space: nowrap; font-size: 13px;">
                                {{ search.count|number_format }} {{ search.count == 1 ? 'search' : 'searches' }}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div style="margin-top: 16px;">
                <a href="{{ url('search-manager/analytics') }}" class="go">{{ "View all analytics"|t('search-manager') }}</a>
            </div>
        {% else %}
            <p class="light" style="margin: 0;">{{ "No searches recorded yet"|t('search-manager') }}</p>
        {% endif %}
    </div>
    {% endif %}

    {# Recent Zero-Result Searches #}
    {% if settings.enableAnalytics %}
    <div class="pane" style="margin-block: 0;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h3 style="margin: 0;">{{ "Content Gaps"|t('search-manager') }}</h3>
            <span style="font-size: 12px; color: #6b7280;">{{ "Zero results"|t('search-manager') }}</span>
        </div>

        {% if recentZeroResults|length %}
            <table class="data fullwidth" style="margin: 0;">
                <tbody>
                    {% for search in recentZeroResults %}
                        <tr>
                            <td style="padding: 12px 0; border-bottom: 1px solid #e5e7eb;">
                                <code style="font-family: monospace; font-size: 13px;">{{ search.query }}</code>
                            </td>
                            <td style="text-align: right; padding: 12px 0; border-bottom: 1px solid #e5e7eb; color: #6b7280; white-space: nowrap; font-size: 13px;">
                                {{ search.dateCreated|date('M j') }}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div style="margin-top: 16px;">
                <a href="{{ url('search-manager/analytics') }}#content-gaps" class="go">{{ "View content gaps"|t('search-manager') }}</a>
            </div>
        {% else %}
            <p class="light" style="margin: 0;">{{ "No zero-result searches"|t('search-manager') }}</p>
        {% endif %}
    </div>
    {% endif %}

</div>

{# Quick Actions #}
<div class="pane">
    <h2 style="margin-top: 0;">{{ "Quick Actions"|t('search-manager') }}</h2>

    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        {% if currentUser.can('searchManager:createIndices') %}
            <a href="{{ url('search-manager/indices/create') }}" class="btn submit">{{ "New Index"|t('search-manager') }}</a>
        {% endif %}
        {% if currentUser.can('searchManager:managePromotions') %}
            <a href="{{ url('search-manager/promotions/create') }}" class="btn">{{ "New Promotion"|t('search-manager') }}</a>
        {% endif %}
        {% if currentUser.can('searchManager:manageQueryRules') %}
            <a href="{{ url('search-manager/query-rules/create') }}" class="btn">{{ "New Query Rule"|t('search-manager') }}</a>
        {% endif %}
        <a href="{{ url('search-manager/settings') }}" class="btn">{{ "Settings"|t('search-manager') }}</a>
    </div>
</div>

{% include 'search-manager/_components/plugin-credit.twig' %}

{% endblock %}
