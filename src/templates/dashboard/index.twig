{% extends "_layouts/cp" %}
{% set title = searchHelper.fullName %}
{% set selectedSubnavItem = 'dashboard' %}

{% set crumbs = [
    { label: searchHelper.fullName, url: url('search-manager') },
] %}

{# Permission checks #}
{% set canViewIndices = currentUser.can('searchManager:viewIndices') %}
{% set canViewPromotions = currentUser.can('searchManager:viewPromotions') %}
{% set canViewQueryRules = currentUser.can('searchManager:viewQueryRules') %}
{% set canViewAnalytics = currentUser.can('searchManager:viewAnalytics') %}
{% set canCreateIndices = currentUser.can('searchManager:createIndices') %}
{% set canCreatePromotions = currentUser.can('searchManager:createPromotions') %}
{% set canCreateQueryRules = currentUser.can('searchManager:createQueryRules') %}
{% set canManageSettings = currentUser.can('searchManager:manageSettings') %}
{% set canViewWidgetConfigs = currentUser.can('searchManager:viewWidgetConfigs') %}

{% block actionButton %}
    {% set hasAnyQuickAction = canCreateIndices or canCreatePromotions or canCreateQueryRules or canViewWidgetConfigs or canManageSettings or (settings.enableAnalytics and canViewAnalytics) %}
    {% if hasAnyQuickAction %}
        <div class="btngroup">
            <button type="button" class="btn menubtn">{{ "Quick Actions"|t('search-manager') }}</button>
            <div class="menu">
                <ul>
                    {% if canCreateIndices %}
                        <li><a href="{{ url('search-manager/indices/create') }}">{{ "New Index"|t('search-manager') }}</a></li>
                    {% endif %}
                    {% if canCreatePromotions %}
                        <li><a href="{{ url('search-manager/promotions/create') }}">{{ "New Promotion"|t('search-manager') }}</a></li>
                    {% endif %}
                    {% if canCreateQueryRules %}
                        <li><a href="{{ url('search-manager/query-rules/create') }}">{{ "New Query Rule"|t('search-manager') }}</a></li>
                    {% endif %}
                    {% if settings.enableAnalytics and canViewAnalytics %}
                        <li><a href="{{ url('search-manager/analytics') }}">{{ "View Analytics"|t('search-manager') }}</a></li>
                    {% endif %}
                    {% if canViewWidgetConfigs %}
                        <li><a href="{{ url('search-manager/widgets') }}">{{ "Widgets"|t('search-manager') }}</a></li>
                    {% endif %}
                    {% if canManageSettings %}
                        <li><a href="{{ url('search-manager/settings') }}">{{ "Settings"|t('search-manager') }}</a></li>
                    {% endif %}
                </ul>
            </div>
        </div>
    {% endif %}
{% endblock %}

{% block content %}

{# Stats Overview Cards #}
<div class="lr-unified-cards" style="margin-bottom: 32px;">
    {# Indices Card #}
    {% if canViewIndices %}
        {% include 'lindemannrock-base/_components/cards/unified-card' with {
            title: 'Search Indices'|t('search-manager'),
            color: '#059669',
            value: enabledIndices,
            secondary: indices|length > enabledIndices ? indices|length : null,
            description: (totalDocuments|number_format) ~ ' ' ~ 'documents indexed'|t('search-manager'),
            url: url('search-manager/indices'),
        } only %}
    {% endif %}

    {# Promotions Card #}
    {% if canViewPromotions %}
        {% include 'lindemannrock-base/_components/cards/unified-card' with {
            title: 'Promotions'|t('search-manager'),
            color: '#f59e0b',
            value: enabledPromotions,
            secondary: promotionsCount > enabledPromotions ? promotionsCount : null,
            description: 'pinned results active'|t('search-manager'),
            url: url('search-manager/promotions'),
        } only %}
    {% endif %}

    {# Query Rules Card #}
    {% if canViewQueryRules %}
        {% include 'lindemannrock-base/_components/cards/unified-card' with {
            title: 'Query Rules'|t('search-manager'),
            color: '#8b5cf6',
            value: enabledQueryRules,
            secondary: queryRulesCount > enabledQueryRules ? queryRulesCount : null,
            description: 'synonyms, boosts, redirects'|t('search-manager'),
            url: url('search-manager/query-rules'),
        } only %}
    {% endif %}

    {# Searches Today Card #}
    {% if settings.enableAnalytics and canViewAnalytics %}
        {% include 'lindemannrock-base/_components/cards/unified-card' with {
            title: 'Searches Today'|t('search-manager'),
            color: '#0ea5e9',
            value: searchesToday,
            description: (searchesYesterday|number_format) ~ ' ' ~ 'yesterday'|t('search-manager'),
            url: url('search-manager/analytics'),
        } only %}
    {% endif %}
</div>

{# Two Column Layout for Lists #}
{% if settings.enableAnalytics and canViewAnalytics %}
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px; margin-bottom: 32px;">

    {# Top Searches (Last 7 Days) #}
    <div style="display: flex; flex-direction: column;">
        <h3 style="margin-bottom: 12px;">{{ "Top Searches"|t('search-manager') }} <span style="font-weight: normal;">({{ "Last 7 days"|t('search-manager') }})</span></h3>
        <div class="pane" style="margin-block: 0; flex: 1; display: flex; flex-direction: column;">
            {% if topSearches|length %}
                <table class="data fullwidth" style="margin: 0;">
                    <tbody>
                        {% for search in topSearches %}
                            <tr>
                                <td style="padding: {{ loop.first ? '0' : '12px' }} 0 12px 0; border-bottom: 1px solid #e5e7eb;">
                                    <code style="font-family: monospace; font-size: 13px;">{{ search.query }}</code>
                                </td>
                                <td style="text-align: right; padding: {{ loop.first ? '0' : '12px' }} 0 12px 0; border-bottom: 1px solid #e5e7eb; color: #6b7280; white-space: nowrap; font-size: 13px;">
                                    {{ search.count|number_format }} {{ search.count == 1 ? 'search' : 'searches' }}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div style="margin-top: auto; padding-top: 16px;">
                    <a href="{{ url('search-manager/analytics') }}" class="go">{{ "View all analytics"|t('search-manager') }}</a>
                </div>
            {% else %}
                <p class="light" style="margin: 0;">{{ "No searches recorded yet"|t('search-manager') }}</p>
            {% endif %}
        </div>
    </div>

    {# Recent Zero-Result Searches #}
    <div style="display: flex; flex-direction: column;">
        <h3 style="margin-bottom: 12px;">{{ "Content Gaps"|t('search-manager') }} <span style="font-weight: normal;">({{ "Zero results"|t('search-manager') }})</span></h3>
        <div class="pane" style="margin-block: 0; flex: 1; display: flex; flex-direction: column;">
            {% if recentZeroResults|length %}
                <table class="data fullwidth" style="margin: 0;">
                    <tbody>
                        {% for search in recentZeroResults %}
                            <tr>
                                <td style="padding: {{ loop.first ? '0' : '12px' }} 0 12px 0; border-bottom: 1px solid #e5e7eb;">
                                    <code style="font-family: monospace; font-size: 13px;">{{ search.query }}</code>
                                </td>
                                <td style="text-align: right; padding: {{ loop.first ? '0' : '12px' }} 0 12px 0; border-bottom: 1px solid #e5e7eb; color: #6b7280; white-space: nowrap; font-size: 13px;">
                                    {{ search.dateCreated|lrShortDate }}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div style="margin-top: auto; padding-top: 16px;">
                    <a href="{{ url('search-manager/analytics') }}#content-gaps" class="go">{{ "View content gaps"|t('search-manager') }}</a>
                </div>
            {% else %}
                <p class="light" style="margin: 0;">{{ "No zero-result searches"|t('search-manager') }}</p>
            {% endif %}
        </div>
    </div>

</div>
{% endif %}

{% include 'lindemannrock-base/_components/plugin-credit' %}

{% endblock %}
