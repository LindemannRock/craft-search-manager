{% extends "search-manager/_layouts/settings" %}
{% import "_includes/forms" as forms %}

{% set title = "Backend Settings"|t('search-manager') %}
{% set fullPageForm = true %}
{% set selectedSettingsItem = 'backend' %}

{% set crumbs = [
    {
        label: searchHelper.fullName|t('search-manager'),
        url: url('search-manager'),
    },
    {
        label: 'Settings'|t('search-manager'),
        url: url('search-manager/settings'),
    },
    {
        label: 'Backend'|t('search-manager'),
        url: url('search-manager/settings/backend'),
    },
] %}

{% block actionButton %}
    {% if enabledBackends|length > 0 %}
        <div class="btngroup">
            <input type="submit" class="btn submit" value="{{ 'Save'|t('app') }}">
        </div>
    {% endif %}
{% endblock %}

{% block content %}

    {% include 'lindemannrock-base/_components/ip-salt-error' with {
        pluginHandle: 'search-manager',
        envVarName: 'SEARCH_MANAGER_IP_SALT'
    } %}

    <form method="post" accept-charset="UTF-8">
        <input type="hidden" name="action" value="search-manager/settings/save-backend">
        {{ csrfInput() }}
        {{ redirectInput('search-manager/settings/backend') }}

        <h2 style="margin-top: 0px;">{{ "Default Search Backend"|t('search-manager') }}</h2>
        <p class="light">{{ "Select which configured backend to use as the system default. Indices can override this setting individually."|t('search-manager') }}</p>

        {% if backends|length == 0 %}
            {# No backends configured at all #}
            {% include 'lindemannrock-base/_components/info-box' with {
                type: 'warning',
                message: '<strong>No Backends Configured</strong><br>You need to create at least one backend before you can select a default.<br><br><a href="' ~ url('search-manager/backends/new') ~ '" class="btn">Create Your First Backend</a>'
            } %}

        {% elseif enabledBackends|length == 0 %}
            {# Backends exist but none are enabled #}
            {% include 'lindemannrock-base/_components/info-box' with {
                type: 'warning',
                message: '<strong>No Enabled Backends</strong><br>You have ' ~ backends|length ~ ' backend(s) configured, but none are enabled. Enable at least one backend to use it as the default.<br><br><a href="' ~ url('search-manager/backends') ~ '" class="btn">Manage Backends</a>'
            } %}

        {% else %}
            {# Build options from enabled backends #}
            {% set backendOptions = [{ label: 'Select a default backend...', value: '' }] %}
            {% for backend in enabledBackends %}
                {% set backendOptions = backendOptions|merge([{
                    label: backend.name ~ ' (' ~ backend.getTypeLabel() ~ ')',
                    value: backend.handle
                }]) %}
            {% endfor %}

            {{ forms.selectField({
                label: 'Default Backend'|t('search-manager'),
                instructions: 'The backend that will be used for new indices and as the fallback when no specific backend is assigned.'|t('search-manager'),
                id: 'defaultBackendHandle',
                name: 'settings[defaultBackendHandle]',
                value: settings.defaultBackendHandle,
                options: backendOptions,
                disabled: settings.isOverriddenByConfig('defaultBackendHandle'),
                warning: settings.isOverriddenByConfig('defaultBackendHandle') ?
                    "This is being overridden by the <code>defaultBackendHandle</code> setting in <code>config/search-manager.php</code>."|t('search-manager')|raw : null,
            }) }}

            {% include 'lindemannrock-base/_components/info-box' with {
                type: 'tip',
                message: '<strong>Manage Backends:</strong> <a href="' ~ url('search-manager/backends') ~ '">Configure backend connections</a> in the Backends section. You can create multiple backends (e.g., "Production Algolia", "Development MySQL") and assign them to different indices.'
            } %}
        {% endif %}

        <hr>

        <h2>{{ "Search & Ranking Settings"|t('search-manager') }}</h2>
        <div class="field">
            <p class="light">
                {{ "Configure search behavior and ranking algorithms:"|t('search-manager') }}<br><br>
                → <a href="{{ url('search-manager/settings/search') }}"><strong>{{ "Search Settings"|t('search-manager') }}</strong></a> - {{ "BM25 parameters, boost factors, fuzzy matching"|t('search-manager') }}<br>
                → <a href="{{ url('search-manager/settings/language') }}"><strong>{{ "Language Settings"|t('search-manager') }}</strong></a> - {{ "Stop words and multi-language support"|t('search-manager') }}<br>
                → <a href="{{ url('search-manager/settings/highlighting') }}"><strong>{{ "Highlighting Settings"|t('search-manager') }}</strong></a> - {{ "Result highlighting, snippets, autocomplete"|t('search-manager') }}
            </p>
        </div>

        {% if enabledBackends|length > 0 %}
            <div class="buttons">
                <button type="submit" class="btn submit">{{ "Save Settings"|t('search-manager') }}</button>
            </div>
        {% endif %}
    </form>

    {% include 'lindemannrock-base/_components/plugin-credit' %}
{% endblock %}
