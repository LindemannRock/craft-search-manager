{% extends "search-manager/_layouts/settings" %}
{% import "_includes/forms" as forms %}

{% set title = "General Settings"|t('search-manager') %}
{% set fullPageForm = true %}
{% set selectedSettingsItem = 'general' %}


{% set crumbs = [
    {
        label: searchHelper.fullName|t('search-manager'),
        url: url('search-manager'),
    },
    {
        label: 'Settings'|t('search-manager'),
        url: url('search-manager/settings'),
    },
] %}

{% block actionButton %}
	<div class="btngroup">
		<input type="submit" class="btn submit" value="{{ 'Save'|t('app') }}">
	</div>
{% endblock %}

{% block content %}

    {% include 'lindemannrock-base/_components/ip-salt-error' with {
		pluginHandle: 'search-manager',
		envVarName: 'SEARCH_MANAGER_IP_SALT'
	} %}

	<form method="post" accept-charset="UTF-8">
		<input type="hidden" name="action" value="search-manager/settings/save">
		{{ csrfInput() }}
		{{ redirectInput('search-manager/settings/general') }}
		{{ hiddenInput('section', 'general') }}

		<h2 style="margin-top: 0px;">{{ "General Settings"|t('search-manager') }}</h2>

		{{ forms.textField({
            label: "Plugin Name"|t('search-manager'),
            instructions: "The name of the plugin as it appears in the Control Panel menu"|t('search-manager'),
            id: 'pluginName',
            name: 'settings[pluginName]',
            value: settings.pluginName,
            required: true,
            disabled: settings.isOverriddenByConfig('pluginName'),
            warning: settings.isOverriddenByConfig('pluginName') ?
                "This is being overridden by the <code>pluginName</code> setting in <code>config/search-manager.php</code>."|t('search-manager')|raw : null,
        }) }}

		{% if enabledBackends|length == 0 %}
			{% include 'lindemannrock-base/_components/info-box' with {
				type: 'notice',
				message: 'No enabled backends. <a href="' ~ url('search-manager/backends/new') ~ '">Create a backend</a> to use as the default.'
			} %}
		{% else %}
			{% set backendOptions = [{ label: 'Select a default backend...', value: '' }] %}
			{% for backend in enabledBackends %}
				{% set backendOptions = backendOptions|merge([{
					label: backend.name ~ ' (' ~ backend.getTypeLabel() ~ ')',
					value: backend.handle
				}]) %}
			{% endfor %}

			{{ forms.selectField({
				label: 'Default Backend'|t('search-manager'),
				instructions: 'The backend that will be used for new indices and as the fallback when no specific backend is assigned.'|t('search-manager'),
				id: 'defaultBackendHandle',
				name: 'settings[defaultBackendHandle]',
				value: settings.defaultBackendHandle,
				options: backendOptions,
				disabled: settings.isOverriddenByConfig('defaultBackendHandle'),
				warning: settings.isOverriddenByConfig('defaultBackendHandle') ?
					"This is being overridden by the <code>defaultBackendHandle</code> setting in <code>config/search-manager.php</code>."|t('search-manager')|raw : null,
			}) }}
		{% endif %}

		{% if enabledWidgets|length == 0 %}
			{% include 'lindemannrock-base/_components/info-box' with {
				type: 'notice',
				message: 'No enabled widgets. <a href="' ~ url('search-manager/widgets/new') ~ '">Create a widget</a> to use as the default.'
			} %}
		{% else %}
			{% set widgetOptions = [{ label: 'Select a default widget...', value: '' }] %}
			{% for widget in enabledWidgets %}
				{% set widgetOptions = widgetOptions|merge([{
					label: widget.name,
					value: widget.handle
				}]) %}
			{% endfor %}

			{{ forms.selectField({
				label: 'Default Widget'|t('search-manager'),
				instructions: 'The widget configuration that will be used when rendering the search widget without specifying a handle.'|t('search-manager'),
				id: 'defaultWidgetHandle',
				name: 'settings[defaultWidgetHandle]',
				value: settings.defaultWidgetHandle,
				options: widgetOptions,
				disabled: settings.isOverriddenByConfig('defaultWidgetHandle'),
				warning: settings.isOverriddenByConfig('defaultWidgetHandle') ?
					"This is being overridden by the <code>defaultWidgetHandle</code> setting in <code>config/search-manager.php</code>."|t('search-manager')|raw : null,
			}) }}
		{% endif %}

		<hr>

		<h2>{{ "Logging Settings"|t('search-manager') }}</h2>

		{% set logOptions = [
            {value: 'error', label: 'Error (Critical errors only)'|t('search-manager')},
            {value: 'warning', label: 'Warning (Errors and warnings)'|t('search-manager')},
            {value: 'info', label: 'Info (General information)'|t('search-manager')},
        ] %}

		{% if craft.app.config.general.devMode %}
			{% set logOptions = logOptions|merge([
                {value: 'debug', label: 'Debug (Detailed debugging)'|t('search-manager')}
            ]) %}
		{% endif %}

		{{ forms.selectField({
            label: 'Log Level'|t('search-manager'),
            instructions: 'Choose what types of messages to log. Debug level requires devMode to be enabled.'|t('search-manager'),
            id: 'logLevel',
            name: 'settings[logLevel]',
            value: settings.logLevel,
            options: logOptions,
            disabled: settings.isOverriddenByConfig('logLevel'),
            warning: settings.isOverriddenByConfig('logLevel') ?
                "This is being overridden by the <code>logLevel</code> setting in <code>config/search-manager.php</code>."|t('search-manager')|raw : null,
        }) }}

		<div class="buttons">
			<button type="submit" class="btn submit">{{ "Save Settings"|t('search-manager') }}</button>
		</div>
	</form>

	{% include 'lindemannrock-base/_components/plugin-credit' %}
{% endblock %}
