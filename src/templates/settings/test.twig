{% extends "search-manager/_layouts/settings" %}
{% import "_includes/forms" as forms %}

{% set title = "Test Search"|t('search-manager') %}
{% set selectedSettingsItem = 'test' %}

{% set plugin = craft.app.plugins.getPlugin('search-manager') %}
{% set crumbs = [
    {
        label: searchHelper.fullName|t('search-manager'),
        url: url('search-manager'),
    },
    {
        label: 'Settings'|t('search-manager'),
        url: url('search-manager/settings'),
    },
    {
        label: 'Test'|t('search-manager'),
        url: url('search-manager/settings/test'),
    },
] %}

{% block content %}

    {% include 'search-manager/_components/ip-salt-error' %}

    <h2 style="margin-top: 0px;">{{ "Test Search Engine"|t('search-manager') }}</h2>

    <p>{{ "Test your search configuration with real queries. Supports all advanced operators (phrase search, NOT, field-specific, wildcards, boosting)."|t('search-manager') }}</p>

    {# Get available indices #}
    {% set allIndices = craft.searchManager.getIndices() %}
    {% set enabledIndices = [] %}
    {% for index in allIndices %}
        {% if index.enabled %}
            {% set enabledIndices = enabledIndices|merge([{value: index.handle, label: index.name ~ ' (' ~ index.handle ~ ')'}]) %}
        {% endif %}
    {% endfor %}

    {{ forms.selectField({
        label: 'Search Index'|t('search-manager'),
        instructions: 'Select which index to search'|t('search-manager'),
        id: 'testIndex',
        name: 'testIndex',
        options: enabledIndices,
        value: enabledIndices[0].value ?? '',
    }) }}

    {{ forms.textField({
        label: 'Search Query'|t('search-manager'),
        instructions: 'Enter a search query to test. Supports all operators: <code>"exact phrase"</code>, <code>test NOT spam</code>, <code>title:blog</code>, <code>test*</code>, <code>craft^2 cms</code>'|t('search-manager'),
        id: 'testQuery',
        name: 'testQuery',
        value: 'test',
        placeholder: 'Try: "craft cms", test NOT spam, title:blog, test*',
    }) }}

    {# Search options #}
    <div class="field">
        <div class="heading">
            <label>{{ "Search Options"|t('search-manager') }}</label>
        </div>
        <div style="margin-top: 5px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-bottom: 10px;">
                <input type="checkbox" id="enableWildcard" name="enableWildcard">
                <span style="font-weight: 500;">{{ "Auto-add Wildcards (Prefix Matching)"|t('search-manager') }}</span>
            </label>
            <div style="padding-left: 28px; font-size: 0.85em; color: #666; line-height: 1.5; margin-top: -8px;">
                Automatically adds <code>*</code> to search terms for prefix matching.<br>
                Example: "freez" becomes "freez*" and matches "freeze", "freezable", "freezing"<br>
                <span style="color: #f59e0b;">⚠️ Manual wildcards in query (like "test*") always work regardless of this setting</span>
            </div>
            <div style="padding: 10px; background: #f3f7fc; border-left: 3px solid #0d78f2; margin-top: 10px; font-size: 0.85em;">
                <strong>Note:</strong> Fuzzy matching is always enabled automatically as a fallback when exact matches fail.
            </div>
        </div>
    </div>

    <div style="display: flex; gap: 10px; align-items: center;">
        <button type="button" id="testButton" class="btn submit">{{ "Run Search Test"|t('search-manager') }}</button>
        {% if cacheEnabled %}
            <button type="button" id="clearCacheButton" class="btn">{{ "Clear Search Cache"|t('search-manager') }}</button>
            <span id="cacheStatus" style="font-size: 0.9em; color: #666;"></span>
        {% else %}
            <button type="button" class="btn" disabled title="Search cache is disabled in settings">{{ "Search Cache Disabled"|t('search-manager') }}</button>
        {% endif %}
    </div>

    <div id="suggestions" style="display: none; margin-top: 15px;">
        <h4>{{ "Autocomplete Suggestions"|t('search-manager') }}</h4>
        <div id="suggestionsContent" style="display: flex; gap: 8px; flex-wrap: wrap;"></div>
    </div>

    <div id="testResults" style="display: none; margin-top: 30px;">
        <hr>
        <h3 id="resultsTitle"></h3>
        <div id="resultsContent"></div>
    </div>

    {% include 'search-manager/_components/plugin-credit.twig' %}
{% endblock %}

{% js %}
const testButton = document.getElementById('testButton');
const clearCacheButton = document.getElementById('clearCacheButton');
const cacheStatus = document.getElementById('cacheStatus');
const testQueryInput = document.getElementById('testQuery');
const testIndexSelect = document.getElementById('testIndex');
const testResults = document.getElementById('testResults');
const resultsTitle = document.getElementById('resultsTitle');
const resultsContent = document.getElementById('resultsContent');
const suggestionsDiv = document.getElementById('suggestions');
const suggestionsContent = document.getElementById('suggestionsContent');

// Autocomplete settings
const autocompleteEnabled = {{ settings.enableAutocomplete ? 'true' : 'false' }};
const autocompleteMinLength = {{ settings.autocompleteMinLength ?? 2 }};
let autocompleteTimer;

// Clear cache button handler (only if cache is enabled)
if (clearCacheButton) {
    clearCacheButton.addEventListener('click', function() {
    const indexHandle = testIndexSelect.value;

    clearCacheButton.disabled = true;
    clearCacheButton.textContent = 'Clearing...';

    fetch('{{ actionUrl('search-manager/settings/clear-test-cache') }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'X-CSRF-Token': '{{ craft.app.request.csrfToken }}',
        },
        body: JSON.stringify({
            indexHandle: indexHandle
        })
    })
    .then(response => response.json())
    .then(data => {
        clearCacheButton.disabled = false;
        clearCacheButton.textContent = 'Clear Search Cache';

        if (data.success) {
            cacheStatus.textContent = '✅ ' + data.message;
            cacheStatus.style.color = '#28a745';

            // Clear status after 3 seconds
            setTimeout(() => {
                cacheStatus.textContent = '';
            }, 3000);
        } else {
            cacheStatus.textContent = '❌ ' + (data.error || 'Failed to clear cache');
            cacheStatus.style.color = '#dc3545';
        }
    })
    .catch(error => {
        clearCacheButton.disabled = false;
        clearCacheButton.textContent = 'Clear Search Cache';
        cacheStatus.textContent = '❌ ' + error.message;
        cacheStatus.style.color = '#dc3545';
    });
    });
}

// Autocomplete as user types (if enabled)
if (autocompleteEnabled) {
    testQueryInput.addEventListener('input', function() {
        const query = this.value.trim();

        if (query.length < autocompleteMinLength) {
            suggestionsDiv.style.display = 'none';
            return;
        }

        clearTimeout(autocompleteTimer);
        autocompleteTimer = setTimeout(() => {
            fetch('{{ actionUrl('search-manager/api/suggest') }}?q=' + encodeURIComponent(query) + '&index=' + testIndexSelect.value + '&limit=10')
                .then(response => response.json())
                .then(suggestions => {
                    if (suggestions.length > 0) {
                        suggestionsContent.innerHTML = suggestions.map(term =>
                            `<span style="background: #f3f4f6; padding: 6px 12px; border-radius: 16px; font-size: 13px; cursor: pointer; border: 1px solid #e3e5e8;" onclick="testQueryInput.value='${term}'; suggestionsDiv.style.display='none';">${term}</span>`
                        ).join('');
                        suggestionsDiv.style.display = 'block';
                    } else {
                        suggestionsDiv.style.display = 'none';
                    }
                })
                .catch(() => {
                    suggestionsDiv.style.display = 'none';
                });
        }, 300); // Debounce 300ms
    });
}

testButton.addEventListener('click', function() {
    const query = testQueryInput.value.trim();
    const indexHandle = testIndexSelect.value;
    const enableWildcard = document.getElementById('enableWildcard').checked;

    if (!query) {
        testResults.style.display = 'block';
        resultsTitle.innerHTML = '⚠️ Validation Error';
        resultsTitle.style.color = '#dc3545';
        resultsContent.innerHTML = '<p style="color: #dc3545;">Please enter a search query</p>';
        return;
    }

    testButton.disabled = true;
    testButton.textContent = 'Searching...';

    fetch('{{ actionUrl('search-manager/settings/test-search') }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'X-CSRF-Token': '{{ craft.app.request.csrfToken }}',
        },
        body: JSON.stringify({
            query: query,
            indexHandle: indexHandle,
            wildcard: enableWildcard
        })
    })
    .then(response => response.json())
    .then(data => {
        testButton.disabled = false;
        testButton.textContent = 'Run Search Test';

        testResults.style.display = 'block';

        if (data.success) {
            // Show results
            resultsTitle.innerHTML = `✅ Found ${data.total} result${data.total !== 1 ? 's' : ''}`;
            resultsTitle.style.color = '#28a745';

            let html = `
<div style="padding: 15px; background: #e8f5e9; border-left: 4px solid #28a745; margin: 15px 0;">
    <strong>Search Metrics:</strong><br>
    <strong>Backend:</strong> ${Craft.escapeHtml(data.backend)}<br>
    <strong>Execution Time:</strong> ${data.executionTime}ms<br>
    <strong>Search Cache:</strong> ${data.cacheEnabled ? '✅ Enabled' : '❌ Disabled'}<br>
    <strong>Query Parsed As:</strong> <code>${Craft.escapeHtml(data.queryUsed || query)}</code><br>
    <strong>Options:</strong> ✅ Fuzzy (always on) ${data.wildcard ? '| ✅ Wildcard (auto-added)' : '| ❌ Wildcard'}<br>
    ${data.indexSiteId ? `<strong>Site ID:</strong> ${data.indexSiteId}<br>` : ''}
    ${data.highlightingEnabled ? `<strong>Highlighting:</strong> ✅ Enabled<br>` : ''}
</div>

<h4 style="margin-top: 20px;">Results (Top ${Math.min(data.total, data.hits.length)}):</h4>
`;

            if (data.total > 0) {
                html += '<div style="display: grid; gap: 16px;">';
                data.hits.forEach((hit, index) => {
                    const title = hit.titleHighlighted || hit.title || 'Untitled';
                    const excerpt = hit.excerptHighlighted || hit.excerpt || hit.content || '';
                    const language = hit.language || hit._language || 'unknown';
                    const url = hit.url || '';

                    html += `
<div style="padding: 16px; border: 1px solid #e3e5e8; border-radius: 4px; background: #fff;">
    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
        <div style="flex: 1;">
            <strong style="color: #0d78f2; font-size: 15px;">${title}</strong>
            ${url ? `<div style="font-size: 12px; color: #6b7280; margin-top: 4px;"><a href="${url}" target="_blank" style="color: #0d78f2;">${url}</a></div>` : ''}
        </div>
        <div style="display: flex; gap: 8px; margin-left: 12px;">
            <span style="background: #f3f4f6; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; white-space: nowrap;">
                Score: ${hit.score ? hit.score.toFixed(2) : 'N/A'}
            </span>
            ${language !== 'unknown' ? `<span style="background: #e0e7ff; color: #3730a3; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; text-transform: uppercase;">${language}</span>` : ''}
        </div>
    </div>
    <div style="font-size: 12px; color: #9ca3af; margin-bottom: 8px; display: flex; gap: 12px;">
        <span>ID: #${hit.objectID}</span>
        <span>•</span>
        <span>Type: ${hit.type || 'Entry'}</span>
        ${hit.section ? `<span>•</span><span>Section: ${hit.section}</span>` : ''}
    </div>
    ${excerpt ? `<div style="color: #4b5563; line-height: 1.6; font-size: 14px; margin-top: 8px;">${excerpt.substring(0, 300)}${excerpt.length > 300 ? '...' : ''}</div>` : ''}
</div>
`;
                });
                html += '</div>';
            } else {
                html += `
<div style="text-align: center; padding: 40px; color: #9ca3af;">
    <p style="font-size: 18px; margin: 0;">No results found for "${Craft.escapeHtml(query)}"</p>
    <p style="font-size: 14px; margin: 8px 0 0;">Try different keywords or operators</p>
</div>
`;
            }

            resultsContent.innerHTML = html;
        } else {
            // Error
            resultsTitle.innerHTML = '❌ Search Failed';
            resultsTitle.style.color = '#dc3545';
            resultsContent.innerHTML = `<p style="color: #dc3545;">${Craft.escapeHtml(data.error || 'Unknown error')}</p>`;
        }
    })
    .catch(error => {
        testButton.disabled = false;
        testButton.textContent = 'Run Search Test';

        testResults.style.display = 'block';
        resultsTitle.innerHTML = '⚠️ Error';
        resultsTitle.style.color = '#dc3545';
        resultsContent.innerHTML = `<p style="color: #dc3545;">${error.message}</p>`;
    });
});

// Allow Enter key to trigger test
testQueryInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        testButton.click();
    }
});
{% endjs %}
