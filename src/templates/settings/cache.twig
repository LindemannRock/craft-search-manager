{% extends "search-manager/_layouts/settings" %}
{% import "_includes/forms" as forms %}

{% set title = "Cache Settings"|t('search-manager') %}
{% set fullPageForm = true %}
{% set selectedSettingsItem = 'cache' %}


{% set crumbs = [
    {
        label: searchHelper.fullName|t('search-manager'),
        url: url('search-manager'),
    },
    {
        label: 'Settings'|t('search-manager'),
        url: url('search-manager/settings'),
    },
    {
        label: 'Cache'|t('search-manager'),
        url: url('search-manager/settings/cache'),
    },
] %}

{% block actionButton %}
	<div class="btngroup">
		<input type="submit" class="btn submit" value="{{ 'Save'|t('app') }}">
	</div>
{% endblock %}

{% block content %}

    {% include 'lindemannrock-base/_components/ip-salt-error' with {
		pluginHandle: 'search-manager',
		envVarName: 'SEARCH_MANAGER_IP_SALT'
	} %}

	<form method="post" accept-charset="UTF-8">
		<input type="hidden" name="action" value="search-manager/settings/save">
		{{ csrfInput() }}
		{{ redirectInput('search-manager/settings/cache') }}
		{{ hiddenInput('section', 'cache') }}

		<h2 style="margin-top: 0px;">{{ "Cache Storage Settings"|t('search-manager') }}</h2>

		{{ forms.selectField({
			label: 'Cache Storage Method'|t('search-manager'),
			instructions: 'How to store cache data. Use Redis/Database for load-balanced or multi-server environments.'|t('search-manager'),
			id: 'cacheStorageMethod',
			name: 'settings[cacheStorageMethod]',
			value: settings.cacheStorageMethod ?? 'file',
			options: [
				{ value: 'file', label: 'File System (default, single server)'|t('search-manager') },
				{ value: 'redis', label: 'Redis/Database (load-balanced, multi-server, cloud hosting)'|t('search-manager') },
			],
			disabled: settings.isOverriddenByConfig('cacheStorageMethod'),
			warning: settings.isOverriddenByConfig('cacheStorageMethod') ?
				"This is being overridden by the <code>cacheStorageMethod</code> setting in <code>config/search-manager.php</code>."|t('search-manager')|raw : null,
		}) }}

		{% set craftUsesRedis = craft.app.cache is defined and craft.app.cache.className is defined and craft.app.cache.className == 'yii\\redis\\Cache' %}

		<div id="cache-location-file" class="{{ (settings.cacheStorageMethod ?? 'file') == 'redis' ? 'hidden' }}">
			{% include 'lindemannrock-base/_components/info-box' with {
				message: '<strong>Cache Location:</strong> <code>storage/runtime/search-manager/cache/</code>',
				type: 'info'
			} %}
		</div>

		<div id="cache-location-redis" class="{{ (settings.cacheStorageMethod ?? 'file') == 'file' ? 'hidden' }}">
			{% if craftUsesRedis %}
				{% include 'lindemannrock-base/_components/info-box' with {
					type: 'success',
					message: '<strong>Cache Location:</strong> Using Craft\'s configured Redis cache from <code>config/app.php</code>'
				} %}
			{% else %}
				{% include 'lindemannrock-base/_components/info-box' with {
					type: 'warning',
					message: '<strong>Redis Not Configured:</strong> To use Redis caching, install <code>yiisoft/yii2-redis</code> and configure it in <code>config/app.php</code>. <a href="https://craftcms.com/docs/5.x/reference/config/app.html#cache" target="_blank" rel="noopener">Learn more</a>'
				} %}
			{% endif %}
		</div>

		<hr>

		<h2>{{ "Search Results Caching"|t('search-manager') }}</h2>

		{{ forms.lightswitchField({
            label: 'Cache Search Results'|t('search-manager'),
            instructions: 'Cache search results to improve performance and reduce backend load'|t('search-manager'),
            id: 'enableCache',
            name: 'settings[enableCache]',
            on: settings.enableCache,
            disabled: settings.isOverriddenByConfig('enableCache'),
            warning: settings.isOverriddenByConfig('enableCache') ?
                "This is being overridden by the <code>enableCache</code> setting in <code>config/search-manager.php</code>."|t('search-manager')|raw : null,
          }) }}

		{{ forms.textField({
            label: 'Search Results Cache Duration'|t('search-manager'),
            instructions: ('Cache duration in seconds. Current: <strong id="cacheDuration-human"></strong>')|raw,
            id: 'cacheDuration',
            name: 'settings[cacheDuration]',
            value: settings.cacheDuration ?? 3600,
            type: 'number',
            min: '60',
            max: '86400',
            tip: 'Min: 60 (1 minute), Max: 86400 (1 day)'|t('search-manager'),
            disabled: settings.isOverriddenByConfig('cacheDuration'),
            warning: settings.isOverriddenByConfig('cacheDuration') ?
                "This is being overridden by the <code>cacheDuration</code> setting in <code>config/search-manager.php</code>."|t('search-manager')|raw : null,
            errors: settings.getErrors('cacheDuration')
        }) }}

		{{ forms.lightswitchField({
            label: 'Cache Popular Queries Only'|t('search-manager'),
            instructions: 'Only cache queries that have been searched multiple times'|t('search-manager'),
            id: 'cachePopularQueriesOnly',
            name: 'settings[cachePopularQueriesOnly]',
            on: settings.cachePopularQueriesOnly,
            tip: 'Saves cache space by only caching frequently-used queries'|t('search-manager'),
            disabled: settings.isOverriddenByConfig('cachePopularQueriesOnly'),
            warning: settings.isOverriddenByConfig('cachePopularQueriesOnly') ?
                "This is being overridden by config file."|t('search-manager')|raw : null,
        }) }}

		{{ forms.textField({
            label: 'Popular Query Threshold'|t('search-manager'),
            instructions: 'Number of times a query must be searched before it gets cached'|t('search-manager'),
            id: 'popularQueryThreshold',
            name: 'settings[popularQueryThreshold]',
            value: settings.popularQueryThreshold ?? 5,
            type: 'number',
            min: '2',
            max: '100',
            tip: 'Only applies when "Cache Popular Queries Only" is enabled'|t('search-manager'),
            disabled: settings.isOverriddenByConfig('popularQueryThreshold'),
            warning: settings.isOverriddenByConfig('popularQueryThreshold') ?
                "This is being overridden by config file."|t('search-manager')|raw : null,
            errors: settings.getErrors('popularQueryThreshold')
        }) }}

		<hr>

		<h2>{{ "Cache Invalidation"|t('search-manager') }}</h2>

		{{ forms.lightswitchField({
            label: 'Clear Cache on Element Save'|t('search-manager'),
            instructions: 'Automatically clear search cache when entries are saved or deleted. Disable for high-traffic sites to reduce cache thrashing.'|t('search-manager'),
            id: 'clearCacheOnSave',
            name: 'settings[clearCacheOnSave]',
            on: settings.clearCacheOnSave ?? true,
            tip: 'When disabled, cache expires naturally based on Cache Duration setting'|t('search-manager'),
            disabled: settings.isOverriddenByConfig('clearCacheOnSave'),
            warning: settings.isOverriddenByConfig('clearCacheOnSave') ?
                "This is being overridden by config file."|t('search-manager')|raw : null,
        }) }}

		{{ forms.selectField({
            label: 'Status Sync Interval'|t('search-manager'),
            instructions: 'How often to sync entries that become live or expire automatically.'|t('search-manager'),
            id: 'statusSyncInterval',
            name: 'settings[statusSyncInterval]',
            value: settings.statusSyncInterval ?? 15,
            options: [
                { value: 0, label: 'Disabled'|t('search-manager') },
                { value: 5, label: 'Every 5 minutes'|t('search-manager') },
                { value: 15, label: 'Every 15 minutes (recommended)'|t('search-manager') },
                { value: 30, label: 'Every 30 minutes'|t('search-manager') },
                { value: 60, label: 'Every hour'|t('search-manager') },
                { value: 360, label: 'Every 6 hours'|t('search-manager') },
                { value: 720, label: 'Every 12 hours'|t('search-manager') },
                { value: 1440, label: 'Daily'|t('search-manager') },
            ],
            tip: 'Handles entries with scheduled postDate or expiryDate that change status without a save event'|t('search-manager'),
            disabled: settings.isOverriddenByConfig('statusSyncInterval'),
            warning: settings.isOverriddenByConfig('statusSyncInterval') ?
                "This is being overridden by config file."|t('search-manager')|raw : null,
        }) }}

		{% set syncRunning = craft.app.plugins.getPlugin('search-manager').isStatusSyncRunning() %}
		{% if settings.statusSyncInterval > 0 %}
			{% if syncRunning %}
				{% include 'lindemannrock-base/_components/info-box' with {
					type: 'success',
					message: '<strong>Status Sync Active:</strong> A sync job is scheduled and will run every ' ~ settings.statusSyncInterval ~ ' minutes.'
				} %}
			{% else %}
				{% include 'lindemannrock-base/_components/info-box' with {
					type: 'warning',
					message: '<strong>Status Sync Not Running:</strong> Save settings to start the sync job, or it will auto-start on next page load.'
				} %}
			{% endif %}
		{% endif %}

        {% if settings.enableAnalytics ?? true %}
            <hr>

            <h2>{{ "Device Detection Caching"|t('search-manager') }}</h2>

            {{ forms.lightswitchField({
                label: "Cache Device Detection"|t('search-manager'),
                instructions: "Cache device detection results for better performance"|t('search-manager'),
                id: 'cacheDeviceDetection',
                name: 'settings[cacheDeviceDetection]',
                on: settings.cacheDeviceDetection ?? true,
                toggle: 'device-cache-settings',
                disabled: settings.isOverriddenByConfig('cacheDeviceDetection'),
                warning: settings.isOverriddenByConfig('cacheDeviceDetection') ?
                    "This is being overridden by the <code>cacheDeviceDetection</code> setting in <code>config/search-manager.php</code>."|t('search-manager')|raw : null,
            }) }}

            <div id="device-cache-settings" class="{{ not (settings.cacheDeviceDetection ?? true) ? 'hidden' }}">
                {{ forms.textField({
                    label: "Device Detection Cache Duration"|t('search-manager'),
                    instructions: ('Cache duration in seconds. Current: <strong id="deviceDetectionCacheDuration-human"></strong>')|raw,
                    id: 'deviceDetectionCacheDuration',
                    name: 'settings[deviceDetectionCacheDuration]',
                    value: settings.deviceDetectionCacheDuration ?? 3600,
                    type: 'number',
                    min: 60,
                    max: 604800,
                    tip: 'Min: 60 (1 minute), Max: 604800 (7 days)'|t('search-manager'),
                    disabled: settings.isOverriddenByConfig('deviceDetectionCacheDuration'),
                    warning: settings.isOverriddenByConfig('deviceDetectionCacheDuration') ?
                        "This is being overridden by the <code>deviceDetectionCacheDuration</code> setting in <code>config/search-manager.php</code>."|t('search-manager')|raw : null,
                }) }}

                {% include 'lindemannrock-base/_components/info-box' with {
                    message: '<strong>How it works:</strong><br>
• Device detection parses user-agent strings to identify devices, browsers, and operating systems<br>
• Results are cached to avoid re-parsing the same user-agent repeatedly<br>
• Recommended to keep enabled for production sites'
                } %}
            </div>
        {% else %}
            <hr>

            <h2>{{ "Device Detection Caching"|t('search-manager') }}</h2>

            <div class="field">
                <p class="light" style="color: #999;">
                    {{ "Device detection caching is only available when Analytics is enabled. Go to"|t('search-manager') }}
                    <a href="{{ url('search-manager/settings/analytics') }}">{{ "Analytics Settings"|t('search-manager') }}</a>
                    {{ "to enable analytics."|t('search-manager') }}
                </p>
            </div>
        {% endif %}

		<div class="buttons">
			<button type="submit" class="btn submit">{{ "Save Settings"|t('search-manager') }}</button>
		</div>
	</form>

	{% include 'lindemannrock-base/_components/plugin-credit' %}
{% endblock %}

{% js %}
// Toggle cache location info boxes based on storage method selection
$('#cacheStorageMethod').on('change', function() {
	const value = $(this).val();
	if (value === 'redis') {
		$('#cache-location-file').addClass('hidden');
		$('#cache-location-redis').removeClass('hidden');
	} else {
		$('#cache-location-redis').addClass('hidden');
		$('#cache-location-file').removeClass('hidden');
	}
});

// Convert seconds to human-readable duration
function secondsToHuman(seconds) {
	seconds = parseInt(seconds) || 0;
	if (seconds < 60) {
		return seconds + ' second' + (seconds !== 1 ? 's' : '');
	} else if (seconds < 3600) {
		const mins = Math.round(seconds / 60 * 10) / 10;
		return mins + ' minute' + (mins !== 1 ? 's' : '');
	} else if (seconds < 86400) {
		const hours = Math.round(seconds / 3600 * 10) / 10;
		return hours + ' hour' + (hours !== 1 ? 's' : '');
	} else {
		const days = Math.round(seconds / 86400 * 10) / 10;
		return days + ' day' + (days !== 1 ? 's' : '');
	}
}

// Update human-readable duration on input change
$('#cacheDuration').on('input', function() {
	$('#cacheDuration-human').text(secondsToHuman($(this).val()));
});

$('#deviceDetectionCacheDuration').on('input', function() {
	$('#deviceDetectionCacheDuration-human').text(secondsToHuman($(this).val()));
});

// Initialize on page load
$('#cacheDuration-human').text(secondsToHuman($('#cacheDuration').val()));
$('#deviceDetectionCacheDuration-human').text(secondsToHuman($('#deviceDetectionCacheDuration').val()));
{% endjs %}

